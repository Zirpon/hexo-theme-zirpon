<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <!-- link rel="shortcut icon" href="/img/ironman-draw.png" -->
    <link rel="shortcut icon" href="/img/timg.jpeg">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS --> 
    <!-- %- css('css/beantech.min.css')% -->
    
    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="/css/highlight.css">


    
<link rel="stylesheet" href="/css/widget.css">


    
<link rel="stylesheet" href="/css/rocket.css">


    
<link rel="stylesheet" href="/css/signature.css">


    
<link rel="stylesheet" href="/css/toc.css">


    
<link rel="stylesheet" href="/css/beantech.css">




    <!--æ–°ä¸œè¥¿ -->
    
    <!-- wave start -->
    <link rel="stylesheet" href="/css/wave.css" />
    <!-- wave end -->
    

    
    <!-- top start (article top hot config) -->
    <link rel="stylesheet" href="/css/top.css" />
    <!-- top end -->
    

    <a id="rocket" href="#top" class=""></a>

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css" />
      <!-- Search end -->
    

    
    <!-- ThemeColor start -->
    <link rel="stylesheet" href="/css/themecolor.css" />
    <!-- ThemeColor end -->
    
 
    <!--æ–°ä¸œè¥¿ -->

    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          Lua 5.0 reading note - Zirpon | Blog
        
    </title>

    <link rel="canonical" href="/2019/04/06/lua-5-0-note/">



    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="" class="body--home">

    <!-- ThemeColor -->
	
    <!-- ThemeColor -->
<!-- <div class="toggle" onclick="document.body.classList.toggle('body--dark')">Switch Color</div> -->

<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <strong class="mdui-icon material-icons bright-mode">ğŸ¤¡</strong>
  <strong class="mdui-icon material-icons dark-mode">ğŸ¤¡</strong>
</div>

    

	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('https://zirpon.github.io/img/header_img/roman.png')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#lua 5.0" title="lua 5.0">lua 5.0</a>
                            
                        </div>
                        <h1>Lua 5.0 reading note</h1>
                        <h2 class="subheading">The quick brown fox jumps over the lazy dog</h2>

                        <span class="meta">
                            Posted by Zirpon Cheung on
                            2019-04-06
                        </span>

                        
                            <!-- WordCount start -->
                            <div class="blank_box"></div>
                            <span class="meta">
                              Estimated Reading Time <span class="post-count">69</span> Minutes
                            </span>
                            <div class="blank_box"></div>
                            <span class="meta">
                              Words <span class="post-count">15.3k</span> In Total
                            </span>
                            <div class="blank_box"></div>
                            <!-- ä¸è’œå­ç»Ÿè®¡ start -->
                            <span class="meta">
                              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
                            </span>
                            <!-- ä¸è’œå­ç»Ÿè®¡ end -->
                            <!-- WordCount end -->
                        

                    </div>
                


                </div>
            </div>
        </div>
    </div>

    
        <!-- waveoverlay start -->
        <div class="preview-overlay">
          <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
            <defs>
              <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
            </defs>
            <g class="preview-parallax">
              <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
              <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
              <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
              <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
            </g>
          </svg>
        </div>
        <!-- waveoverlay end -->
    
</header>

    
    <!-- Navigation (contains search)-->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Cheung Zirpon</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
          
          <li><a class="popup-trigger" title="Search"><span class="search-icon"></span>Search</a></li>
          
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>


<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 article-container">

                <h2 id="1-Begin"><a class="header-anchor" href="#1-Begin">Â¶</a>1. Begin</h2>
<h3 id="1-1-chunk"><a class="header-anchor" href="#1-1-chunk">Â¶</a>1.1 chunk</h3>
<p>Chunk æ˜¯ä¸€ç³»åˆ—è¯­å¥ï¼ŒLua æ‰§è¡Œçš„æ¯ä¸€<strong>å—</strong>è¯­å¥ï¼Œæ¯”å¦‚<strong>ä¸€ä¸ªæ–‡ä»¶</strong>æˆ–è€…<strong>äº¤äº’æ¨¡å¼</strong>ä¸‹çš„<em>æ¯ä¸€è¡Œ</em>éƒ½æ˜¯ä¸€ä¸ª Chunkã€‚<br>
æ¯ä¸ªè¯­å¥ç»“å°¾çš„åˆ†å·ï¼ˆ;ï¼‰æ˜¯å¯é€‰çš„ï¼Œä½†å¦‚æœåŒä¸€è¡Œæœ‰å¤šä¸ªè¯­å¥æœ€å¥½ç”¨ï¼›åˆ†å¼€(but valid)<br>
Chunkå¯ä»¥å¾ˆå¤§ï¼Œåœ¨ Lua ä¸­å‡ ä¸ª MByte çš„ Chunk æ˜¯å¾ˆå¸¸è§çš„</p>
<p>äº¤äº’æ¨¡å¼ä¸‹ é”®å…¥æ–‡ä»¶ç»“æŸç¬¦å¯ä»¥é€€å‡ºäº¤äº’æ¨¡å¼ï¼ˆCtrl-D in Unix, Ctrl-Z in DOS/Windowsï¼‰ï¼Œæˆ–è€…è°ƒç”¨ OS åº“çš„ os.exit()å‡½æ•°ä¹Ÿå¯ä»¥é€€å‡º</p>
<blockquote>
<p>prompt&gt; lua -la -lb</p>
</blockquote>
<p>å‘½ä»¤é¦–å…ˆåœ¨ä¸€ä¸ª Chunk å†…å…ˆè¿è¡Œ a ç„¶åè¿è¡Œ bã€‚ï¼ˆæ³¨æ„ï¼š-l é€‰é¡¹ä¼šè°ƒç”¨ requireï¼Œå°†ä¼šåœ¨æŒ‡å®šçš„ç›®å½•ä¸‹æœç´¢æ–‡ä»¶ï¼Œå¦‚æœç¯å¢ƒå˜é‡æ²¡æœ‰è®¾å¥½ï¼Œä¸Šé¢çš„å‘½ä»¤å¯èƒ½ä¸èƒ½æ­£ç¡®è¿è¡Œã€‚)</p>
<blockquote>
<p>lua -i -la -lb</p>
</blockquote>
<p>å°†åœ¨ä¸€ä¸ª Chunk å†…å…ˆè¿è¡Œ a ç„¶åè¿è¡Œ bï¼Œæœ€åç›´æ¥è¿›å…¥äº¤äº’æ¨¡å¼</p>
<p>æœ€å¥½ä¸è¦ä½¿ç”¨ä¸‹åˆ’çº¿åŠ å¤§å†™å­—æ¯çš„æ ‡ç¤ºç¬¦ï¼Œå› ä¸º Lua çš„ä¿ç•™å­—ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚</p>
<h3 id="1-4-lua-command-line"><a class="header-anchor" href="#1-4-lua-command-line">Â¶</a>1.4 lua command line</h3>
<ul>
<li>
<p>-eï¼šç›´æ¥å°†å‘½ä»¤ä¼ å…¥ Lua</p>
<blockquote>
<p>prompt&gt; lua -e â€œprint(math.sin(12))â€ --&gt; -0.53657291800043</p>
</blockquote>
</li>
<li>
<p>-lï¼šåŠ è½½ä¸€ä¸ªæ–‡ä»¶.</p>
</li>
<li>
<p>-iï¼šè¿›å…¥äº¤äº’æ¨¡å¼.<br>
_PROMPT å†…ç½®å˜é‡ä½œä¸ºäº¤äº’æ¨¡å¼çš„æç¤ºç¬¦</p>
<blockquote>
<p>prompt&gt; lua -i -e â€œ_PROMPT=â€™ lua&gt; 'â€<br>
lua&gt;</p>
</blockquote>
</li>
</ul>
<p>Lua çš„è¿è¡Œè¿‡ç¨‹ï¼Œåœ¨è¿è¡Œå‚æ•°ä¹‹å‰ï¼ŒLua ä¼šæŸ¥æ‰¾ç¯å¢ƒå˜é‡ <code>LUA_INIT</code> çš„å€¼ï¼Œ</p>
<ul>
<li>å¦‚æœå˜é‡å­˜åœ¨å¹¶ä¸”<code>å€¼</code>ä¸º<code>@filename</code>ï¼ŒLua å°†<strong>åŠ è½½</strong>æŒ‡å®šæ–‡ä»¶ã€‚</li>
<li>å¦‚æœå˜é‡å­˜åœ¨ä½†<code>ä¸æ˜¯ä»¥@å¼€å¤´</code>ï¼ŒLuaå‡å®š filename ä¸º Lua ä»£ç æ–‡ä»¶å¹¶ä¸”<strong>è¿è¡Œ</strong>ä»–ã€‚</li>
</ul>
<p>å…¨å±€å˜é‡ <code>arg</code> å­˜æ”¾ Lua çš„å‘½ä»¤è¡Œå‚æ•°ã€‚åœ¨è¿è¡Œä»¥å‰ï¼ŒLua ä½¿ç”¨æ‰€æœ‰å‚æ•°æ„é€  arg è¡¨ã€‚</p>
<ul>
<li>è„šæœ¬åç´¢å¼•ä¸º 0ï¼Œ</li>
<li>è„šæœ¬çš„å‚æ•°ä» 1 å¼€å§‹å¢åŠ ã€‚</li>
<li>è„šæœ¬å‰é¢çš„å‚æ•°ä»-1 å¼€å§‹å‡å°‘</li>
</ul>
<blockquote>
<p>prompt&gt; lua -e â€œsin=math.sinâ€ script a b<br>
arg è¡¨å¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">arg</span>[<span class="number">-3</span>] = <span class="string">"lua"</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">-2</span>] = <span class="string">"-e"</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">-1</span>] = <span class="string">"sin=math.sin"</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">0</span>] = <span class="string">"script"</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">1</span>] = <span class="string">"a"</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">2</span>] = <span class="string">"b"</span></span><br></pre></td></tr></table></figure>
<h2 id="2-lua-basic-type"><a class="header-anchor" href="#2-lua-basic-type">Â¶</a>2. lua basic type</h2>
<p>Lua æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œå˜é‡ä¸è¦ç±»å‹å®šä¹‰ã€‚<br>
Lua ä¸­æœ‰8 ä¸ªåŸºæœ¬ç±»å‹åˆ†åˆ«ä¸ºï¼š<code>nilã€booleanã€numberã€stringã€userdataã€functionã€thread å’Œ table</code>ã€‚<br>
å‡½æ•° <code>type</code> å¯ä»¥æµ‹è¯•ç»™å®šå˜é‡æˆ–è€…å€¼çš„ç±»å‹ã€‚</p>
<p>åœ¨æ§åˆ¶ç»“æ„çš„æ¡ä»¶ä¸­é™¤äº† <code>false</code> å’Œ <code>nil</code> ä¸ºå‡ï¼Œå…¶ä»–å€¼éƒ½ä¸ºçœŸã€‚<br>
æ‰€ä»¥ Lua è®¤ä¸º <code>0</code> å’Œ<code>ç©ºä¸²</code>éƒ½æ˜¯çœŸã€‚</p>
<p><code>number</code>è¡¨ç¤ºå®æ•°ï¼ŒLua ä¸­æ²¡æœ‰æ•´æ•°ã€‚</p>
<p>note: <em><strong>ä¸€èˆ¬æœ‰ä¸ªé”™è¯¯çš„çœ‹æ³• CPU è¿ç®—æµ®ç‚¹æ•°æ¯”æ•´æ•°æ…¢ã€‚äº‹å®ä¸æ˜¯å¦‚æ­¤ï¼Œç”¨å®æ•°ä»£æ›¿æ•´æ•°ä¸ä¼šæœ‰ä»€ä¹ˆè¯¯å·®ï¼ˆé™¤éæ•°å­—å¤§äº 100,000,000,000,000ï¼‰ã€‚</strong></em><br>
Luaçš„ numbers å¯ä»¥å¤„ç†ä»»ä½•é•¿æ•´æ•°ä¸ç”¨æ‹…å¿ƒè¯¯å·®ã€‚</p>
<p>note: ä½ ä¹Ÿå¯ä»¥åœ¨ç¼–è¯‘ <code>Lua</code> çš„æ—¶å€™ä½¿ç”¨é•¿æ•´å‹æˆ–è€…<code>å•ç²¾åº¦æµ®ç‚¹å‹</code>ä»£æ›¿ numbersï¼Œåœ¨ä¸€äº›å¹³å°ç¡¬ä»¶<code>ä¸æ”¯æŒæµ®ç‚¹æ•°</code>çš„æƒ…å†µä¸‹è¿™ä¸ªç‰¹æ€§æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå…·ä½“çš„æƒ…å†µè¯·å‚è€ƒ Lua å‘å¸ƒç‰ˆæ‰€é™„çš„è¯¦ç»†è¯´æ˜ã€‚</p>
<h3 id="2-4-string"><a class="header-anchor" href="#2-4-string">Â¶</a>2.4 string</h3>
<p>å­—ç¬¦çš„åºåˆ—, lua æ˜¯ 8 ä½å­—èŠ‚ï¼Œæ‰€ä»¥å­—ç¬¦ä¸²å¯ä»¥åŒ…å«ä»»ä½•æ•°å€¼å­—ç¬¦ï¼ŒåŒ…æ‹¬åµŒå…¥çš„ 0ã€‚<br>
è¿™æ„å‘³ç€ä½ å¯ä»¥å­˜å‚¨ä»»æ„çš„äºŒè¿›åˆ¶æ•°æ®åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²é‡Œã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">"one string"</span></span><br><span class="line">b = <span class="built_in">string</span>.<span class="built_in">gsub</span>(a, <span class="string">"one"</span>, <span class="string">"another"</span>) <span class="comment">-- change string parts</span></span><br><span class="line"><span class="built_in">print</span>(a) <span class="comment">--&gt; one string</span></span><br><span class="line"><span class="built_in">print</span>(b) <span class="comment">--&gt; another string</span></span><br></pre></td></tr></table></figure>
<p>Lua å¯ä»¥é«˜æ•ˆçš„å¤„ç†é•¿å­—ç¬¦ä¸²ï¼Œ<code>1M</code> çš„ string åœ¨ Lua ä¸­æ˜¯å¾ˆå¸¸è§çš„ã€‚å¯ä»¥ä½¿ç”¨<code>å•å¼•å·</code>æˆ–è€…<code>åŒå¼•å·</code>è¡¨ç¤ºå­—ç¬¦ä¸²</p>
<p>è¿˜å¯ä»¥åœ¨å­—ç¬¦ä¸²ä¸­ä½¿ç”¨\dddï¼ˆddd ä¸ºä¸‰ä½åè¿›åˆ¶æ•°å­—ï¼‰æ–¹å¼è¡¨ç¤ºå­—æ¯ã€‚</p>
<blockquote>
<p>â€œalo\n123&quot;â€<br>
â€˜\97lo\10\04923&quot;â€™<br>
æ˜¯ç›¸åŒçš„</p>
</blockquote>
<p>è¿˜å¯ä»¥ä½¿ç”¨<code>[[...]]</code>è¡¨ç¤ºå­—ç¬¦ä¸²ã€‚<br>
è¿™ç§å½¢å¼çš„å­—ç¬¦ä¸²å¯ä»¥åŒ…å«<code>å¤šè¡Œ</code>ä¹Ÿï¼Œå¯ä»¥åµŒå¥—ä¸”<code>ä¸ä¼šè§£é‡Šè½¬ä¹‰åºåˆ—</code>ï¼Œå¦‚æœ<code>ç¬¬ä¸€ä¸ªå­—ç¬¦</code>æ˜¯<code>æ¢è¡Œç¬¦</code>ä¼šè¢«è‡ªåŠ¨<strong>å¿½ç•¥</strong>æ‰ã€‚</p>
<p>ç§å½¢å¼çš„å­—ç¬¦ä¸²ç”¨æ¥åŒ…å«ä¸€æ®µä»£ç æ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">page = <span class="string">[[</span></span><br><span class="line"><span class="string">&lt;HTML&gt;</span></span><br><span class="line"><span class="string">&lt;HEAD&gt;</span></span><br><span class="line"><span class="string">&lt;TITLE&gt;An HTML Page&lt;/TITLE&gt;</span></span><br><span class="line"><span class="string">&lt;/HEAD&gt;</span></span><br><span class="line"><span class="string">&lt;BODY&gt;</span></span><br><span class="line"><span class="string">Lua</span></span><br><span class="line"><span class="string">[[a text between double brackets]]</span></span><br><span class="line"><span class="string">&lt;/BODY&gt;</span></span><br><span class="line"><span class="string">&lt;/HTML&gt;</span></span><br><span class="line"><span class="string">]]</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">write</span>(page)</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œæ—¶ï¼ŒLua ä¼šè‡ªåŠ¨åœ¨ string å’Œ numbers ä¹‹é—´è‡ªåŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼Œå½“ä¸€ä¸ªå­—ç¬¦ä¸²ä½¿<br>
ç”¨ç®—æœ¯æ“ä½œç¬¦æ—¶ï¼Œstring å°±ä¼šè¢«è½¬æˆæ•°å­—ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">"10"</span> + <span class="number">1</span>) <span class="comment">--&gt; 11</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"10 + 1"</span>) <span class="comment">--&gt; 10 + 1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"-5.3e - 10"</span> * <span class="string">"2"</span>) <span class="comment">--&gt; -1.06e-09</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"hello"</span> + <span class="number">1</span>) <span class="comment">-- ERROR (cannot convert "hello")</span></span><br></pre></td></tr></table></figure>
<p><code>..</code>åœ¨ Lua ä¸­æ˜¯å­—ç¬¦ä¸²è¿æ¥ç¬¦ï¼Œå½“åœ¨ä¸€ä¸ª<code>æ•°å­—</code>åé¢å†™<code>..</code>æ—¶ï¼Œå¿…é¡»<code>åŠ ä¸Šç©ºæ ¼</code>ä»¥é˜²æ­¢è¢«è§£é‡Šé”™</p>
<p>æ˜¾å¼å°† string è½¬æˆæ•°å­—å¯ä»¥ä½¿ç”¨å‡½æ•° <code>tonumber()</code>ï¼Œå¦‚æœ string ä¸æ˜¯æ­£ç¡®çš„æ•°å­—è¯¥å‡½æ•°å°†è¿”å› <code>nil</code>ã€‚</p>
<p>å¯ä»¥è°ƒç”¨<code>tostring()</code>å°†æ•°å­—è½¬æˆå­—ç¬¦ä¸²ï¼Œè¿™ç§è½¬æ¢ä¸€ç›´æœ‰æ•ˆ</p>
<h3 id="2-5-Function"><a class="header-anchor" href="#2-5-Function">Â¶</a>2.5 Function</h3>
<p>å‡½æ•°æ˜¯<code>ç¬¬ä¸€ç±»å€¼</code>ï¼ˆå’Œå…¶ä»–å˜é‡ç›¸åŒï¼‰ï¼Œæ„å‘³ç€</p>
<ul>
<li>å‡½æ•°å¯ä»¥å­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œ</li>
<li>å¯ä»¥ä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼Œ</li>
<li>ä¹Ÿå¯ä»¥ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ã€‚</li>
</ul>
<h3 id="2-6-Userdata-and-Threads"><a class="header-anchor" href="#2-6-Userdata-and-Threads">Â¶</a>2.6 Userdata and Threads</h3>
<ul>
<li>userdata å¯ä»¥å°† C æ•°æ®å­˜æ”¾åœ¨ Lua å˜é‡ä¸­ï¼Œ</li>
<li>userdata åœ¨ Lua ä¸­é¢„å®šä¹‰æ“ä½œ<code>èµ‹å€¼</code>å’Œ<code>ç›¸ç­‰æ¯”è¾ƒ</code></li>
</ul>
<h2 id="3-expression-è¡¨è¾¾å¼"><a class="header-anchor" href="#3-expression-è¡¨è¾¾å¼">Â¶</a>3. expression è¡¨è¾¾å¼</h2>
<h3 id="3-2-Relational-operators"><a class="header-anchor" href="#3-2-Relational-operators">Â¶</a>3.2 Relational operators</h3>
<p>å…³ç³»è¿ç®—ç¬¦</p>
<blockquote>
<p>&lt; &gt; &lt;= &gt;= == ~=</p>
</blockquote>
<ul>
<li>Lua é€šè¿‡<code>å¼•ç”¨</code>æ¯”è¾ƒ<code>tablesã€userdataã€functions</code>ã€‚ä¹Ÿå°±æ˜¯è¯´å½“ä¸”ä»…å½“ä¸¤è€…è¡¨ç¤ºåŒä¸€ä¸ªå¯¹è±¡æ—¶ç›¸ç­‰ã€‚</li>
<li>Lua æ¯”è¾ƒæ•°å­—æŒ‰ä¼ ç»Ÿçš„æ•°å­—å¤§å°è¿›è¡Œï¼Œ</li>
<li>æ¯”è¾ƒå­—ç¬¦ä¸²æŒ‰å­—æ¯çš„é¡ºåºè¿›è¡Œï¼Œä½†æ˜¯å­—æ¯é¡ºåºä¾èµ–äºæœ¬åœ°ç¯å¢ƒ</li>
</ul>
<h3 id="3-3-logical-operator-é€»è¾‘è¿ç®—ç¬¦"><a class="header-anchor" href="#3-3-logical-operator-é€»è¾‘è¿ç®—ç¬¦">Â¶</a>3.3 logical operator é€»è¾‘è¿ç®—ç¬¦</h3>
<blockquote>
<p>and or not</p>
</blockquote>
<p>ä¸€ä¸ªå¾ˆå®ç”¨çš„æŠ€å·§ï¼šå¦‚æœ x ä¸º false æˆ–è€… nil åˆ™ç»™ x èµ‹åˆå§‹å€¼ v</p>
<blockquote>
<p>x = x or v</p>
</blockquote>
<p>C è¯­è¨€ä¸­çš„ä¸‰å…ƒè¿ç®—ç¬¦</p>
<blockquote>
<p>(a and b) or c ==&gt; a ? b : c</p>
</blockquote>
<h3 id="3-5-operator-priority-ä¼˜å…ˆçº§"><a class="header-anchor" href="#3-5-operator-priority-ä¼˜å…ˆçº§">Â¶</a>3.5 operator priority ä¼˜å…ˆçº§</h3>
<p>ä»é«˜åˆ°ä½çš„é¡ºåºï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">^</span><br><span class="line"><span class="keyword">not</span> - (unary)</span><br><span class="line">* /</span><br><span class="line">+ -</span><br><span class="line">..</span><br><span class="line">&lt; &gt; &lt;= &gt;= ~= ==</span><br><span class="line"><span class="keyword">and</span></span><br><span class="line"><span class="keyword">or</span></span><br></pre></td></tr></table></figure>
<p>é™¤äº†^å’Œâ€¦å¤–æ‰€æœ‰çš„äºŒå…ƒè¿ç®—ç¬¦éƒ½æ˜¯<code>å·¦è¿æ¥</code>çš„ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a+i &lt; b/<span class="number">2</span>+<span class="number">1</span> &lt;<span class="comment">--&gt; (a+i) &lt; ((b/2)+1)</span></span><br><span class="line"><span class="number">5</span>+x^<span class="number">2</span>*<span class="number">8</span> &lt;<span class="comment">--&gt; 5+((x^2)*8)</span></span><br><span class="line">a &lt; y <span class="keyword">and</span> y &lt;= z &lt;<span class="comment">--&gt; (a &lt; y) and (y &lt;= z)</span></span><br><span class="line">-x^<span class="number">2</span> &lt;<span class="comment">--&gt; -(x^2)</span></span><br><span class="line">x^y^z &lt;<span class="comment">--&gt; x^(y^z)</span></span><br></pre></td></tr></table></figure>
<h3 id="3-6-table-constructor-è¡¨çš„æ„é€ "><a class="header-anchor" href="#3-6-table-constructor-è¡¨çš„æ„é€ ">Â¶</a>3.6 table constructor è¡¨çš„æ„é€ </h3>
<p>æœ€ç®€å•çš„æ„é€ å‡½æ•°æ˜¯<code>{}</code>ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ª<code>ç©ºè¡¨</code>ã€‚</p>
<p>ä½¿ç”¨ table æ„é€ ä¸€ä¸ª listï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">list = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>() <span class="keyword">do</span></span><br><span class="line"> list = &#123;<span class="built_in">next</span>=list, value=line&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>åµŒå¥—æ„é€ å‡½æ•°</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">polyline = &#123;color=<span class="string">"blue"</span>, thickness=<span class="number">2</span>, npoints=<span class="number">4</span>,</span><br><span class="line"> &#123;x=<span class="number">0</span>, y=<span class="number">0</span>&#125;,</span><br><span class="line"> &#123;x=<span class="number">-10</span>, y=<span class="number">0</span>&#125;,</span><br><span class="line"> &#123;x=<span class="number">-10</span>, y=<span class="number">1</span>&#125;,</span><br><span class="line"> &#123;x=<span class="number">0</span>, y=<span class="number">1</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¸èƒ½ä½¿ç”¨è´Ÿç´¢å¼•åˆå§‹åŒ–ä¸€ä¸ªè¡¨ä¸­å…ƒç´ ï¼Œ</li>
<li>å­—ç¬¦ä¸²ç´¢å¼•ä¹Ÿä¸èƒ½è¢«æ°å½“çš„è¡¨ç¤ºã€‚</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">opnames = &#123;</span><br><span class="line">    [<span class="string">"+"</span>] = <span class="string">"add"</span>,</span><br><span class="line">    [<span class="string">"-"</span>] = <span class="string">"sub"</span>,</span><br><span class="line">    [<span class="string">"*"</span>] = <span class="string">"mul"</span>,</span><br><span class="line">    [<span class="string">"/"</span>] = <span class="string">"div"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">i = <span class="number">20</span>; s = <span class="string">"-"</span></span><br><span class="line">a = &#123;[i+<span class="number">0</span>] = s, [i+<span class="number">1</span>] = s..s, [i+<span class="number">2</span>] = s..s..s,&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(opnames[s]) <span class="comment">--&gt; sub</span></span><br><span class="line"><span class="built_in">print</span>(a[<span class="number">22</span>]) <span class="comment">--&gt; ---</span></span><br></pre></td></tr></table></figure>
<ul>
<li>æ³¨æ„ï¼šä¸æ¨èæ•°ç»„ä¸‹æ ‡<code>ä» 0 å¼€å§‹</code>ï¼Œå¦åˆ™<code>å¾ˆå¤šæ ‡å‡†åº“ä¸èƒ½ä½¿ç”¨</code>ã€‚</li>
<li>åœ¨æ„é€ å‡½æ•°çš„<code>æœ€åçš„</code>&quot;,&quot;æ˜¯å¯é€‰çš„ï¼Œå¯ä»¥æ–¹ä¾¿ä»¥åçš„æ‰©å±•ã€‚</li>
<li>åœ¨æ„é€ å‡½æ•°ä¸­åŸŸåˆ†éš”ç¬¦é€—å·ï¼ˆâ€œ,â€ï¼‰å¯ä»¥ç”¨åˆ†å·ï¼ˆâ€œ;â€ï¼‰æ›¿ä»£ï¼Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨åˆ†å·ç”¨æ¥åˆ†å‰²ä¸åŒç±»å‹çš„è¡¨å…ƒç´ ã€‚</li>
</ul>
<p>å¦‚æœçœŸçš„æƒ³è¦æ•°ç»„ä¸‹æ ‡ä» 0 å¼€å§‹ï¼š</p>
<blockquote>
<p>days = {[0]=â€œSundayâ€, â€œMondayâ€, â€œTuesdayâ€, â€œWednesdayâ€, â€œThursdayâ€, â€œFridayâ€, â€œSaturdayâ€}<br>
{x=10, y=45; â€œoneâ€, â€œtwoâ€, â€œthreeâ€}</p>
</blockquote>
<h3 id="4-basic-syntax-åŸºæœ¬è¯­æ³•"><a class="header-anchor" href="#4-basic-syntax-åŸºæœ¬è¯­æ³•">Â¶</a>4. basic syntax åŸºæœ¬è¯­æ³•</h3>
<blockquote>
<p>a, b = 10, 2<em>x &lt;â€“&gt; a=10; b=2</em>x</p>
</blockquote>
<p>é‡åˆ°èµ‹å€¼è¯­å¥ Lua ä¼šå…ˆè®¡ç®—å³è¾¹æ‰€æœ‰çš„å€¼ç„¶åå†æ‰§è¡Œèµ‹å€¼æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·<br>
è¿›è¡Œäº¤æ¢å˜é‡çš„å€¼ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x, y = y, x <span class="comment">-- swap 'x' for 'y'</span></span><br><span class="line">a[i], a[j] = a[j], a[i] <span class="comment">-- swap 'a[i]' for 'a[i]'</span></span><br></pre></td></tr></table></figure>
<p>å½“å˜é‡ä¸ªæ•°å’Œå€¼çš„ä¸ªæ•°ä¸ä¸€è‡´æ—¶ï¼ŒLua ä¼šä¸€ç›´ä»¥å˜é‡ä¸ªæ•°ä¸ºåŸºç¡€é‡‡å–ä»¥ä¸‹ç­–ç•¥ï¼š</p>
<ul>
<li>a. å˜é‡ä¸ªæ•°&gt;å€¼çš„ä¸ªæ•° æŒ‰å˜é‡ä¸ªæ•°è¡¥è¶³ nil</li>
<li>b. å˜é‡ä¸ªæ•°&lt;å€¼çš„ä¸ªæ•° å¤šä½™çš„å€¼ä¼šè¢«å¿½ç•¥</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a, b, c = <span class="number">0</span>, <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(a,b,c) <span class="comment">--&gt; 0 1 nil</span></span><br><span class="line">a, b = a+<span class="number">1</span>, b+<span class="number">1</span>, b+<span class="number">2</span> <span class="comment">-- value of b+2 is ignored</span></span><br><span class="line"><span class="built_in">print</span>(a,b) <span class="comment">--&gt; 1 2</span></span><br><span class="line">a, b, c = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(a,b,c) <span class="comment">--&gt; 0 nil nil</span></span><br></pre></td></tr></table></figure>
<h3 id="4-2-local-variable-code-block-å±€éƒ¨å˜é‡-ä»£ç å—"><a class="header-anchor" href="#4-2-local-variable-code-block-å±€éƒ¨å˜é‡-ä»£ç å—">Â¶</a>4.2  local variable &amp; code block å±€éƒ¨å˜é‡ ä»£ç å—</h3>
<p>ä½¿ç”¨ <code>local</code> åˆ›å»ºä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œä¸å…¨å±€å˜é‡ä¸åŒï¼Œå±€éƒ¨å˜é‡åªåœ¨è¢«å£°æ˜çš„é‚£ä¸ªä»£ç å—å†…æœ‰æ•ˆã€‚ä»£ç å—ï¼šæŒ‡ä¸€ä¸ª<code>æ§åˆ¶ç»“æ„</code>å†…ï¼Œä¸€ä¸ª<code>å‡½æ•°ä½“</code>ï¼Œæˆ–è€…ä¸€ä¸ª <code>chunk</code>ï¼ˆå˜é‡è¢«å£°æ˜çš„é‚£ä¸ªæ–‡ä»¶æˆ–è€…æ–‡æœ¬ä¸²ï¼‰</p>
<p>åº”è¯¥å°½å¯èƒ½çš„ä½¿ç”¨å±€éƒ¨å˜é‡ï¼Œæœ‰ä¸¤ä¸ªå¥½å¤„ï¼š</p>
<ol>
<li>é¿å…å‘½åå†²çª</li>
<li>è®¿é—®å±€éƒ¨å˜é‡çš„é€Ÿåº¦æ¯”å…¨å±€å˜é‡æ›´å¿«.</li>
</ol>
<blockquote>
<p>do â€¦ end</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> conditions <span class="keyword">then</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">elseif</span> conditions <span class="keyword">then</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> condition <span class="keyword">do</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">repeat</span></span><br><span class="line">    statements;</span><br><span class="line"><span class="keyword">until</span> conditions;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ•°å€¼ for å¾ªç¯:</span></span><br><span class="line"><span class="keyword">for</span> var=exp1,exp2,exp3 <span class="keyword">do</span></span><br><span class="line">    loop-part</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- èŒƒå‹ for å¾ªç¯ï¼š</span></span><br><span class="line"><span class="comment">-- print all values of array 'a'</span></span><br><span class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span> <span class="built_in">print</span>(v) <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span> <span class="built_in">print</span>(k) <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="4-3-break-return"><a class="header-anchor" href="#4-3-break-return">Â¶</a>4.3 break return</h3>
<p>æœ‰æ—¶å€™ä¸ºäº†è°ƒè¯•æˆ–è€…å…¶ä»–ç›®çš„éœ€è¦åœ¨ block çš„ä¸­é—´ä½¿ç”¨ return æˆ–è€… breakï¼Œå¯ä»¥æ˜¾å¼çš„ä½¿ç”¨ doâ€¦end æ¥å®ç°ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="comment">--&lt;&lt; SYNTAX ERROR</span></span><br><span class="line">    <span class="comment">-- 'return' is the last statement in the next block</span></span><br><span class="line">    <span class="keyword">do</span> <span class="keyword">return</span> <span class="keyword">end</span> <span class="comment">-- OK</span></span><br><span class="line">    ... <span class="comment">-- statements not reached</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="5-function"><a class="header-anchor" href="#5-function">Â¶</a>5. function</h2>
<p>è°ƒç”¨å‡½æ•°çš„æ—¶å€™ï¼Œå¦‚æœå‚æ•°åˆ—è¡¨ä¸ºç©ºï¼Œå¿…é¡»ä½¿ç”¨()è¡¨æ˜æ˜¯å‡½æ•°è°ƒç”¨ã€‚</p>
<p>å½“å‡½æ•°<code>åªæœ‰ä¸€ä¸ªå‚æ•°</code>å¹¶ä¸”è¿™ä¸ªå‚æ•°æ˜¯<code>å­—ç¬¦ä¸²</code>æˆ–è€…<code>è¡¨æ„é€ </code>çš„æ—¶å€™ï¼Œ()æ˜¯å¯é€‰çš„ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span> <span class="string">"Hello World"</span>     <span class="comment">--&gt; print("Hello World")</span></span><br><span class="line"><span class="built_in">dofile</span> <span class="string">'a.lua'</span>          <span class="comment">--&gt; dofile ('a.lua')</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">[[a multi-line</span></span><br><span class="line"><span class="string">    message]]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">[[a multi-line</span></span><br><span class="line"><span class="string">    message]]</span>)</span><br><span class="line"></span><br><span class="line">f&#123;x=<span class="number">10</span>, y=<span class="number">20</span>&#125;   <span class="comment">--&gt; f(&#123;x=10, y=20&#125;)</span></span><br><span class="line"><span class="built_in">type</span>&#123;&#125;          <span class="comment">--&gt; type(&#123;&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- é¢å‘å¯¹è±¡æ–¹å¼è°ƒç”¨å‡½æ•°çš„è¯­æ³•</span></span><br><span class="line">o:foo(x) <span class="comment">-- &gt; o.foo(o, x)</span></span><br></pre></td></tr></table></figure>
<p>string.findï¼Œå…¶è¿”å›åŒ¹é…ä¸²<code>â€œå¼€å§‹å’Œç»“æŸçš„ä¸‹æ ‡â€</code>ï¼ˆå¦‚æœä¸å­˜åœ¨åŒ¹é…ä¸²è¿”å› <code>nil</code>ï¼‰ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s, e = <span class="built_in">string</span>.<span class="built_in">find</span>(<span class="string">"hello Lua users"</span>, <span class="string">"Lua"</span>)</span><br><span class="line"><span class="built_in">print</span>(s, e) <span class="comment">--&gt; 7 9</span></span><br></pre></td></tr></table></figure>
<h3 id="5-1-multi-result-return"><a class="header-anchor" href="#5-1-multi-result-return">Â¶</a>5.1 multi result return</h3>
<p>è¿”å›å¤šä¸ªç»“æœå€¼</p>
<ul>
<li>
<p>ä½œä¸ºè¡¨è¾¾å¼è°ƒç”¨å‡½æ•°</p>
<ol>
<li>å½“è°ƒç”¨<code>ä½œä¸ºè¡¨è¾¾å¼æœ€åä¸€ä¸ªå‚æ•°</code>æˆ–è€…<code>ä»…æœ‰ä¸€ä¸ªå‚æ•°</code>æ—¶ï¼Œæ ¹æ®å˜é‡ä¸ªæ•°å‡½æ•°å°½å¯èƒ½å¤šåœ°è¿”å›å¤šä¸ªå€¼ï¼Œä¸è¶³è¡¥ nilï¼Œè¶…å‡ºèˆå»ã€‚</li>
<li>å…¶ä»–æƒ…å†µä¸‹ï¼Œå‡½æ•°è°ƒç”¨<code>ä»…è¿”å›ç¬¬ä¸€ä¸ªå€¼</code>ï¼ˆå¦‚æœæ²¡æœ‰è¿”å›å€¼ä¸º nilï¼‰</li>
</ol>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo0</span> <span class="params">()</span></span> <span class="keyword">end</span> <span class="comment">-- returns no results</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo1</span> <span class="params">()</span></span> <span class="keyword">return</span> <span class="string">'a'</span> <span class="keyword">end</span> <span class="comment">-- returns 1 result</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo2</span> <span class="params">()</span></span> <span class="keyword">return</span> <span class="string">'a'</span>,<span class="string">'b'</span> <span class="keyword">end</span> <span class="comment">-- returns 2 results</span></span><br><span class="line"></span><br><span class="line">x,y = foo2(), <span class="number">20</span> <span class="comment">-- x='a', y=20</span></span><br><span class="line">x,y = foo0(), <span class="number">20</span>, <span class="number">30</span> <span class="comment">-- x='nil', y=20, 30 is discarded</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½œä¸ºå‡½æ•°å‚æ•°è°ƒç”¨</p>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(foo2(), <span class="number">1</span>) <span class="comment">--&gt; a 1</span></span><br><span class="line"><span class="built_in">print</span>(foo2() .. <span class="string">"x"</span>) <span class="comment">--&gt; ax</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åœ¨è¡¨æ„é€ å‡½æ•° è°ƒç”¨</p>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;foo0(), foo2(), <span class="number">4</span>&#125; <span class="comment">-- a[1] = nil, a[2] = 'a', a[3] = 4</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>return f()è¿™ç§ç±»å‹çš„è¿”å› f()è¿”å›çš„<code>æ‰€æœ‰å€¼</code></p>
</li>
<li>
<p>å¯ä»¥ä½¿ç”¨åœ†æ‹¬å·å¼ºåˆ¶ä½¿è°ƒç”¨è¿”å›ä¸€ä¸ªå€¼ã€‚</p>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>((foo0())) <span class="comment">--&gt; nil</span></span><br><span class="line"><span class="built_in">print</span>((foo1())) <span class="comment">--&gt; a</span></span><br><span class="line"><span class="built_in">print</span>((foo2())) <span class="comment">--&gt; a</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å‡½æ•°å¤šå€¼è¿”å›çš„ç‰¹æ®Šå‡½æ•° unpackï¼Œæ¥å—ä¸€ä¸ªæ•°ç»„ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œè¿”å›æ•°ç»„çš„æ‰€æœ‰å…ƒç´ ã€‚<br>
unpack è¢«ç”¨æ¥å®ç°èŒƒå‹è°ƒç”¨æœºåˆ¶ï¼Œåœ¨ C è¯­è¨€ä¸­å¯ä»¥ä½¿ç”¨å‡½æ•°æŒ‡é’ˆè°ƒç”¨å¯å˜çš„å‡½æ•°ï¼Œå¯ä»¥å£°æ˜å‚æ•°å¯å˜çš„å‡½æ•°ï¼Œä½†ä¸èƒ½ä¸¤è€…åŒæ—¶å¯å˜ã€‚</p>
<p>åœ¨ Lua ä¸­å¦‚æœä½ æƒ³è°ƒç”¨å¯å˜å‚æ•°çš„å¯å˜å‡½æ•°åªéœ€è¦è¿™æ ·</p>
<blockquote>
<p>f(unpack(a))</p>
</blockquote>
<p>é¢„å®šä¹‰çš„ unpack å‡½æ•°æ˜¯ç”¨ C è¯­è¨€å®ç°çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ Lua æ¥å®Œæˆï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unpack</span><span class="params">(t, i)</span></span></span><br><span class="line">    i = i <span class="keyword">or</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> t[i] <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> t[i], <span class="built_in">unpack</span>(t, i + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="5-2-variable-parameter-å¯å˜å‚æ•°"><a class="header-anchor" href="#5-2-variable-parameter-å¯å˜å‚æ•°">Â¶</a>5.2 variable parameter å¯å˜å‚æ•°</h3>
<p>Lua å‡½æ•°å¯ä»¥æ¥å—å¯å˜æ•°ç›®çš„å‚æ•°ï¼Œå’Œ C è¯­è¨€ç±»ä¼¼åœ¨å‡½æ•°å‚æ•°åˆ—è¡¨ä¸­ä½¿ç”¨ä¸‰ç‚¹<code>ï¼ˆ...ï¼‰</code>è¡¨ç¤ºå‡½æ•°æœ‰å¯å˜çš„å‚æ•°ã€‚<br>
Lua å°†å‡½æ•°çš„å‚æ•°æ”¾åœ¨ä¸€ä¸ªå« <code>arg</code> çš„è¡¨ä¸­ï¼Œé™¤äº†å‚æ•°ä»¥å¤–ï¼Œ<code>argè¡¨</code>ä¸­è¿˜æœ‰ä¸€ä¸ª<code>åŸŸ n</code> è¡¨ç¤ºå‚æ•°çš„ä¸ªæ•°ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">g</span> <span class="params">(a, b, ...)</span></span> <span class="keyword">end</span></span><br><span class="line">CALL PARAMETERS</span><br><span class="line">g(<span class="number">3</span>) a=<span class="number">3</span>, b=<span class="literal">nil</span>, <span class="built_in">arg</span>=&#123;n=<span class="number">0</span>&#125;</span><br><span class="line">g(<span class="number">3</span>, <span class="number">4</span>) a=<span class="number">3</span>, b=<span class="number">4</span>, <span class="built_in">arg</span>=&#123;n=<span class="number">0</span>&#125;</span><br><span class="line">g(<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">8</span>) a=<span class="number">3</span>, b=<span class="number">4</span>, <span class="built_in">arg</span>=&#123;<span class="number">5</span>, <span class="number">8</span>; n=<span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæˆ‘ä»¬åªæƒ³è¦ string.find è¿”å›çš„ç¬¬äºŒä¸ªå€¼ï¼šä¸€ä¸ªå…¸å‹çš„æ–¹æ³•æ˜¯ä½¿ç”¨è™šå˜é‡ï¼ˆä¸‹åˆ’çº¿ï¼‰</p>
<blockquote>
<p>local _, x = string.find(s, p)</p>
</blockquote>
<h3 id="5-3-named-parameter-å‘½åå‚æ•°"><a class="header-anchor" href="#5-3-named-parameter-å‘½åå‚æ•°">Â¶</a>5.3 named parameter å‘½åå‚æ•°</h3>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rename</span> <span class="params">(arg)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">os</span>.<span class="built_in">rename</span>(<span class="built_in">arg</span>.old, <span class="built_in">arg</span>.new)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rename</span>&#123;old=<span class="string">"temp.lua"</span>, new=<span class="string">"temp1.lua"</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-function-plus-å†è®ºå‡½æ•°"><a class="header-anchor" href="#6-function-plus-å†è®ºå‡½æ•°">Â¶</a>6. function plus å†è®ºå‡½æ•°</h2>
<p>note: <em><strong>Lua ä¸­çš„å‡½æ•°æ˜¯å¸¦æœ‰è¯æ³•å®šç•Œï¼ˆlexical scopingï¼‰çš„ç¬¬ä¸€ç±»å€¼ï¼ˆfirst-class valuesï¼‰ã€‚</strong></em></p>
<p>**ç¬¬ä¸€ç±»å€¼(first-class values)**æŒ‡ï¼š<em><strong>åœ¨ Lua ä¸­å‡½æ•°å’Œå…¶ä»–å€¼ï¼ˆæ•°å€¼ã€å­—ç¬¦ä¸²ï¼‰ä¸€æ ·ï¼Œå‡½æ•°å¯ä»¥è¢«å­˜æ”¾åœ¨å˜é‡ä¸­ï¼Œä¹Ÿå¯ä»¥å­˜æ”¾åœ¨è¡¨ä¸­ï¼Œå¯ä»¥ä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼Œè¿˜å¯ä»¥ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ã€‚</strong></em></p>
<p>**è¯æ³•å®šç•Œ(lexical scoping)**æŒ‡ï¼š<em><strong>è¢«åµŒå¥—çš„å‡½æ•°å¯ä»¥è®¿é—®ä»–å¤–éƒ¨å‡½æ•°ä¸­çš„å˜é‡ã€‚è¿™ä¸€ç‰¹æ€§ç»™ Lua æä¾›äº†å¼ºå¤§çš„ç¼–ç¨‹èƒ½åŠ›ã€‚</strong></em></p>
<p>Lua ä¸­æˆ‘ä»¬ç»å¸¸è¿™æ ·å†™ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">(x)</span></span> <span class="keyword">return</span> <span class="number">2</span>*x <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>è¿™å®é™…ä¸Šæ˜¯åˆ©ç”¨ Lua æä¾›çš„â€œè¯­æ³•ä¸Šçš„ç”œå¤´â€ï¼ˆ<em><strong>syntactic sugar</strong></em>ï¼‰çš„ç»“æœï¼Œä¸‹é¢æ˜¯åŸæœ¬çš„å‡½æ•°ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- why you try like that? because i dont't like sugar</span></span><br><span class="line">foo = <span class="function"><span class="keyword">function</span> <span class="params">(x)</span></span> <span class="keyword">return</span> <span class="number">2</span>*x <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æ ¹æ®å­¦ç”Ÿçš„æˆç»©ä»é«˜åˆ°ä½å¯¹å­¦ç”Ÿè¿›è¡Œæ’åºï¼Œ è¿™é‡Œçš„ names, grades ä½œç”¨åŸŸæ˜¯è¿™ä¸ªchunkçš„å…¨å±€</span></span><br><span class="line">names = &#123;<span class="string">"Peter"</span>, <span class="string">"Paul"</span>, <span class="string">"Mary"</span>&#125;</span><br><span class="line">grades = &#123;Mary = <span class="number">10</span>, Paul = <span class="number">7</span>, Peter = <span class="number">8</span>&#125;</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">sort</span>(names, <span class="function"><span class="keyword">function</span> <span class="params">(n1, n2)</span></span></span><br><span class="line"><span class="keyword">return</span> grades[n1] &gt; grades[n2] <span class="comment">-- compare the grades</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<p>ä»¥å…¶ä»–å‡½æ•°ä½œä¸ºå‚æ•°çš„å‡½æ•°åœ¨ Lua ä¸­è¢«ç§°ä½œ<code>é«˜çº§å‡½æ•°</code>ï¼Œé«˜çº§å‡½æ•°åœ¨ Lua ä¸­å¹¶æ²¡æœ‰ç‰¹æƒï¼Œåªæ˜¯ Lua æŠŠå‡½æ•°å½“ä½œ<code>ç¬¬ä¸€ç±»å‡½æ•°</code>å¤„ç†çš„ä¸€ä¸ªç®€å•çš„ç»“æœã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sortbygrade</span> <span class="params">(names, grades)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">sort</span>(names, <span class="function"><span class="keyword">function</span> <span class="params">(n1, n2)</span></span></span><br><span class="line">        <span class="keyword">return</span> grades[n1] &gt; grades[n2] <span class="comment">-- compare the grades</span></span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>åŒ…å«åœ¨ sortbygrade å‡½æ•°å†…éƒ¨çš„ sort ä¸­çš„åŒ¿åå‡½æ•°å¯ä»¥è®¿é—® sortbygrade çš„å‚æ•°gradesï¼Œ<br>
åœ¨<code>åŒ¿åå‡½æ•°å†…éƒ¨</code> grades ä¸æ˜¯å…¨å±€å˜é‡ä¹Ÿä¸æ˜¯å±€éƒ¨å˜é‡ï¼Œæˆ‘ä»¬ç§°ä½œ<code>å¤–éƒ¨çš„å±€éƒ¨å˜é‡</code>ï¼ˆexternal local variableï¼‰æˆ–è€… <code>upvalue</code>ã€‚</p>
<p>æŠ€æœ¯ä¸Šæ¥è®²ï¼Œ<code>é—­åŒ…</code>æŒ‡å€¼è€Œä¸æ˜¯æŒ‡å‡½æ•°ï¼Œå‡½æ•°ä»…ä»…æ˜¯é—­åŒ…çš„ä¸€ä¸ª<code>åŸå‹å£°æ˜</code>ï¼›</p>
<blockquote>
<p>é—­åŒ…çš„å£°æ˜å‘¨æœŸ?</p>
</blockquote>
<p>ç®€å•çš„è¯´<code>é—­åŒ…</code> æ˜¯ <em><strong>ä¸€ä¸ªå‡½æ•°åŠ ä¸Šå®ƒå¯ä»¥æ­£ç¡®è®¿é—®çš„ upvaluesã€‚</strong></em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Lib = &#123;&#125;</span><br><span class="line">Lib.foo = <span class="function"><span class="keyword">function</span> <span class="params">(x,y)</span></span> <span class="keyword">return</span> x + y <span class="keyword">end</span></span><br><span class="line">Lib.goo = <span class="function"><span class="keyword">function</span> <span class="params">(x,y)</span></span> <span class="keyword">return</span> x - y <span class="keyword">end</span></span><br><span class="line"><span class="comment">--------------</span></span><br><span class="line">Lib = &#123;</span><br><span class="line">    foo = <span class="function"><span class="keyword">function</span> <span class="params">(x,y)</span></span> <span class="keyword">return</span> x + y <span class="keyword">end</span>,</span><br><span class="line">    goo = <span class="function"><span class="keyword">function</span> <span class="params">(x,y)</span></span> <span class="keyword">return</span> x - y <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">--------------</span></span><br><span class="line">Lib = &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Lib.foo</span> <span class="params">(x,y)</span></span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Lib.goo</span> <span class="params">(x,y)</span></span></span><br><span class="line">    <span class="keyword">return</span> x - y</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Lua æŠŠ <code>chunk</code> å½“ä½œ<code>å‡½æ•°</code>å¤„ç†ï¼Œåœ¨ chunk å†…å¯ä»¥å£°æ˜<code>å±€éƒ¨å‡½æ•°</code>ï¼ˆ<em><strong>ä»…ä»…åœ¨ chunk å†…å¯è§</strong></em>ï¼‰ï¼Œè¯æ³•å®šç•Œä¿è¯äº†åŒ…å†…çš„<code>å…¶ä»–å‡½æ•°</code><strong>å¯ä»¥è°ƒç”¨</strong>æ­¤å‡½æ•°ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- error usage</span></span><br><span class="line"><span class="keyword">local</span> fact = <span class="function"><span class="keyword">function</span> <span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> n*fact(n<span class="number">-1</span>) <span class="comment">-- buggy</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™ç§æ–¹å¼å¯¼è‡´ Lua ç¼–è¯‘æ—¶é‡åˆ° fact(n-1)å¹¶<em>ä¸çŸ¥é“ä»–æ˜¯å±€éƒ¨å‡½æ•°</em> <code>fact</code>ï¼ŒLua ä¼šå»æŸ¥æ‰¾æ˜¯å¦æœ‰è¿™æ ·çš„<em>å…¨å±€å‡½æ•°</em> <code>fact</code>ã€‚<br>
ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¿…é¡»åœ¨<em>å®šä¹‰å‡½æ•°ä»¥å‰</em> å…ˆ<strong>å£°æ˜</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> fact</span><br><span class="line">fact = <span class="function"><span class="keyword">function</span> <span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> n*fact(n<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>note:<em>ä½†æ˜¯ Lua æ‰©å±•äº†ä»–çš„è¯­æ³•ä½¿å¾—å¯ä»¥åœ¨ç›´æ¥é€’å½’å‡½æ•°å®šä¹‰æ—¶ä½¿ç”¨ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥ã€‚</em><br>
note:<em>åœ¨å®šä¹‰<code>é</code>ç›´æ¥é€’å½’å±€éƒ¨å‡½æ•°æ—¶è¦<strong>å…ˆå£°æ˜</strong>ç„¶åå®šä¹‰æ‰å¯ä»¥</em></p>
<h3 id="6-3-proper-tail-calls-å°¾è°ƒç”¨"><a class="header-anchor" href="#6-3-proper-tail-calls-å°¾è°ƒç”¨">Â¶</a>6.3 proper tail calls å°¾è°ƒç”¨</h3>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(x)</span></span></span><br><span class="line">    <span class="keyword">return</span> g(x)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><em>è¿™ç§æƒ…å†µä¸‹å½“è¢«è°ƒç”¨å‡½æ•° g ç»“æŸæ—¶ç¨‹åº<strong>ä¸éœ€è¦è¿”å›</strong>åˆ°<code>è°ƒç”¨è€… f</code>ï¼›</em><br>
<em>æ‰€ä»¥<strong>å°¾è°ƒç”¨ä¹‹å</strong>ç¨‹åºä¸éœ€è¦åœ¨æ ˆä¸­ä¿ç•™å…³äº<strong>è°ƒç”¨è€…çš„ä»»ä½•ä¿¡æ¯</strong>ã€‚</em><br>
<em>ä¸€äº›ç¼–è¯‘å™¨æ¯”å¦‚ <strong>Lua è§£é‡Šå™¨</strong>åˆ©ç”¨è¿™ç§ç‰¹æ€§åœ¨å¤„ç†å°¾è°ƒç”¨æ—¶<strong>ä¸ä½¿ç”¨é¢å¤–çš„æ ˆ</strong>ï¼Œæˆ‘ä»¬ç§°è¿™ç§è¯­è¨€<strong>æ”¯æŒ</strong><code>æ­£ç¡®çš„å°¾è°ƒç”¨</code>ã€‚</em></p>
<p>note:<em>ç”±äºå°¾è°ƒç”¨ä¸éœ€è¦ä½¿ç”¨æ ˆç©ºé—´ï¼Œé‚£ä¹ˆå°¾è°ƒç”¨<strong>é€’å½’çš„å±‚æ¬¡</strong>å¯ä»¥æ— é™åˆ¶çš„ã€‚ä¾‹å¦‚ä¸‹é¢è°ƒç”¨ä¸è®º n ä¸ºä½•å€¼<strong>ä¸ä¼šå¯¼è‡´æ ˆæº¢å‡º</strong>ã€‚</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">return</span> foo(n - <span class="number">1</span>) <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- éå°¾è°ƒç”¨</span></span><br><span class="line"><span class="keyword">return</span> g(x) + <span class="number">1</span> <span class="comment">-- must do the addition</span></span><br><span class="line"><span class="keyword">return</span> x <span class="keyword">or</span> g(x) <span class="comment">-- must adjust to 1 result</span></span><br><span class="line"><span class="keyword">return</span> (g(x)) <span class="comment">-- must adjust to 1 result</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å°†å°¾è°ƒç”¨ç†è§£æˆä¸€ç§ gotoï¼Œåœ¨<strong>çŠ¶æ€æœºçš„ç¼–ç¨‹</strong>é¢†åŸŸå°¾è°ƒç”¨æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚<br>
çŠ¶æ€æœºçš„åº”ç”¨è¦æ±‚å‡½æ•°è®°ä½æ¯ä¸€ä¸ªçŠ¶æ€ï¼Œæ”¹å˜çŠ¶æ€åªéœ€è¦ goto(or call)ä¸€ä¸ªç‰¹å®šçš„å‡½æ•°ã€‚</p>
<p>ä¼ ç»Ÿæ¨¡å¼çš„ç¼–è¯‘å™¨å¯¹äºå°¾è°ƒç”¨çš„å¤„ç†æ–¹å¼å°±åƒå¤„ç†å…¶ä»–æ™®é€šå‡½æ•°è°ƒç”¨ä¸€æ ·ï¼Œæ€»ä¼šåœ¨è°ƒç”¨æ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆå¸§ï¼ˆstack frameï¼‰å¹¶å°†å…¶æ¨å…¥è°ƒç”¨æ ˆé¡¶éƒ¨ï¼Œç”¨äºè¡¨ç¤ºè¯¥æ¬¡å‡½æ•°è°ƒç”¨ã€‚</p>
<p>å½“ä¸€ä¸ªå‡½æ•°è°ƒç”¨å‘ç”Ÿæ—¶ï¼Œè®¡ç®—æœºå¿…é¡» â€œè®°ä½â€ è°ƒç”¨å‡½æ•°çš„ä½ç½® â€”â€” è¿”å›ä½ç½®ï¼Œæ‰å¯ä»¥åœ¨è°ƒç”¨ç»“æŸæ—¶å¸¦ç€è¿”å›å€¼å›åˆ°è¯¥ä½ç½®ï¼Œè¿”å›ä½ç½®ä¸€èˆ¬å­˜åœ¨è°ƒç”¨æ ˆä¸Šã€‚åœ¨å°¾è°ƒç”¨è¿™ç§ç‰¹æ®Šæƒ…å½¢ä¸­ï¼Œè®¡ç®—æœºç†è®ºä¸Šå¯ä»¥<em>ä¸éœ€è¦è®°ä½å°¾è°ƒç”¨çš„ä½ç½®</em>è€Œ<em>ä»è¢«è°ƒç”¨çš„å‡½æ•°ç›´æ¥<strong>å¸¦ç€è¿”å›å€¼</strong>è¿”å›è°ƒç”¨å‡½æ•°çš„è¿”å›ä½ç½®</em>ï¼ˆç›¸å½“äºç›´æ¥è¿ç»­è¿”å›ä¸¤æ¬¡ï¼‰ã€‚<br>
å°¾è°ƒç”¨æ¶ˆé™¤å³æ˜¯åœ¨ä¸æ”¹å˜å½“å‰è°ƒç”¨æ ˆï¼ˆä¹Ÿä¸æ·»åŠ æ–°çš„è¿”å›ä½ç½®ï¼‰çš„æƒ…å†µä¸‹è·³åˆ°æ–°å‡½æ•°çš„ä¸€ç§ä¼˜åŒ–ï¼ˆå®Œå…¨ä¸æ”¹å˜è°ƒç”¨æ ˆæ˜¯ä¸å¯èƒ½çš„ï¼Œè¿˜æ˜¯éœ€è¦æ ¡æ­£è°ƒç”¨æ ˆä¸Šå½¢å¼å‚æ•°ä¸å±€éƒ¨å˜é‡çš„ä¿¡æ¯ã€‚ï¼‰</p>
<p>ç”±äºå½“å‰å‡½æ•°å¸§ä¸ŠåŒ…å«å±€éƒ¨å˜é‡ç­‰ç­‰å¤§éƒ¨åˆ†çš„ä¸œè¥¿éƒ½ä¸éœ€è¦äº†ï¼Œå½“å‰çš„<em>å‡½æ•°å¸§ç»è¿‡é€‚å½“çš„æ›´åŠ¨</em>ä»¥åå¯ä»¥<em>ç›´æ¥å½“ä½œè¢«å°¾è°ƒç”¨çš„å‡½æ•°çš„å¸§ä½¿ç”¨</em>ï¼Œç„¶åç¨‹åºå³å¯ä»¥è·³åˆ°è¢«å°¾è°ƒç”¨çš„å‡½æ•°ã€‚äº§ç”Ÿè¿™ç§å‡½æ•°å¸§æ›´åŠ¨ä»£ç ä¸ â€œjumpâ€ï¼ˆè€Œä¸æ˜¯ä¸€èˆ¬å¸¸è§„å‡½æ•°è°ƒç”¨çš„ä»£ç ï¼‰çš„è¿‡ç¨‹ç§°ä½œ<strong>å°¾è°ƒç”¨æ¶ˆé™¤(Tail Call Elimination)<strong>æˆ–</strong>å°¾è°ƒç”¨ä¼˜åŒ–(Tail Call Optimization, TCO)</strong>ã€‚å°¾è°ƒç”¨ä¼˜åŒ–è®©ä½äºå°¾ä½ç½®çš„å‡½æ•°è°ƒç”¨è·Ÿ goto è¯­å¥æ€§èƒ½ä¸€æ ·é«˜ï¼Œä¹Ÿå› æ­¤ä½¿å¾—é«˜æ•ˆçš„ç»“æ„ç¼–ç¨‹æˆä¸ºç°å®ã€‚</p>
<p>ç„¶è€Œï¼Œå¯¹äº <strong>C++</strong> ç­‰è¯­è¨€æ¥è¯´ï¼Œåœ¨å‡½æ•°æœ€å return g(x); å¹¶ä¸ä¸€å®šæ˜¯å°¾é€’å½’â€”â€”åœ¨è¿”å›ä¹‹å‰å¾ˆå¯èƒ½æ¶‰åŠåˆ°<strong>å¯¹è±¡çš„ææ„å‡½æ•°</strong>ï¼Œä½¿å¾— g(x) ä¸æ˜¯æœ€åæ‰§è¡Œçš„é‚£ä¸ªã€‚è¿™å¯ä»¥é€šè¿‡è¿”å›å€¼ä¼˜åŒ–æ¥è§£å†³ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">(data1, data2)</span></span></span><br><span class="line">   a(data1)</span><br><span class="line">   <span class="keyword">return</span> b(data2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ±‡ç¼–ä»£ç :</span><br><span class="line">```asm</span><br><span class="line">foo:</span><br><span class="line">  mov  reg,[sp+data1] ; é€è¿‡æ ˆæŒ‡é’ˆï¼ˆspï¼‰å–å¾— data1 å¹¶æ”¾åˆ°æš‚ç”¨æš‚å­˜å™¨ã€‚</span><br><span class="line">  push reg            ; å°† data1 æ”¾åˆ°æ ˆä¸Šä»¥ä¾¿ a ä½¿ç”¨ã€‚</span><br><span class="line">  call a              ; a ä½¿ç”¨ data1ã€‚</span><br><span class="line">  pop                 ; æŠŠ data1 å¾æ ˆä¸Šæ‹¿æ‰ã€‚</span><br><span class="line">  mov  reg,[sp+data2] ; é€è¿‡æ ˆæŒ‡é‡ï¼ˆspï¼‰å–å¾— data2 ä¸¦æ”¾åˆ°æš‚ç”¨æš‚å­˜å™¨ã€‚</span><br><span class="line">  push reg            ; å°† data2 æ”¾åˆ°æ ˆä¸Šä»¥ä¾¿ b ä½¿ç”¨ã€‚</span><br><span class="line">  call b              ; b ä½¿ç”¨ data2ã€‚</span><br><span class="line">  pop                 ; æŠŠ data2 å¾æ ˆä¸Šæ‹¿æ‰ã€‚</span><br><span class="line">  ret</span><br></pre></td></tr></table></figure>
<p>ä¼˜åŒ–åæ±‡ç¼–ä»£ç :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">foo:</span><br><span class="line">  mov  reg,[sp+data1] ; é€è¿‡æ ˆæŒ‡é’ˆï¼ˆspï¼‰å–å¾— data1 å¹¶æ”¾åˆ°æš‚ç”¨æš‚å­˜å™¨ã€‚</span><br><span class="line">  push reg            ; å°† data1 æ”¾åˆ°æ ˆä¸Šä»¥ä¾¿ a ä½¿ç”¨ã€‚</span><br><span class="line">  call a              ; a ä½¿ç”¨ data1ã€‚</span><br><span class="line">  pop                 ; æŠŠ data1 å¾æ ˆä¸Šæ‹¿æ‰ã€‚</span><br><span class="line">  mov  reg,[sp+data2] ; é€è¿‡æ ˆæŒ‡é‡ï¼ˆspï¼‰å–å¾— data2 ä¸¦æ”¾åˆ°æš‚ç”¨æš‚å­˜å™¨ã€‚  </span><br><span class="line">  mov  [sp+data1],reg ; æŠŠ data2 æ”¾åˆ° b é¢„æœŸçš„ä½ç½®ã€‚</span><br><span class="line">  jmp  b              ; b ä½¿ç”¨ data2 ä¸¦è¿”å›åˆ°è°ƒç”¨ foo çš„å‡½æ•°ã€‚</span><br></pre></td></tr></table></figure>
<h2 id="7-iterator-genericity-for-è¿­ä»£å™¨-æ³›å‹for"><a class="header-anchor" href="#7-iterator-genericity-for-è¿­ä»£å™¨-æ³›å‹for">Â¶</a>7. iterator &amp; genericity for è¿­ä»£å™¨ æ³›å‹for</h2>
<p>åˆ›å»ºä¸€ä¸ª<code>é—­åŒ…</code>å¿…é¡»è¦åˆ›å»ºå…¶å¤–éƒ¨å±€éƒ¨å˜é‡ã€‚<br>
æ‰€ä»¥ä¸€ä¸ªå…¸å‹çš„é—­åŒ…çš„ç»“æ„åŒ…å«ä¸¤ä¸ªå‡½æ•°ï¼šä¸€ä¸ªæ˜¯<code>é—­åŒ…</code>è‡ªå·±ï¼›å¦ä¸€ä¸ªæ˜¯å·¥å‚ï¼ˆ<code>åˆ›å»ºé—­åŒ…çš„å‡½æ•°</code>ï¼‰ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">list_iter</span> <span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">local</span> n = <span class="built_in">table</span>.<span class="built_in">getn</span>(t)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> i &lt;= n <span class="keyword">then</span> <span class="keyword">return</span> t[i] <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- usage:</span></span><br><span class="line">t = &#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>&#125;</span><br><span class="line">iter = list_iter(t) <span class="comment">-- creates the iterator</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> element = iter() <span class="comment">-- calls the iterator</span></span><br><span class="line">    <span class="keyword">if</span> element == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">print</span>(element)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ³›å‹ for</span></span><br><span class="line">t = &#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>&#125;</span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> list_iter(t) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(element)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>note:<em>è¿™ä¸ªä¾‹å­ä¸­ list_iter æ˜¯ä¸€ä¸ªå·¥å‚ï¼Œæ¯æ¬¡è°ƒç”¨ä»–éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„é—­åŒ…ï¼ˆè¿­ä»£å™¨æœ¬èº«ï¼‰</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è¿­ä»£å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">allwords</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> line = <span class="built_in">io</span>.<span class="built_in">read</span>() <span class="comment">-- current line</span></span><br><span class="line">    <span class="keyword">local</span> pos = <span class="number">1</span> <span class="comment">-- current position in the line</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="comment">-- iterator function</span></span><br><span class="line">        <span class="keyword">while</span> line <span class="keyword">do</span> <span class="comment">-- repeat while there are lines</span></span><br><span class="line">            <span class="keyword">local</span> s, e = <span class="built_in">string</span>.<span class="built_in">find</span>(line, <span class="string">"%w+"</span>, pos)</span><br><span class="line">            <span class="keyword">if</span> s <span class="keyword">then</span> <span class="comment">-- found a word</span></span><br><span class="line">                pos = e + <span class="number">1</span> <span class="comment">-- next position is after this word</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">sub</span>(line, s, e) <span class="comment">-- return the word</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                line = <span class="built_in">io</span>.<span class="built_in">read</span>() <span class="comment">-- word not found; try next line</span></span><br><span class="line">                pos = <span class="number">1</span> <span class="comment">-- restart from first position</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span> <span class="comment">-- no more lines: end of traversal</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- usage:</span></span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> allwords() <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(word)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="7-2-genericity-for-æ³›å‹-for-çš„è¯­ä¹‰"><a class="header-anchor" href="#7-2-genericity-for-æ³›å‹-for-çš„è¯­ä¹‰">Â¶</a>7.2 genericity for æ³›å‹ for çš„è¯­ä¹‰</h3>
<p>ä¸€èˆ¬å¼:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> var_1, ..., var_n <span class="keyword">in</span> explist <span class="keyword">do</span> block <span class="keyword">end</span></span><br><span class="line"><span class="comment">-- ==&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> _f, _s, _var = explist</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> var_1, ... , var_n = _f(_s, _var)</span><br><span class="line">        _var = var_1</span><br><span class="line">        <span class="keyword">if</span> _var == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        block</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="7-3-iterator-without-status-æ— çŠ¶æ€çš„è¿­ä»£å™¨"><a class="header-anchor" href="#7-3-iterator-without-status-æ— çŠ¶æ€çš„è¿­ä»£å™¨">Â¶</a>7.3 iterator without status æ— çŠ¶æ€çš„è¿­ä»£å™¨</h3>
<p>note:<em>è¿­ä»£çš„çŠ¶æ€åŒ…æ‹¬è¢«éå†çš„è¡¨ï¼ˆå¾ªç¯è¿‡ç¨‹ä¸­ä¸ä¼šæ”¹å˜çš„<code>çŠ¶æ€å¸¸é‡</code>ï¼‰å’Œå½“å‰çš„ç´¢å¼•ä¸‹æ ‡ï¼ˆ<code>æ§åˆ¶å˜é‡</code>ï¼‰ï¼Œ</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">iter</span> <span class="params">(a, i)</span></span></span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">local</span> v = a[i]</span><br><span class="line">    <span class="keyword">if</span> v <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> i, v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ipairs</span> <span class="params">(a)</span></span></span><br><span class="line">    <span class="keyword">return</span> iter, a, <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>note:<em>å½“ Lua è°ƒç”¨ ipairs(a)å¼€å§‹å¾ªç¯æ—¶ï¼Œä»–è·å–ä¸‰ä¸ªå€¼:è¿­ä»£å‡½æ•° iterï¼ŒçŠ¶æ€å¸¸é‡ a å’Œæ§åˆ¶å˜é‡åˆå§‹å€¼ 0ï¼›ç„¶å Lua è°ƒç”¨ iter(a,0)è¿”å› 1,a[1]ï¼ˆé™¤é a[1]=nilï¼‰ï¼›ç›´åˆ°<strong>ç¬¬ä¸€ä¸ª</strong>é nil å…ƒç´ </em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> n</span><br><span class="line"><span class="comment">-- n = nil å…¨éƒ¨</span></span><br><span class="line"><span class="comment">-- n = 1 æ‰“å°ä»2 å¼€å§‹</span></span><br><span class="line"><span class="comment">-- n = 0 å‡ºé”™</span></span><br><span class="line">dd=&#123;<span class="number">1</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,&#125;</span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">next</span>, dd, n <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k,v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="7-3-multi-status-iterator-å¤šçŠ¶æ€çš„è¿­ä»£å™¨"><a class="header-anchor" href="#7-3-multi-status-iterator-å¤šçŠ¶æ€çš„è¿­ä»£å™¨">Â¶</a>7.3 multi status iterator å¤šçŠ¶æ€çš„è¿­ä»£å™¨</h3>
<h2 id="8-compile-run-debug-ç¼–è¯‘-è¿è¡Œ-è°ƒè¯•"><a class="header-anchor" href="#8-compile-run-debug-ç¼–è¯‘-è¿è¡Œ-è°ƒè¯•">Â¶</a>8. compile run debug ç¼–è¯‘ è¿è¡Œ è°ƒè¯•</h2>
<p>note: <em>è§£é‡Šå‹è¯­è¨€çš„ç‰¹å¾ä¸åœ¨äºä»–ä»¬æ˜¯å¦è¢«ç¼–è¯‘ï¼Œè€Œæ˜¯<code>ç¼–è¯‘å™¨</code>æ˜¯<code>è¯­è¨€è¿è¡Œæ—¶</code>çš„ä¸€éƒ¨åˆ†</em></p>
<p>loadfile:<em>ç¼–è¯‘ä»£ç æˆä¸­é—´ç å¹¶ä¸”è¿”å›ç¼–è¯‘åçš„ chunk ä½œä¸ºä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸æ‰§è¡Œä»£ç ï¼›</em></p>
<p>note:<em>åœ¨å‘ç”Ÿé”™è¯¯çš„æƒ…å†µä¸‹ï¼Œloadfile è¿”å› nil å’Œé”™è¯¯ä¿¡æ¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è‡ªå®šä¹‰é”™è¯¯å¤„ç†</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f = loadstring(<span class="string">"i = i + 1"</span>)</span><br></pre></td></tr></table></figure>
<p>note:<em>f å°†æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨æ—¶æ‰§è¡Œ i=i+1</em></p>
<p>Lua æŠŠæ¯ä¸€ä¸ª chunk éƒ½ä½œä¸ºä¸€ä¸ª<code>åŒ¿åå‡½æ•°</code>å¤„ç†ã€‚<br>
ä¾‹å¦‚ï¼šchunk â€œa = 1â€ï¼Œ<br>
<code>loadstring</code> è¿”å›ä¸å…¶ç­‰ä»·çš„ <code>function () a = 1 end</code>ä¸å…¶ä»–å‡½æ•°ä¸€æ ·ï¼Œ<br>
chunks å¯ä»¥å®šä¹‰å±€éƒ¨å˜é‡ä¹Ÿå¯ä»¥è¿”å›å€¼ï¼š<code>f = loadstring(&quot;local a = 10; return a + 20&quot;)</code></p>
<p>note:<em>loadfile å’Œ loadstring éƒ½ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ä»–ä»¬å°†è¿”å› nil åŠ ä¸Šé”™è¯¯ä¿¡æ¯ï¼š</em><br>
note:<em>Lua ä¸­çš„<code>å‡½æ•°å®šä¹‰</code>æ˜¯å‘ç”Ÿåœ¨<code>è¿è¡Œæ—¶çš„èµ‹å€¼</code>è€Œä¸æ˜¯å‘ç”Ÿåœ¨ç¼–è¯‘æ—¶ã€‚</em></p>
<p>å¦‚æœä½ æƒ³å¿«æ·çš„è°ƒç”¨ dostringï¼ˆæ¯”å¦‚åŠ è½½å¹¶è¿è¡Œï¼‰ï¼Œå¯ä»¥è¿™æ ·<br>
<code>loadstring(s)()</code></p>
<p>å¦‚æœåŠ è½½çš„å†…å®¹å­˜åœ¨<code>è¯­æ³•é”™è¯¯</code>çš„è¯ï¼Œloadstring è¿”å› nil å’Œé”™è¯¯ä¿¡æ¯ï¼ˆattempt to call a nil valueï¼‰ï¼›ä¸ºäº†è¿”å›æ›´æ¸…æ¥šçš„é”™è¯¯ä¿¡æ¯å¯ä»¥ä½¿ç”¨ assertï¼š<br>
<code>assert(loadstring(s))()</code></p>
<p>note:<em>æ¯æ¬¡è°ƒç”¨ loadstring éƒ½ä¼šé‡æ–°ç¼–è¯‘,loadstring ç¼–è¯‘çš„æ—¶å€™ä¸å…³å¿ƒè¯æ³•èŒƒå›´</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">f = loadstring(<span class="string">"i = i + 1"</span>)</span><br><span class="line">g = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> i = i + <span class="number">1</span> <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>note:<em>è¿™ä¸ªä¾‹å­ä¸­ï¼Œå’Œæƒ³è±¡çš„ä¸€æ · <code>g</code> ä½¿ç”¨<strong>å±€éƒ¨å˜é‡</strong> iï¼Œç„¶è€Œ <code>f</code> ä½¿ç”¨<strong>å…¨å±€å˜é‡</strong> iï¼›<code>loadstring</code> æ€»æ˜¯åœ¨<strong>å…¨å±€ç¯å¢ƒ</strong>ä¸­<strong>ç¼–è¯‘</strong>ä»–çš„ä¸²ã€‚</em></p>
<p>note:<em>loadstring æœŸæœ›ä¸€ä¸ª chunkï¼Œå³è¯­å¥ã€‚å¦‚æœæƒ³è¦åŠ è½½<code>è¡¨è¾¾å¼</code>ï¼Œéœ€è¦åœ¨è¡¨è¾¾å¼å‰åŠ  <code>return</code>ï¼Œé‚£æ ·å°†è¿”å›è¡¨è¾¾å¼çš„å€¼ã€‚</em></p>
<h2 id="8-1-require"><a class="header-anchor" href="#8-1-require">Â¶</a>8.1 require</h2>
<ul>
<li><em>ä¼šæœç´¢ç›®å½•åŠ è½½æ–‡ä»¶</em></li>
<li><em>ä¼šåˆ¤æ–­æ˜¯å¦æ–‡ä»¶å·²ç»åŠ è½½é¿å…é‡å¤åŠ è½½åŒä¸€æ–‡ä»¶</em></li>
<li><em>?;?.lua;c:\windows?;/usr/local/lua/?/?.lua</em></li>
<li><em>require å’Œ dofile å®ŒæˆåŒæ ·çš„åŠŸèƒ½</em></li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span> lili</span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">lili</span></span><br><span class="line"><span class="comment">lili.lua</span></span><br><span class="line"><span class="comment">c:\windows\lili</span></span><br><span class="line"><span class="comment">/usr/local/lua/lili/lili.lua</span></span><br><span class="line"><span class="comment">]]</span></span><br></pre></td></tr></table></figure>
<p>note:<em>è¡¨ä¸­ä¿ç•™åŠ è½½çš„æ–‡ä»¶çš„è™šåï¼Œè€Œä¸æ˜¯å®æ–‡ä»¶åã€‚æ‰€ä»¥å¦‚æœä½ ä½¿ç”¨ä¸åŒçš„è™šæ–‡ä»¶å requireåŒä¸€ä¸ªæ–‡ä»¶ä¸¤æ¬¡ï¼Œå°†ä¼šåŠ è½½ä¸¤æ¬¡è¯¥æ–‡ä»¶ã€‚æ¯”å¦‚ require &quot;foo&quot;å’Œ require â€œfoo.luaâ€ï¼Œå°†ä¼šåŠ è½½ foo.lua ä¸¤æ¬¡,å…¨å±€å˜é‡<code>_LOADED</code> è®¿é—®æ–‡ä»¶ååˆ—è¡¨, <code>_REQUIREDNAME</code></em></p>
<h3 id="8-2-C-Packages"><a class="header-anchor" href="#8-2-C-Packages">Â¶</a>8.2 C Packages</h3>
<p>note:<em>åŠ¨æ€è¿æ¥åº“ä¸æ˜¯ ANSI C çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ ‡å‡† C ä¸­å®ç°åŠ¨æ€è¿æ¥æ˜¯å¾ˆå›°éš¾çš„ã€‚</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">path</span> = <span class="string">"/usr/local/lua/lib/libluasocket.so"</span></span><br><span class="line"><span class="comment">-- or path = "C:\\windows\\luasocket.dll"</span></span><br><span class="line"><span class="keyword">local</span> f = <span class="built_in">assert</span>(<span class="built_in">loadlib</span>(<span class="built_in">path</span>, <span class="string">"luaopen_socket"</span>))</span><br><span class="line">f() <span class="comment">-- actually open the library</span></span><br></pre></td></tr></table></figure>
<h3 id="8-3-error-é”™è¯¯"><a class="header-anchor" href="#8-3-error-é”™è¯¯">Â¶</a>8.3 error é”™è¯¯</h3>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span> <span class="string">"enter a number:"</span></span><br><span class="line">n = <span class="built_in">io</span>.<span class="built_in">read</span>(<span class="string">"*number"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">then</span> <span class="built_in">error</span>(<span class="string">"invalid input"</span>) <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="8-4-exception-pcall"><a class="header-anchor" href="#8-4-exception-pcall">Â¶</a>8.4 exception &amp; pcall</h3>
<h3 id="8-5-exception-msg-xpcall"><a class="header-anchor" href="#8-5-exception-msg-xpcall">Â¶</a>8.5 exception msg &amp; xpcall</h3>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">error</span>(<span class="string">"string expected"</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">debug</span>.<span class="built_in">traceback</span>())</span><br></pre></td></tr></table></figure>
<h2 id="9-0-coroutine"><a class="header-anchor" href="#9-0-coroutine">Â¶</a>9.0 coroutine</h2>
<p>ååŒç¨‹åºï¼ˆcoroutineï¼‰<em>ä¸å¤šçº¿ç¨‹æƒ…å†µä¸‹çš„çº¿ç¨‹æ¯”è¾ƒç±»ä¼¼ï¼šæœ‰è‡ªå·±çš„å †æ ˆï¼Œè‡ªå·±çš„å±€éƒ¨å˜é‡ï¼Œæœ‰è‡ªå·±çš„æŒ‡ä»¤æŒ‡é’ˆï¼Œä½†æ˜¯å’Œå…¶ä»–ååŒç¨‹åºå…±äº«å…¨å±€å˜é‡ç­‰å¾ˆå¤šä¿¡æ¯ã€‚</em></p>
<p>çº¿ç¨‹å’ŒååŒç¨‹åºçš„ä¸»è¦ä¸åŒåœ¨äºï¼šåœ¨å¤šå¤„ç†å™¨æƒ…å†µä¸‹ï¼Œä»æ¦‚å¿µä¸Šæ¥è®²å¤šçº¿ç¨‹ç¨‹åºåŒæ—¶è¿è¡Œå¤šä¸ªçº¿ç¨‹ï¼›è€ŒååŒç¨‹åºæ˜¯é€šè¿‡åä½œæ¥å®Œæˆï¼Œåœ¨<strong>ä»»ä¸€æŒ‡å®šæ—¶åˆ»åªæœ‰ä¸€ä¸ªååŒç¨‹åºåœ¨è¿è¡Œ</strong>ï¼Œå¹¶ä¸”è¿™ä¸ªæ­£åœ¨è¿è¡Œçš„ååŒç¨‹åºåªæœ‰åœ¨æ˜ç¡®çš„è¢«è¦æ±‚æŒ‚èµ·çš„æ—¶å€™æ‰ä¼šè¢«æŒ‚èµ·ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">co = coroutine.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">"hi"</span>) <span class="keyword">end</span>)</span><br><span class="line"><span class="built_in">print</span>(co) <span class="comment">--&gt; thread: 0x8071d98</span></span><br></pre></td></tr></table></figure>
<p>note:<em>ååŒæœ‰ä¸‰ä¸ªçŠ¶æ€ï¼šæŒ‚èµ·æ€ã€è¿è¡Œæ€ã€åœæ­¢æ€.å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªååŒç¨‹åºæ—¶ä»–å¼€å§‹çš„çŠ¶æ€ä¸ºæŒ‚èµ·æ€ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åˆ›å»ºååŒç¨‹åºçš„æ—¶å€™ä¸ä¼šè‡ªåŠ¨è¿è¡Œï¼Œ</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(coroutine.<span class="built_in">status</span>(co)) <span class="comment">--&gt; suspended</span></span><br><span class="line">coroutine.<span class="built_in">resume</span>(co)</span><br><span class="line"><span class="built_in">print</span>(coroutine.<span class="built_in">status</span>(co)) <span class="comment">--&gt; dead</span></span><br><span class="line"></span><br><span class="line">co = coroutine.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">for</span> i=<span class="number">1</span>,<span class="number">10</span> <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"co"</span>, i)</span><br><span class="line">        coroutine.<span class="built_in">yield</span>()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ååŒç¨‹åºå¤„äºç»ˆæ­¢çŠ¶æ€ æ¿€æ´»ä»–ï¼Œresume å°†è¿”å› false å’Œé”™è¯¯ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="built_in">print</span>(coroutine.<span class="built_in">resume</span>(co)) <span class="comment">--&gt; false cannot resume dead coroutine</span></span><br></pre></td></tr></table></figure>
<p>note:<em>resume è¿è¡Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œå› æ­¤å¦‚æœååŒå†…éƒ¨å­˜åœ¨é”™è¯¯ Lua å¹¶ä¸ä¼šæŠ›å‡ºé”™è¯¯è€Œæ˜¯å°†é”™è¯¯è¿”å›ç»™ resume å‡½æ•°ã€‚</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- yield è¿”å›çš„é¢å¤–çš„å‚æ•°ä¹Ÿå°†ä¼šä¼ é€’ç»™ resumeã€‚</span></span><br><span class="line">co = coroutine.<span class="built_in">create</span> (<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"co"</span>, coroutine.<span class="built_in">yield</span>())</span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line">coroutine.<span class="built_in">resume</span>(co)</span><br><span class="line">coroutine.<span class="built_in">resume</span>(co, <span class="number">4</span>, <span class="number">5</span>) <span class="comment">--&gt; co 4 5</span></span><br></pre></td></tr></table></figure>
<ul>
<li>resume æŠŠé¢å¤–çš„å‚æ•°ä¼ é€’ç»™ååŒçš„ä¸»ç¨‹åºã€‚</li>
<li>resume è¿”å›é™¤äº† true ä»¥å¤–çš„å…¶ä»–éƒ¨åˆ†å°†ä½œä¸ºå‚æ•°ä¼ é€’ç»™ç›¸åº”çš„ yield, yield è¿”å›çš„é¢å¤–çš„å‚æ•°ä¹Ÿå°†ä¼šä¼ é€’ç»™ resumeã€‚</li>
<li>å½“ååŒä»£ç ç»“æŸæ—¶ä¸»å‡½æ•°è¿”å›çš„å€¼éƒ½ä¼šä¼ ç»™ç›¸åº”çš„ resume</li>
</ul>
<p>å¯¹ç§°ååŒ:<em>ç”±æ‰§è¡Œåˆ°æŒ‚èµ·ä¹‹é—´çŠ¶æ€è½¬æ¢çš„å‡½æ•°æ˜¯ç›¸åŒçš„ã€‚</em><br>
ä¸å¯¹ç§°ååŒ(åŠååŒ):<em>æŒ‚èµ·ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ååŒçš„å‡½æ•°ä¸ä½¿ä¸€ ä¸ªè¢«æŒ‚èµ·çš„ååŒå†æ¬¡æ‰§è¡Œçš„å‡½æ•°æ˜¯ä¸åŒçš„</em></p>
<h3 id="9-2-filter-è¿‡æ»¤å™¨"><a class="header-anchor" href="#9-2-filter-è¿‡æ»¤å™¨">Â¶</a>9.2 filter è¿‡æ»¤å™¨</h3>
<p>è¿‡æ»¤å™¨:<em>æŒ‡åœ¨ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ä¹‹é—´ï¼Œå¯ä»¥å¯¹æ•°æ® è¿›è¡ŒæŸäº›è½¬æ¢å¤„ç†ã€‚è¿‡æ»¤å™¨åœ¨åŒä¸€æ—¶é—´æ—¢æ˜¯ç”Ÿäº§è€…åˆæ˜¯æ¶ˆè´¹è€…ï¼Œä»–è¯·æ±‚ç”Ÿäº§è€…ç”Ÿäº§å€¼å¹¶ ä¸”è½¬æ¢æ ¼å¼åä¼ ç»™æ¶ˆè´¹è€…</em></p>
<p>example:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">receive</span> <span class="params">(prod)</span></span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, value = coroutine.<span class="built_in">resume</span>(prod)</span><br><span class="line">   <span class="keyword">return</span> value</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span> <span class="params">(x)</span></span></span><br><span class="line">   coroutine.<span class="built_in">yield</span>(x)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">producer</span> <span class="params">()</span></span></span><br><span class="line">   <span class="keyword">return</span> coroutine.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> x = <span class="built_in">io</span>.<span class="built_in">read</span>() <span class="comment">-- produce new value</span></span><br><span class="line">            send(x)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span> <span class="params">(prod)</span></span></span><br><span class="line">   <span class="keyword">return</span> coroutine.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">       <span class="keyword">local</span> line = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> x = receive(prod) <span class="comment">-- get new value</span></span><br><span class="line">            x = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"%5d %s"</span>, line, x)</span><br><span class="line">            send(x) <span class="comment">-- send it to consumer</span></span><br><span class="line">            line = line + <span class="number">1</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">consumer</span> <span class="params">(prod)</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> x = receive(prod) <span class="comment">-- get new value</span></span><br><span class="line">        <span class="built_in">io</span>.<span class="built_in">write</span>(x, <span class="string">"\n"</span>) <span class="comment">-- consume new value</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">consumer(filter(producer()))</span><br></pre></td></tr></table></figure>
<h3 id="9-3-iterator-è¿­ä»£å™¨"><a class="header-anchor" href="#9-3-iterator-è¿­ä»£å™¨">Â¶</a>9.3 iterator è¿­ä»£å™¨</h3>
<p>origin:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">permgen</span> <span class="params">(a, n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        printResult(a)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">for</span> i=<span class="number">1</span>,n <span class="keyword">do</span></span><br><span class="line">            <span class="comment">-- put i-th element as the last one</span></span><br><span class="line">            a[n], a[i] = a[i], a[n]</span><br><span class="line">            <span class="comment">-- generate all permutations of the other elements</span></span><br><span class="line">            permgen(a, n - <span class="number">1</span>)</span><br><span class="line">            <span class="comment">-- restore i-th element</span></span><br><span class="line">            a[n], a[i] = a[i], a[n]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printResult</span> <span class="params">(a)</span></span></span><br><span class="line">   <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">       <span class="built_in">io</span>.<span class="built_in">write</span>(v, <span class="string">" "</span>)</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line">   <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">"\n"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">permgen (&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;, <span class="number">4</span>)</span><br></pre></td></tr></table></figure>
<p>example:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">permgen</span> <span class="params">(a, n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">       coroutine.<span class="built_in">yield</span>(a)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">for</span> i=<span class="number">1</span>,n <span class="keyword">do</span></span><br><span class="line">            <span class="comment">-- put i-th element as the last one</span></span><br><span class="line">            a[n], a[i] = a[i], a[n]</span><br><span class="line">            <span class="comment">-- generate all permutations of the other elements</span></span><br><span class="line">            permgen(a, n - <span class="number">1</span>)</span><br><span class="line">            <span class="comment">-- restore i-th element</span></span><br><span class="line">            a[n], a[i] = a[i], a[n]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">perm</span> <span class="params">(a)</span></span></span><br><span class="line">    <span class="keyword">local</span> n = <span class="built_in">table</span>.<span class="built_in">getn</span>(a)</span><br><span class="line">    <span class="keyword">local</span> co = coroutine.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span> permgen(a, n) <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="comment">-- iterator</span></span><br><span class="line">        <span class="keyword">local</span> code, res = coroutine.<span class="built_in">resume</span>(co)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printResult</span> <span class="params">(a)</span></span></span><br><span class="line">    <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">io</span>.<span class="built_in">write</span>(v, <span class="string">" "</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">"\n"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> perm&#123;<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>&#125; <span class="keyword">do</span></span><br><span class="line">   printResult(p)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>coroutine.wrap:<em>wrap åˆ›å»ºä¸€ä¸ªååŒç¨‹åº;ä¸åŒçš„æ˜¯ wrap ä¸è¿”å›å åŒæœ¬èº«ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œå½“è¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨æ—¶å°† resume ååŒ</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">perm</span> <span class="params">(a)</span></span></span><br><span class="line">   <span class="keyword">local</span> n = <span class="built_in">table</span>.<span class="built_in">getn</span>(a)</span><br><span class="line">   <span class="keyword">return</span> coroutine.<span class="built_in">wrap</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span> permgen(a, n) <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="9-4-pre-emptive-multi-thread-éæŠ¢å å¼å¤šçº¿ç¨‹"><a class="header-anchor" href="#9-4-pre-emptive-multi-thread-éæŠ¢å å¼å¤šçº¿ç¨‹">Â¶</a>9.4 pre-emptive multi thread éæŠ¢å å¼å¤šçº¿ç¨‹</h3>
<p>note:<em>ååŒæ˜¯éæŠ¢å å¼çš„ã€‚ å½“ä¸€ä¸ªååŒæ­£åœ¨è¿è¡Œæ—¶ï¼Œä¸èƒ½åœ¨å¤–éƒ¨ç»ˆæ­¢ä»–ã€‚åªèƒ½é€šè¿‡æ˜¾ç¤ºçš„è°ƒç”¨ yield æŒ‚èµ·ä»–çš„æ‰§è¡Œã€‚</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ååŒæ˜¯éæŠ¢å å¼çš„ã€‚ å½“ä¸€ä¸ªååŒæ­£åœ¨è¿è¡Œæ—¶ï¼Œä¸èƒ½åœ¨å¤–éƒ¨ç»ˆæ­¢ä»–ã€‚åªèƒ½é€šè¿‡æ˜¾ç¤ºçš„è°ƒç”¨ <span class="built_in">yield</span> æŒ‚èµ·ä»–çš„æ‰§è¡Œã€‚</span><br></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>table &amp; object</p>
</blockquote>
<h2 id="11-datastruct"><a class="header-anchor" href="#11-datastruct">Â¶</a>11. datastruct</h2>
<h3 id="11-1-array-æ•°ç»„"><a class="header-anchor" href="#11-1-array-æ•°ç»„">Â¶</a>11.1 array æ•°ç»„</h3>
<h3 id="11-2-matrix-multidimensional-array-é˜µ-å¤šç»´æ•°ç»„"><a class="header-anchor" href="#11-2-matrix-multidimensional-array-é˜µ-å¤šç»´æ•°ç»„">Â¶</a>11.2 matrix &amp; multidimensional array é˜µ å¤šç»´æ•°ç»„</h3>
<p>ç¨€ç–çŸ©é˜µ:<em>æŒ‡çŸ©é˜µçš„å¤§éƒ¨åˆ†å…ƒç´ éƒ½ä¸ºç©ºæˆ–è€… 0 çš„çŸ©é˜µã€‚</em></p>
<h3 id="11-3-linked-list-sé“¾è¡¨"><a class="header-anchor" href="#11-3-linked-list-sé“¾è¡¨">Â¶</a>11.3 linked list sé“¾è¡¨</h3>
<h3 id="11-4-queen-dique-sé˜Ÿåˆ—-åŒç«¯é˜Ÿåˆ—"><a class="header-anchor" href="#11-4-queen-dique-sé˜Ÿåˆ—-åŒç«¯é˜Ÿåˆ—">Â¶</a>11.4 queen &amp; dique sé˜Ÿåˆ— åŒç«¯é˜Ÿåˆ—</h3>
<p>note:<em>Lua çš„ table åº“æä¾›çš„ insert å’Œ remove æ“ä½œæ¥å®ç°é˜Ÿåˆ—ï¼Œä½†è¿™ç§æ–¹å¼ å®ç°çš„é˜Ÿåˆ—é’ˆå¯¹<strong>å¤§æ•°æ®é‡</strong>æ—¶æ•ˆç‡å¤ªä½</em></p>
<p>note:<em>æœ‰æ•ˆçš„æ–¹å¼æ˜¯ä½¿ç”¨ä¸¤ä¸ªç´¢å¼•ä¸‹æ ‡ï¼Œä¸€ä¸ªè¡¨ç¤ºç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¦ä¸€ä¸ªè¡¨ç¤ºæœ€åä¸€ä¸ªå…ƒç´ ã€‚</em></p>
<h3 id="11-5-set-package-é›†åˆ-åŒ…"><a class="header-anchor" href="#11-5-set-package-é›†åˆ-åŒ…">Â¶</a>11.5 set &amp; package é›†åˆ åŒ…</h3>
<h3 id="11-6-string-buffer-å­—ç¬¦ä¸²ç¼“å†²"><a class="header-anchor" href="#11-6-string-buffer-å­—ç¬¦ä¸²ç¼“å†²">Â¶</a>11.6 string buffer å­—ç¬¦ä¸²ç¼“å†²</h3>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- WARNING: bad code ahead!!</span></span><br><span class="line"><span class="keyword">local</span> buff = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>() <span class="keyword">do</span></span><br><span class="line">   buff = buff .. line .. <span class="string">"\n"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>å‡å®šåœ¨ loop ä¸­é—´ï¼Œbuff å·²ç»æ˜¯ä¸€ä¸ª 50KB çš„å­—ç¬¦ä¸²ï¼Œ æ¯ä¸€è¡Œçš„å¤§å°ä¸º 20bytesï¼Œ<br>
å½“ Lua æ‰§è¡Œ <code>buff..line..&quot;\n&quot;</code>æ—¶ï¼Œå¥¹åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å¤§å°ä¸º 50,020 bytesï¼Œå¹¶ä¸”ä» buff ä¸­å°† 50KB çš„å­—ç¬¦ä¸²æ‹·è´åˆ°æ–°ä¸²ä¸­ã€‚<br>
è€çš„å­—ç¬¦ä¸²å˜æˆäº†åƒåœ¾æ•°æ®ï¼Œä¸¤è½®å¾ªç¯ä¹‹åï¼Œå°†æœ‰ä¸¤ä¸ªè€ä¸²åŒ…å«è¶…è¿‡ 100KB çš„åƒåœ¾ æ•°æ®ã€‚è¿™ä¸ªæ—¶å€™ Lua ä¼šåšå‡ºæ­£ç¡®çš„å†³å®šï¼Œè¿›è¡Œä»–çš„åƒåœ¾æ”¶é›†å¹¶é‡Šæ”¾ 100KB çš„å†…å­˜ã€‚é—®é¢˜ åœ¨äºæ¯ä¸¤æ¬¡å¾ªç¯ Lua å°±è¦è¿›è¡Œä¸€æ¬¡åƒåœ¾æ”¶é›†ï¼Œè¯»å–æ•´ä¸ªæ–‡ä»¶éœ€è¦è¿›è¡Œ 200 æ¬¡åƒåœ¾æ”¶é›†ã€‚ å¹¶ä¸”å®ƒçš„å†…å­˜ä½¿ç”¨æ˜¯æ•´ä¸ªæ–‡ä»¶å¤§å°çš„ä¸‰å€ã€‚</p>
<p>note:<em>å…¶å®ƒçš„é‡‡ç”¨åƒåœ¾æ”¶é›†ç®—æ³•çš„å¹¶ä¸”å­—ç¬¦ä¸²ä¸å¯å˜çš„è¯­è¨€ ä¹Ÿéƒ½å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚Java ä¸“é—¨æä¾› StringBuffer æ¥æ”¹å–„è¿™ç§æƒ…å†µã€‚</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newStack</span> <span class="params">()</span></span></span><br><span class="line">   <span class="keyword">return</span> &#123;<span class="string">""</span>&#125;   <span class="comment">-- starts with an empty string</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addString</span> <span class="params">(stack, s)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(stack,s) <span class="comment">--push's'intothethestack for i=table.getn(stack)-1, 1, -1 do</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">string</span>.<span class="built_in">len</span>(stack[i]) &gt; <span class="built_in">string</span>.<span class="built_in">len</span>(stack[i+<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    stack[i] = stack[i] .. stack[i+<span class="number">1</span>]</span><br><span class="line">    stack[i+<span class="number">1</span>] = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> s = newStack()</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>() <span class="keyword">do</span></span><br><span class="line">   addString(s, line .. <span class="string">"\n"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">s = toString(s)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æˆ–è€…</span></span><br><span class="line"><span class="keyword">local</span> t = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>() <span class="keyword">do</span></span><br><span class="line">   <span class="built_in">table</span>.<span class="built_in">insert</span>(t, line)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">s = <span class="built_in">table</span>.<span class="built_in">concat</span>(t, <span class="string">"\n"</span>) .. <span class="string">"\n"</span></span><br></pre></td></tr></table></figure>
<h2 id="12-data-file-storage-Persistence-æ•°æ®æ–‡ä»¶ä¸æŒä¹…åŒ–"><a class="header-anchor" href="#12-data-file-storage-Persistence-æ•°æ®æ–‡ä»¶ä¸æŒä¹…åŒ–">Â¶</a>12. data file storage &amp; Persistence æ•°æ®æ–‡ä»¶ä¸æŒä¹…åŒ–</h2>
<blockquote>
<p>string.format(â€œ%qâ€, o)</p>
</blockquote>
<h2 id="13-metatables-metamethods"><a class="header-anchor" href="#13-metatables-metamethods">Â¶</a>13. metatables metamethods</h2>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t1 = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(t, t1)</span><br><span class="line"><span class="built_in">assert</span>(<span class="built_in">getmetatable</span>(t) == t1)</span><br></pre></td></tr></table></figure>
<p>note:<em>ä¸€ç»„ç›¸å…³çš„è¡¨å¯ä»¥å…±äº«ä¸€ä¸ª metatable (æè¿°ä»–ä»¬å…±åŒçš„è¡Œä¸º)ã€‚ä¸€ä¸ªè¡¨ä¹Ÿå¯ä»¥æ˜¯<strong>è‡ªèº«</strong>çš„ metatable(æè¿°å…¶ç§æœ‰è¡Œä¸º)ã€‚</em></p>
<h3 id="13-1-arithmetic-operation-metamethods-ç®—æœ¯è¿ç®—çš„-matamethods"><a class="header-anchor" href="#13-1-arithmetic-operation-metamethods-ç®—æœ¯è¿ç®—çš„-matamethods">Â¶</a>13.1  arithmetic operation metamethods ç®—æœ¯è¿ç®—çš„ matamethods</h3>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">Set = &#123;&#125;</span><br><span class="line">Set.mt = &#123;&#125; <span class="comment">-- metatable for sets</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.new</span> <span class="params">(t)</span></span></span><br><span class="line">   <span class="keyword">local</span> set = &#123;&#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(set, Set.mt)</span><br><span class="line">   <span class="keyword">for</span> _, l <span class="keyword">in</span> <span class="built_in">ipairs</span>(t) <span class="keyword">do</span> set[l] = <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> set</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.union</span> <span class="params">(a,b)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">getmetatable</span>(a) ~= Set.mt <span class="keyword">or</span> <span class="built_in">getmetatable</span>(b) ~= Set.mt <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">error</span>(<span class="string">"attempt to `add' a set with a non-set value"</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">local</span> res = Set.new&#123;&#125;</span><br><span class="line">   <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span> res[k] = <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(b) <span class="keyword">do</span> res[k] = <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> res</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.intersection</span> <span class="params">(a,b)</span></span></span><br><span class="line">   <span class="keyword">local</span> res = Set.new&#123;&#125;</span><br><span class="line">   <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span></span><br><span class="line">res[k] = b[k]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> res</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.tostring</span> <span class="params">(set)</span></span></span><br><span class="line">   <span class="keyword">local</span> s = <span class="string">"&#123;"</span></span><br><span class="line">   <span class="keyword">local</span> sep = <span class="string">""</span></span><br><span class="line">   <span class="keyword">for</span> e <span class="keyword">in</span> <span class="built_in">pairs</span>(set) <span class="keyword">do</span></span><br><span class="line">s = s .. sep .. e</span><br><span class="line">sep = <span class="string">", "</span> <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> s .. <span class="string">"&#125;"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.print</span> <span class="params">(s)</span></span></span><br><span class="line">   <span class="built_in">print</span>(Set.<span class="built_in">tostring</span>(s))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">s1 = Set.new&#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">50</span>&#125;</span><br><span class="line">s2 = Set.new&#123;<span class="number">30</span>, <span class="number">1</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">getmetatable</span>(s1))     <span class="comment">--&gt; table: 00672B60</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">getmetatable</span>(s2))     <span class="comment">--&gt; table: 00672B60</span></span><br><span class="line"></span><br><span class="line">Set.mt.<span class="built_in">__add</span> = Set.union</span><br><span class="line"></span><br><span class="line">s3 = s1 + s2</span><br><span class="line">Set.<span class="built_in">print</span>(s3) <span class="comment">--&gt; &#123;1, 10, 20, 30, 50&#125;</span></span><br><span class="line"></span><br><span class="line">Set.mt.<span class="built_in">__mul</span> = Set.intersection</span><br><span class="line">Set.<span class="built_in">print</span>((s1 + s2)*s1)     <span class="comment">--&gt; &#123;10, 20, 30, 50&#125;</span></span><br></pre></td></tr></table></figure>
<p>note:<em>é™¤äº†__add,__mul, è¿˜æœ‰__sub(å‡),__div(é™¤),__unm(è´Ÿ),__pow(å¹‚)ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰__concat å®šä¹‰è¿æ¥è¡Œä¸ºã€‚</em></p>
<p>å¦‚æœä¸¤ä¸ªæ“ä½œæ•°æœ‰ä¸åŒçš„ metatable, Lua é€‰æ‹© metamethod çš„åŸåˆ™:</p>
<ul>
<li>å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°å­˜åœ¨å¸¦æœ‰__add åŸŸçš„ metatableï¼ŒLua ä½¿ç”¨å®ƒä½œä¸º metamethodï¼Œå’Œç¬¬äºŒä¸ªå‚æ•°æ— å…³;</li>
<li>å¦åˆ™ç¬¬äºŒä¸ªå‚æ•°å­˜åœ¨å¸¦æœ‰__add åŸŸçš„ metatableï¼ŒLua ä½¿ç”¨å®ƒä½œä¸º metamethod å¦åˆ™æŠ¥é”™ã€‚</li>
</ul>
<h3 id="13-2-relational-operation-metamethods-å…³ç³»è¿ç®—çš„-metamethods"><a class="header-anchor" href="#13-2-relational-operation-metamethods-å…³ç³»è¿ç®—çš„-metamethods">Â¶</a>13.2 relational operation metamethods å…³ç³»è¿ç®—çš„ metamethods</h3>
<p>note:<em>__eqï¼ˆç­‰äºï¼‰ï¼Œ__ltï¼ˆå°äºï¼‰ ï¼Œå’Œ__leï¼ˆå°äºç­‰äº)</em></p>
<p>note:<em><code>å½“æˆ‘ä»¬é‡åˆ°ååºï¼ˆpartial orderï¼‰æƒ…å†µï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„å…ƒç´ éƒ½å¯ä»¥æ­£ç¡®çš„è¢«æ’åºæƒ…å†µã€‚ä¾‹å¦‚ï¼Œåœ¨å¤§å¤šæ•°æœºå™¨ä¸Šæµ®ç‚¹æ•°ä¸èƒ½è¢«æ’åºï¼Œå› ä¸ºä»–çš„å€¼ä¸æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆNot a Number å³ NaNï¼‰</code></em></p>
<p>note:<em>æ ¹æ® IEEE 754 çš„æ ‡å‡†ï¼ŒNaN è¡¨ç¤ºä¸€ä¸ªæœªå®šä¹‰çš„å€¼ï¼Œæ¯”å¦‚ 0/0 çš„ç»“æœã€‚è¯¥æ ‡å‡†æŒ‡å‡ºä»»ä½•æ¶‰åŠåˆ° NaN æ¯”è¾ƒçš„ç»“æœéƒ½åº”ä¸º falseã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒNaN &lt;= x æ€»æ˜¯ falseï¼Œx &lt; NaN ä¹Ÿæ€»æ˜¯ falseã€‚è¿™æ ·ä¸€æ¥ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ a &lt;= b è½¬æ¢ä¸º not (b &lt; a)å°±ä¸å†æ­£ç¡®äº†ã€‚</em></p>
<p>note:<em>&lt;=ä»£è¡¨é›†åˆçš„åŒ…å«ï¼ša &lt;= b è¡¨ç¤ºé›†åˆ a æ˜¯é›†åˆ b çš„å­é›†ã€‚è¿™ç§æ„ä¹‰ä¸‹ï¼Œå¯èƒ½ a &lt;= b å’Œ b &lt; a éƒ½æ˜¯ falseï¼›</em></p>
<p>note:<em>å…³ç³»å…ƒç®—çš„ metamethods ä¸æ”¯æŒæ··åˆç±»å‹è¿ç®—</em></p>
<p>note:<em>è¯•å›¾æ¯”è¾ƒä¸€ä¸ªå­—ç¬¦ä¸²å’Œä¸€ä¸ªæ•°å­—ï¼ŒLua å°†æŠ›å‡ºé”™è¯¯.ç›¸ä¼¼çš„ï¼Œå¦‚æœä½ è¯•å›¾æ¯”è¾ƒä¸¤ä¸ªå¸¦æœ‰ä¸åŒ metamethods çš„å¯¹è±¡ï¼ŒLua ä¹Ÿå°†æŠ›å‡ºé”™è¯¯ã€‚</em></p>
<p>note:<em>ä½†ç›¸ç­‰æ¯”è¾ƒä»æ¥ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå¦‚æœä¸¤ä¸ªå¯¹è±¡æœ‰ä¸åŒçš„ metamethodï¼Œæ¯”è¾ƒçš„ç»“æœä¸ºfalseï¼Œç”šè‡³å¯èƒ½ä¸ä¼šè°ƒç”¨ metamethod.</em></p>
<p>note:<em>ä»…å½“ä¸¤ä¸ªæœ‰å…±åŒçš„ metamethod çš„å¯¹è±¡è¿›è¡Œç›¸ç­‰æ¯”è¾ƒçš„æ—¶å€™ï¼ŒLua æ‰ä¼šè°ƒç”¨å¯¹åº”çš„ metamethodã€‚</em></p>
<h3 id="13-3-others-metamethods"><a class="header-anchor" href="#13-3-others-metamethods">Â¶</a>13.3 others metamethods</h3>
<p>note:<em><code>print</code> å‡½æ•°æ€»æ˜¯è°ƒç”¨ tostring æ¥æ ¼å¼åŒ–å®ƒçš„è¾“å‡º, tostring ä¼šé¦–å…ˆæ£€æŸ¥å¯¹è±¡æ˜¯å¦å­˜åœ¨ä¸€ä¸ªå¸¦æœ‰<code>__tostring</code>åŸŸçš„ metatableã€‚</em></p>
<p>å‡å®šä½ æƒ³ä¿æŠ¤ä½ çš„é›†åˆä½¿å…¶ä½¿ç”¨è€…æ—¢çœ‹ä¸åˆ°ä¹Ÿä¸èƒ½ä¿®æ”¹ metatablesã€‚<br>
å¦‚æœä½ å¯¹ metatable è®¾ç½®äº†__metatable çš„å€¼ï¼Œ getmetatable å°†è¿”å›è¿™ä¸ªåŸŸçš„å€¼ï¼Œè€Œè°ƒç”¨ setmetatableå°†ä¼šå‡ºé”™ï¼š</p>
<blockquote>
<p><a href="http://Set.mt" target="_blank" rel="noopener">Set.mt</a>.__metatable = â€œnot your businessâ€</p>
</blockquote>
<h3 id="13-4-table-relative-metamethods-è¡¨ç›¸å…³-metamethods"><a class="header-anchor" href="#13-4-table-relative-metamethods-è¡¨ç›¸å…³-metamethods">Â¶</a>13.4 table relative metamethods è¡¨ç›¸å…³ metamethods</h3>
<h4 id="13-4-1-The-index-Metamethod"><a class="header-anchor" href="#13-4-1-The-index-Metamethod">Â¶</a>13.4.1 The __index Metamethod</h4>
<p>note:<em>å½“æˆ‘ä»¬è®¿é—®ä¸€ä¸ªè¡¨çš„ä¸å­˜åœ¨çš„åŸŸï¼Œè¿™ç§è®¿é—®è§¦å‘ lua è§£é‡Šå™¨å»æŸ¥æ‰¾__index metamethod</em><br>
note:<em>__index metamethod ä¸éœ€è¦éæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä»–ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè¡¨ã€‚</em></p>
<ul>
<li>å®ƒæ˜¯ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼ŒLua å°† table å’Œç¼ºå°‘çš„åŸŸä½œä¸ºå‚æ•°è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼›</li>
<li>ä»–æ˜¯ä¸€ä¸ªè¡¨çš„æ—¶å€™ï¼ŒLua å°†åœ¨è¿™ä¸ªè¡¨ä¸­çœ‹æ˜¯å¦æœ‰ç¼ºå°‘çš„åŸŸã€‚</li>
</ul>
<h4 id="13-4-2-The-newindex-Metamethod"><a class="header-anchor" href="#13-4-2-The-newindex-Metamethod">Â¶</a>13.4.2 The __newindex Metamethod</h4>
<p>note:<em>å½“ä½ ç»™è¡¨çš„ä¸€ä¸ªç¼ºå°‘çš„åŸŸèµ‹å€¼ï¼Œè§£é‡Šå™¨å°±ä¼šæŸ¥æ‰¾__newindex metamethod,å¦‚æœå­˜åœ¨åˆ™è°ƒç”¨è¿™ä¸ªå‡½æ•°è€Œä¸è¿›è¡Œèµ‹å€¼æ“ä½œã€‚</em></p>
<p>è°ƒç”¨rawset(t,k,v)ä¸æ‰ç”¨ä»»ä½• metamethod å¯¹è¡¨ t çš„ k åŸŸèµ‹å€¼ä¸º vã€‚</p>
<h4 id="13-4-3-table-default-value-æœ‰é»˜è®¤å€¼çš„è¡¨"><a class="header-anchor" href="#13-4-3-table-default-value-æœ‰é»˜è®¤å€¼çš„è¡¨">Â¶</a>13.4.3 table default value æœ‰é»˜è®¤å€¼çš„è¡¨</h4>
<h4 id="13-4-4-table-monitor-ç›‘æ§è¡¨"><a class="header-anchor" href="#13-4-4-table-monitor-ç›‘æ§è¡¨">Â¶</a>13.4.4 table monitor ç›‘æ§è¡¨</h4>
<p>å•è¡¨ç›‘æ§</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">t = &#123;&#125; <span class="comment">-- original table (created somewhere)</span></span><br><span class="line"><span class="comment">-- keep a private access to original table</span></span><br><span class="line"><span class="keyword">local</span> _t = t</span><br><span class="line"><span class="comment">-- create proxy</span></span><br><span class="line">t = &#123;&#125;</span><br><span class="line"><span class="comment">-- create metatable</span></span><br><span class="line"><span class="keyword">local</span> mt = &#123;</span><br><span class="line"><span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"*access to element "</span> .. <span class="built_in">tostring</span>(k))</span><br><span class="line">    <span class="keyword">return</span> _t[k] <span class="comment">-- access the original table</span></span><br><span class="line"><span class="keyword">end</span>,</span><br><span class="line"><span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"*update of element "</span> .. <span class="built_in">tostring</span>(k) ..</span><br><span class="line">    <span class="string">" to "</span> .. <span class="built_in">tostring</span>(v))</span><br><span class="line">    _t[k] = v <span class="comment">-- update original table</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(t, mt)</span><br></pre></td></tr></table></figure>
<p>note:<em>æ³¨æ„ï¼šä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¸ªè®¾è®¡ä¸å…è®¸æˆ‘ä»¬éå†è¡¨ã€‚</em></p>
<p>å¤šè¡¨ç›‘æ§</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- create private index</span></span><br><span class="line"><span class="keyword">local</span> index = &#123;&#125;</span><br><span class="line"><span class="comment">-- create metatable</span></span><br><span class="line"><span class="keyword">local</span> mt = &#123;</span><br><span class="line">    <span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k)</span></span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"*access to element "</span> .. <span class="built_in">tostring</span>(k))</span><br><span class="line">        <span class="keyword">return</span> t[index][k] <span class="comment">-- access the original table</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"*update of element "</span> .. <span class="built_in">tostring</span>(k) .. <span class="string">" to "</span>.. <span class="built_in">tostring</span>(v))</span><br><span class="line">        t[index][k] = v <span class="comment">-- update original table</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span> <span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    proxy[index] = t</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h4 id="13-4-5-readonly-table-åªè¯»è¡¨"><a class="header-anchor" href="#13-4-5-readonly-table-åªè¯»è¡¨">Â¶</a>13.4.5 readonly table åªè¯»è¡¨</h4>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readOnly</span> <span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> mt = &#123; <span class="comment">-- create metatable</span></span><br><span class="line">        <span class="built_in">__index</span> = t,</span><br><span class="line">        <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">            <span class="built_in">error</span>(<span class="string">"attempt to update a read-only table"</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">days = readOnly&#123;<span class="string">"Sunday"</span>, <span class="string">"Monday"</span>, <span class="string">"Tuesday"</span>, <span class="string">"Wednesday"</span>,<span class="string">"Thursday"</span>, <span class="string">"Friday"</span>, <span class="string">"Saturday"</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="14-environment-ç¯å¢ƒ"><a class="header-anchor" href="#14-environment-ç¯å¢ƒ">Â¶</a>14. environment ç¯å¢ƒ</h2>
<h3 id="14-1-dynamic-access-global-value-ä½¿ç”¨åŠ¨æ€åå­—è®¿é—®å…¨å±€å˜é‡"><a class="header-anchor" href="#14-1-dynamic-access-global-value-ä½¿ç”¨åŠ¨æ€åå­—è®¿é—®å…¨å±€å˜é‡">Â¶</a>14.1 dynamic access global value ä½¿ç”¨åŠ¨æ€åå­—è®¿é—®å…¨å±€å˜é‡</h3>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getfield</span> <span class="params">(f)</span></span></span><br><span class="line">    <span class="keyword">local</span> v = <span class="built_in">_G</span> <span class="comment">-- start with the table of globals</span></span><br><span class="line">    <span class="keyword">for</span> w <span class="keyword">in</span> <span class="built_in">string</span>.<span class="built_in">gfind</span>(f, <span class="string">"[%w_]+"</span>) <span class="keyword">do</span></span><br><span class="line">        v = v[w]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> v</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setfield</span> <span class="params">(f, v)</span></span></span><br><span class="line">    <span class="keyword">local</span> t = <span class="built_in">_G</span> <span class="comment">-- start with the table of globals</span></span><br><span class="line">    <span class="keyword">for</span> w, d <span class="keyword">in</span> <span class="built_in">string</span>.<span class="built_in">gfind</span>(f, <span class="string">"([%w_]+)(.?)"</span>) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> d == <span class="string">"."</span> <span class="keyword">then</span> <span class="comment">-- not last field?</span></span><br><span class="line">            t[w] = t[w] <span class="keyword">or</span> &#123;&#125; <span class="comment">-- create table if absent</span></span><br><span class="line">            t = t[w] <span class="comment">-- get the table</span></span><br><span class="line">        <span class="keyword">else</span> <span class="comment">-- last field</span></span><br><span class="line">            t[w] = v <span class="comment">-- do the assignment</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="14-2-delcare-global-value-å£°æ˜å…¨å±€å˜é‡"><a class="header-anchor" href="#14-2-delcare-global-value-å£°æ˜å…¨å±€å˜é‡">Â¶</a>14.2 delcare global value å£°æ˜å…¨å±€å˜é‡</h3>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> declaredNames = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">declare</span> <span class="params">(name, initval)</span></span></span><br><span class="line">    <span class="built_in">rawset</span>(<span class="built_in">_G</span>, name, initval)</span><br><span class="line">    declaredNames[name] = <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(<span class="built_in">_G</span>, &#123;</span><br><span class="line">    <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t, n, v)</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> declaredNames[n] <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"attempt to write to undeclared var. "</span>..n, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">rawset</span>(t, n, v) <span class="comment">-- do the actual set</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    <span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(_, n)</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> declaredNames[n] <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"attempt to read undeclared var. "</span>..n, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="14-3-un-global-environment-éå…¨å±€çš„ç¯å¢ƒ"><a class="header-anchor" href="#14-3-un-global-environment-éå…¨å±€çš„ç¯å¢ƒ">Â¶</a>14.3 un-global environment éå…¨å±€çš„ç¯å¢ƒ</h3>
<p>note:<em>å½“ä½ å®‰è£…ä¸€ä¸ª metatable å»æ§åˆ¶å…¨å±€è®¿é—®æ—¶ï¼Œä½ çš„æ•´ä¸ªç¨‹åºéƒ½å¿…é¡»éµå¾ªåŒä¸€ä¸ªæŒ‡å¯¼æ–¹é’ˆã€‚å¦‚æœä½ æƒ³ä½¿ç”¨æ ‡å‡†åº“ï¼Œæ ‡å‡†åº“ä¸­å¯èƒ½ä½¿ç”¨åˆ°æ²¡æœ‰å£°æ˜çš„å…¨å±€å˜é‡ï¼Œä½ å°†ç¢°åˆ°åè¿ã€‚</em></p>
<p>Setfenv:<em>æ¥å—å‡½æ•°å’Œæ–°çš„ç¯å¢ƒä½œä¸ºå‚æ•°ã€‚é™¤äº†ä½¿ç”¨å‡½æ•°æœ¬èº«ï¼Œè¿˜å¯ä»¥æŒ‡å®šä¸€ä¸ªæ•°å­—è¡¨ç¤ºæ ˆé¡¶çš„æ´»åŠ¨å‡½æ•°ã€‚æ•°å­— 1 ä»£è¡¨å½“å‰å‡½æ•°ï¼Œæ•°å­— 2 ä»£è¡¨è°ƒç”¨å½“å‰å‡½æ•°çš„å‡½æ•°</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span> <span class="comment">-- create a global variable</span></span><br><span class="line"><span class="comment">-- change current environment to a new empty table</span></span><br><span class="line"><span class="built_in">setfenv</span>(<span class="number">1</span>, &#123;&#125;)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br></pre></td></tr></table></figure>
<p>å¿…é¡»åœ¨å•ç‹¬çš„ chunk å†…è¿è¡Œè¿™æ®µä»£ç ï¼Œå¦‚æœä½ åœ¨äº¤äº’æ¨¡å¼é€è¡Œè¿è¡Œä»–ï¼Œæ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ªä¸åŒçš„å‡½æ•°ï¼Œè°ƒç”¨ setfenv åªä¼šå½±å“ä»–è‡ªå·±çš„é‚£ä¸€è¡Œ</p>
<p>å°è£…: populate</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span> <span class="comment">-- create a global variable</span></span><br><span class="line"><span class="comment">-- change current environment</span></span><br><span class="line"><span class="built_in">setfenv</span>(<span class="number">1</span>, &#123;<span class="built_in">_G</span> = <span class="built_in">_G</span>&#125;)</span><br><span class="line"><span class="built_in">_G</span>.<span class="built_in">print</span>(a) <span class="comment">--&gt; nil</span></span><br><span class="line"><span class="built_in">_G</span>.<span class="built_in">print</span>(<span class="built_in">_G</span>.a) <span class="comment">--&gt; 1</span></span><br></pre></td></tr></table></figure>
<p>ç»§æ‰¿å°è£…</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span> <span class="comment">-- create a global variable</span></span><br><span class="line"><span class="comment">-- change current environment</span></span><br><span class="line"><span class="built_in">setfenv</span>(<span class="number">1</span>, &#123;<span class="built_in">_G</span> = <span class="built_in">_G</span>&#125;)</span><br><span class="line"><span class="built_in">_G</span>.<span class="built_in">print</span>(a) <span class="comment">--&gt; nil</span></span><br><span class="line"><span class="built_in">_G</span>.<span class="built_in">print</span>(<span class="built_in">_G</span>.a) <span class="comment">--&gt; 1</span></span><br></pre></td></tr></table></figure>
<p>note:<em>å½“ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°æ—¶ï¼Œä»–ä»åˆ›å»ºä»–çš„å‡½æ•°ç»§æ‰¿äº†ç¯å¢ƒå˜é‡</em><br>
note:<em>å¦‚æœä¸€ä¸ªchunk æ”¹å˜äº†ä»–è‡ªå·±çš„ç¯å¢ƒï¼Œè¿™ä¸ª chunk æ‰€æœ‰åœ¨æ”¹å˜ä¹‹åå®šä¹‰çš„å‡½æ•°éƒ½å…±äº«ç›¸åŒçš„ç¯å¢ƒï¼Œéƒ½ä¼šå—åˆ°å½±å“ã€‚è¿™å¯¹åˆ›å»º<strong>å‘½åç©ºé—´</strong>æ˜¯éå¸¸æœ‰ç”¨çš„æœºåˆ¶</em></p>
<h2 id="15-package"><a class="header-anchor" href="#15-package">Â¶</a>15 package</h2>
<p>note:<em>å¤§å¤šæ•°è¯­è¨€ä¸­ï¼Œpackages ä¸æ˜¯<strong>ç¬¬ä¸€ç±»å€¼(first-class values)</strong>ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œä»–ä»¬ä¸èƒ½å­˜å‚¨åœ¨å˜é‡é‡Œï¼Œä¸èƒ½ä½œä¸ºå‡½æ•°å‚æ•°ã€‚ã€‚ã€‚ ï¼‰</em></p>
<ul>
<li>å¯¹æ¯ä¸€ä¸ªå‡½æ•°å®šä¹‰éƒ½å¿…é¡»æ˜¾ç¤ºçš„åœ¨å‰é¢åŠ ä¸ŠåŒ…çš„åç§°ã€‚</li>
<li>åŒä¸€åŒ…å†…çš„å‡½æ•°<code>ç›¸äº’è°ƒç”¨</code>å¿…é¡»åœ¨è¢«è°ƒç”¨å‡½æ•°å‰<strong>æŒ‡å®šåŒ…å</strong>ã€‚</li>
</ul>
<p>ç¼ºç‚¹:</p>
<ul>
<li><em>ä¿®æ”¹å‡½æ•°çš„çŠ¶æ€(å…¬æœ‰å˜æˆç§æœ‰æˆ–è€…ç§æœ‰å˜æˆå…¬æœ‰)æˆ‘ä»¬å¿…é¡»ä¿®æ”¹å‡½æ•°å¾—<strong>è°ƒç”¨æ–¹å¼</strong>ã€‚</em></li>
<li><em>è®¿é—®åŒä¸€ä¸ªpackage å†…çš„å…¶ä»–å…¬æœ‰çš„å®ä½“å†™æ³•å†—ä½™ï¼Œå¿…é¡»åŠ ä¸Šå‰ç¼€ P.ã€‚</em></li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">checkComplex</span> <span class="params">(c)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ((<span class="built_in">type</span>(c) == <span class="string">"table"</span>) <span class="keyword">and</span> <span class="built_in">tonumber</span>(c.r) <span class="keyword">and</span> <span class="built_in">tonumber</span>(c.i)) <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">error</span>(<span class="string">"bad complex number"</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">new</span> <span class="params">(r, i)</span></span> <span class="keyword">return</span> &#123;r=r, i=i&#125; <span class="keyword">end</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span> <span class="params">(c1, c2)</span></span></span><br><span class="line">    checkComplex(c1);</span><br><span class="line">    checkComplex(c2);</span><br><span class="line">    <span class="keyword">return</span> new(c1.r + c2.r, c1.i + c2.i)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ—è¡¨æ”¾åœ¨åé¢ å› ä¸ºå¿…é¡»é¦–å…ˆå®šä¹‰å±€éƒ¨å‡½æ•°</span></span><br><span class="line">complex = &#123;</span><br><span class="line">    new = new,</span><br><span class="line">    add = add,</span><br><span class="line">    <span class="built_in">sub</span> = <span class="built_in">sub</span>,</span><br><span class="line">    mul = mul,</span><br><span class="line">    div = div,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="15-3-package-file"><a class="header-anchor" href="#15-3-package-file">Â¶</a>15.3 package &amp; file</h3>
<pre><code>note:*å½“ require åŠ è½½ä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªå˜é‡æ¥è¡¨ç¤ºè™šæ‹Ÿçš„æ–‡ä»¶å*

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ä¸éœ€è¦ require å°±å¯ä»¥ä½¿ç”¨ package</span></span><br><span class="line"><span class="keyword">local</span> P = &#123;&#125; <span class="comment">-- package</span></span><br><span class="line"><span class="keyword">if</span> _REQUIREDNAME == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">    complex = P</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">_G</span>[_REQUIREDNAME] = P</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

note:*æˆ‘ä»¬å¯ä»¥åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¹‹å†…å®šä¹‰å¤šä¸ª packagesï¼Œæˆ‘ä»¬éœ€è¦åšçš„åªæ˜¯å°†æ¯ä¸€ä¸ª package æ”¾åœ¨ä¸€ä¸ª **do ä»£ç å—***å†…ï¼Œè¿™æ · local å˜é‡æ‰èƒ½è¢«é™åˆ¶åœ¨é‚£ä¸ªä»£ç å—ä¸­*

è‡ªåŠ¨åŠ è½½

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> location = &#123;</span><br><span class="line">foo = <span class="string">"/usr/local/lua/lib/pack1_1.lua"</span>,</span><br><span class="line">goo = <span class="string">"/usr/local/lua/lib/pack1_1.lua"</span>,</span><br><span class="line">foo1 = <span class="string">"/usr/local/lua/lib/pack1_2.lua"</span>,</span><br><span class="line">goo1 = <span class="string">"/usr/local/lua/lib/pack1_3.lua"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pack1 = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(pack1, &#123;<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t, funcname)</span></span></span><br><span class="line">    <span class="keyword">local</span> file = location[funcname]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> file <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">error</span>(<span class="string">"package pack1 does not define "</span> .. funcname)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">assert</span>(<span class="built_in">loadfile</span>(file))()    <span class="comment">-- load and run definition</span></span><br><span class="line">    <span class="keyword">return</span> t[funcname]          <span class="comment">-- return the function</span></span><br><span class="line"><span class="keyword">end</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> pack1</span><br></pre></td></tr></table></figure>
</code></pre>
<h2 id="16-object-oriented-programming-é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡"><a class="header-anchor" href="#16-object-oriented-programming-é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡">Â¶</a>16 object-oriented programming é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡</h2>
<ul>
<li>
<p>ç¤ºä¾‹ä»£ç </p>
 <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Account = &#123;</span><br><span class="line">    balance=<span class="number">0</span>,</span><br><span class="line">    withdraw = <span class="function"><span class="keyword">function</span> <span class="params">(self, v)</span></span></span><br><span class="line">        self.balance = self.balance - v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Account:deposit</span> <span class="params">(v)</span></span></span><br><span class="line">    self.balance = self.balance + v</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">Account.deposit(Account, <span class="number">200.00</span>)</span><br><span class="line">Account:withdraw(<span class="number">100.00</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Account:new</span> <span class="params">(o)</span></span></span><br><span class="line">    o = o <span class="keyword">or</span> &#123;&#125; <span class="comment">-- create object if user does not provide one</span></span><br><span class="line">    <span class="built_in">setmetatable</span>(o, self)</span><br><span class="line">    self.<span class="built_in">__index</span> = self</span><br><span class="line">    <span class="keyword">return</span> o</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">a = Account:new&#123;balance = <span class="number">0</span>&#125;</span><br><span class="line">a:deposit(<span class="number">100.00</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">getmetatable</span>(a).<span class="built_in">__index</span>.deposit(a, <span class="number">100.00</span>)</span><br><span class="line">Account.deposit(a, <span class="number">100.00</span>)</span><br></pre></td></tr></table></figure>
<h3 id="16-3-multiple-inheritance-å¤šé‡ç»§æ‰¿"><a class="header-anchor" href="#16-3-multiple-inheritance-å¤šé‡ç»§æ‰¿">Â¶</a>16.3 multiple inheritance å¤šé‡ç»§æ‰¿</h3>
<pre><code> å¤šé‡ç»§æ‰¿æ„å‘³ç€ä¸€ä¸ªç±»æ‹¥æœ‰å¤šä¸ªçˆ¶ç±»
</code></pre>
<h3 id="16-4-private-ç§æœ‰æ€§"><a class="header-anchor" href="#16-4-private-ç§æœ‰æ€§">Â¶</a>16.4 private ç§æœ‰æ€§</h3>
<pre><code> é€šè¿‡é—­åŒ…å®ç°ç§æœ‰æ€§

 <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newAccount</span> <span class="params">(initialBalance)</span></span></span><br><span class="line">    <span class="keyword">local</span> self = &#123;</span><br><span class="line">        balance = initialBalance,</span><br><span class="line">        LIM = <span class="number">10000.00</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> withdraw = <span class="function"><span class="keyword">function</span> <span class="params">(v)</span></span></span><br><span class="line">    self.balance = self.balance - v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> deposit = <span class="function"><span class="keyword">function</span> <span class="params">(v)</span></span></span><br><span class="line">    self.balance = self.balance + v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> extra = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        <span class="keyword">if</span> self.balance &gt; self.LIM <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> self.balance*<span class="number">0.10</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> getBalance = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        <span class="keyword">return</span> self.balance + self.extra()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">--local getBalance = function () return self.balance end</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        withdraw = withdraw,</span><br><span class="line">        deposit = deposit,</span><br><span class="line">        getBalance = getBalance</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">acc1 = newAccount(<span class="number">100.00</span>)</span><br><span class="line">acc1.withdraw(<span class="number">40.00</span>)</span><br><span class="line"><span class="built_in">print</span>(acc1.getBalance())    <span class="comment">--&gt; 60</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h3 id="16-5-Single-Method-çš„å¯¹è±¡å®ç°æ–¹æ³•"><a class="header-anchor" href="#16-5-Single-Method-çš„å¯¹è±¡å®ç°æ–¹æ³•">Â¶</a>16.5 Single-Method çš„å¯¹è±¡å®ç°æ–¹æ³•</h3>
<pre><code> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newObject</span> <span class="params">(value)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(action, v)</span></span></span><br><span class="line">        <span class="keyword">if</span> action == <span class="string">"get"</span> <span class="keyword">then</span> <span class="keyword">return</span> value</span><br><span class="line">        <span class="keyword">elseif</span> action == <span class="string">"set"</span> <span class="keyword">then</span> value = v</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">error</span>(<span class="string">"invalid action"</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">d = newObject(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(d(<span class="string">"get"</span>)) <span class="comment">--&gt; 0</span></span><br><span class="line">d(<span class="string">"set"</span>, <span class="number">10</span>)</span><br><span class="line"><span class="built_in">print</span>(d(<span class="string">"get"</span>)) <span class="comment">--&gt; 10</span></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<h2 id="17-weak-table"><a class="header-anchor" href="#17-weak-table">Â¶</a>17 weak table</h2>
<p>ä¸€ä¸ª weak å¼•ç”¨æ˜¯æŒ‡<em>ä¸€ä¸ªä¸è¢« Lua è®¤ä¸ºæ˜¯åƒåœ¾çš„å¯¹è±¡çš„å¼•ç”¨ã€‚</em><br>
å¦‚æœä¸€ä¸ªå¯¹è±¡æ‰€æœ‰çš„å¼•ç”¨æŒ‡å‘éƒ½æ˜¯weakï¼Œå¯¹è±¡å°†è¢«æ”¶é›†ï¼Œè€Œé‚£äº› weak å¼•ç”¨å°†ä¼šè¢«åˆ é™¤ã€‚<br>
å¦‚æœä¸€ä¸ªå¯¹è±¡åªå­˜åœ¨äº weak tables ä¸­ï¼ŒLua å°†ä¼šæœ€ç»ˆå°†å®ƒæ”¶é›†ã€‚</p>
<p>ä¸‰ç§ç±»å‹çš„ weak tablesï¼š</p>
<ul>
<li>
<p>weak keys ç»„æˆçš„ tablesï¼›</p>
</li>
<li>
<p>weak values ç»„æˆçš„ tablesï¼›</p>
</li>
<li>
<p>ä»¥åŠçº¯ weak tables ç±»å‹ï¼Œä»–ä»¬çš„ keys å’Œ values éƒ½æ˜¯ weak çš„ã€‚</p>
<p>è¡¨çš„ weak æ€§ç”±ä»–çš„ metatable çš„__mode åŸŸæ¥æŒ‡å®šçš„ã€‚</p>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;&#125;</span><br><span class="line">b = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(a, b)</span><br><span class="line">b.<span class="built_in">__mode</span> = <span class="string">"k"</span> <span class="comment">-- now 'a' has weak keys</span></span><br><span class="line">key = &#123;&#125; <span class="comment">-- creates first key</span></span><br><span class="line">a[&#123;key&#125;] = <span class="number">1</span></span><br><span class="line">key = &#123;&#125; <span class="comment">-- creates second key</span></span><br><span class="line">a[key] = <span class="number">2</span></span><br><span class="line"><span class="built_in">collectgarbage</span>() <span class="comment">-- forces a garbage collection cycle</span></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span> <span class="built_in">print</span>(v) <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒä¸ªèµ‹å€¼è¯­å¥ key={}è¦†ç›–äº†ç¬¬ä¸€ä¸ª key çš„å€¼ã€‚å½“åƒåœ¾æ”¶é›†å™¨å·¥ä½œæ—¶ï¼Œåœ¨å…¶ä»–åœ°æ–¹æ²¡æœ‰æŒ‡å‘ç¬¬ä¸€ä¸ª key çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒè¢«æ”¶é›†äº†</p>
<p>note:<em>åªæœ‰å¯¹è±¡æ‰å¯ä»¥ä»ä¸€ä¸ª weak table ä¸­è¢«æ”¶é›†ã€‚æ¯”å¦‚æ•°å­—å’Œå¸ƒå°”å€¼ç±»å‹çš„å€¼ï¼Œéƒ½æ˜¯ä¸ä¼šè¢«æ”¶é›†çš„ã€‚</em></p>
<p>example:<em>å¦‚æœæˆ‘ä»¬åœ¨ table ä¸­æ’å…¥äº†ä¸€ä¸ªæ•°å€¼å‹çš„ keyï¼ˆåœ¨å‰é¢é‚£ä¸ªä¾‹å­ä¸­ï¼‰ï¼Œå®ƒå°†æ°¸è¿œä¸ä¼šè¢«æ”¶é›†å™¨ä» table ä¸­ç§»é™¤ã€‚å½“ç„¶ï¼Œå¦‚æœå¯¹åº”äºè¿™ä¸ªæ•°å€¼å‹ key çš„ <strong>vaule</strong>è¢«æ”¶é›†ï¼Œé‚£ä¹ˆå®ƒçš„æ•´ä¸ªå…¥å£å°†ä¼šä» weak table ä¸­è¢«ç§»é™¤ã€‚</em></p>
<p>note:<em>ä¸€ä¸ªå­—ç¬¦ä¸²ä¸ä¼šä» weak tables ä¸­è¢«ç§»é™¤ï¼ˆé™¤éå®ƒæ‰€å…³è”çš„ vaule è¢«æ”¶é›†ï¼‰</em></p>
<h3 id="17-1-è®°å¿†å‡½æ•°"><a class="header-anchor" href="#17-1-è®°å¿†å‡½æ•°">Â¶</a>17.1 è®°å¿†å‡½æ•°</h3>
<p>å¦‚æœè¿™ä¸ªç»“æœè¡¨ä¸­æœ‰ weak å€¼ï¼Œæ¯æ¬¡çš„åƒåœ¾æ”¶é›†å¾ªç¯éƒ½ä¼šç§»é™¤å½“å‰æ—¶é—´å†…æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„ç»“æœ</p>
<pre><code>  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> results = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(results, &#123;<span class="built_in">__mode</span> = <span class="string">"v"</span>&#125;) <span class="comment">-- make values weak</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRGB</span> <span class="params">(r, g, b)</span></span></span><br><span class="line">    <span class="keyword">local</span> key = r .. <span class="string">"-"</span> .. g .. <span class="string">"-"</span> .. b</span><br><span class="line">    <span class="keyword">if</span> results[key] <span class="keyword">then</span> <span class="keyword">return</span> results[key]</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">local</span> newcolor = &#123;red = r, green = g, blue = b&#125;</span><br><span class="line">        results[key] = newcolor</span><br><span class="line">        <span class="keyword">return</span> newcolor</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<blockquote>
<p>æ ‡å‡†åº“</p>
</blockquote>
<h2 id="18-æ•°å­¦åº“"><a class="header-anchor" href="#18-æ•°å­¦åº“">Â¶</a>18. æ•°å­¦åº“</h2>
<p>ä¸‰è§’å‡½æ•°åº“ï¼ˆsin, cos, tan, asin, acos, etc.ï¼‰<br>
å¹‚æŒ‡å‡½æ•°ï¼ˆexp, log, log10ï¼‰ï¼Œ<br>
èˆå…¥å‡½æ•°ï¼ˆfloor, ceilï¼‰ã€<br>
maxã€minï¼ŒåŠ ä¸Šä¸€ä¸ªå˜é‡ piã€‚</p>
<p>æ‰€æœ‰çš„ä¸‰è§’å‡½æ•°éƒ½åœ¨å¼§åº¦å•ä½ä¸‹å·¥ä½œã€‚<strong>ï¼ˆLua4.0 ä»¥å‰åœ¨åº¦æ•°ä¸‹å·¥ä½œã€‚ï¼‰</strong><br>
ä½ å¯ä»¥ä½¿ç”¨ <code>deg</code>å’Œ <code>rad</code> å‡½æ•°åœ¨åº¦å’Œå¼§åº¦ä¹‹é—´è½¬æ¢ã€‚</p>
<p>math.random ç”¨æ¥äº§ç”Ÿä¼ªéšæœºæ•°ï¼Œæœ‰ä¸‰ç§è°ƒç”¨æ–¹å¼ï¼š</p>
<ul>
<li>ç¬¬ä¸€ï¼šä¸å¸¦å‚æ•°ï¼Œå°†äº§ç”Ÿ [0,1)èŒƒå›´å†…çš„éšæœºæ•°.</li>
<li>ç¬¬äºŒï¼šå¸¦ä¸€ä¸ªå‚æ•° nï¼Œå°†äº§ç”Ÿ 1 &lt;= x &lt;= n èŒƒå›´å†…çš„éšæœºæ•° x.</li>
<li>ç¬¬ä¸‰ï¼šå¸¦ä¸¤ä¸ªå‚æ•° a å’Œ b,å°†äº§ç”Ÿ a &lt;= x &lt;= b èŒƒå›´å†…çš„éšæœºæ•° x.</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">math</span>.<span class="built_in">randomseed</span>(<span class="built_in">os</span>.<span class="built_in">time</span>())</span><br></pre></td></tr></table></figure>
<h2 id="19-table-lib"><a class="header-anchor" href="#19-table-lib">Â¶</a>19. table lib</h2>
<p>table.getn table.setn å·²ç»å¼ƒç”¨</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;<span class="literal">nil</span>, <span class="number">1</span>, <span class="number">2</span>, key = <span class="string">'1234321'</span>, <span class="literal">nil</span>, <span class="number">15</span>, <span class="string">'sagewqgag'</span>, <span class="literal">nil</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k,v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'ddd'</span>,k,v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'len:'</span>,#a)</span><br></pre></td></tr></table></figure>
<p>ipairs iterate number index until first <code>nil</code><br>
pairs iterate all except <code>nil</code><br>
when <code>{nil, 1, 2, key = '1234321', nil, 15, 'sagewqgag', nil}</code>, #a = 6<br>
when <code>{1, 2, key = '1234321', nil, 15, 'sagewqgag', nil}</code>, #a = 2<br>
when <code>{1, 2, key = '1234321', 15, 'sagewqgag', nil}</code>, #a = 4<br>
when <code>{1, 2, key = '1234321', 15, 'sagewqgag'}</code>, #a = 4</p>
<p>table.insert å‡½æ•°åœ¨ arrayæŒ‡å®šä½ç½®æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶<strong>å°†åé¢æ‰€æœ‰å…¶ä»–çš„å…ƒç´ åç§»ã€‚</strong></p>
<p>ä¸å¸¦ä½ç½®å‚æ•°è°ƒç”¨ insertï¼Œå°†ä¼šåœ¨ array<strong>æœ€åä½ç½®</strong>æ’å…¥å…ƒç´ ï¼ˆæ‰€ä»¥ä¸éœ€è¦å…ƒç´ ç§»åŠ¨ï¼‰</p>
<p>note:<em>æ’åºå‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°å¹¶ä¸”å¦‚æœåœ¨ array ä¸­æ’åºåç¬¬ä¸€ä¸ªå‚æ•°åœ¨ç¬¬äºŒä¸ªå‚æ•°å‰é¢ï¼Œæ’åºå‡½æ•°å¿…é¡»è¿”å› trueã€‚å¦‚æœæœªæä¾›æ’åºå‡½æ•°ï¼Œsort ä½¿ç”¨é»˜è®¤çš„å°äºæ“ä½œç¬¦è¿›è¡Œæ¯”è¾ƒ</em></p>
<h2 id="20-string-lib"><a class="header-anchor" href="#20-string-lib">Â¶</a>20 string lib</h2>
<p><code>string.len(s)</code>è¿”å›å­—ç¬¦ä¸² s çš„é•¿åº¦ï¼›<br>
<code>string.rep(s,n)</code>è¿”å›é‡å¤ n æ¬¡å­—ç¬¦ä¸² s çš„ä¸²ï¼›<br>
ä½ ä½¿ç”¨ <code>string.rep(&quot;a&quot;, 2^20)</code>å¯ä»¥åˆ›å»ºä¸€ä¸ª 1M bytes çš„å­—ç¬¦ä¸²ï¼ˆæ¯”å¦‚ï¼Œä¸ºäº†æµ‹è¯•éœ€è¦ï¼‰ ï¼›<br>
<code>string.lower(s)</code>å°† s ä¸­çš„å¤§å†™å­—æ¯è½¬æ¢æˆå°å†™ï¼ˆ<code>string.upper</code>å°†å°å†™è½¬æ¢æˆå¤§å†™ï¼‰<br>
<code>string.sub(s,i,j)</code>å‡½æ•°æˆªå–å­—ç¬¦ä¸² s çš„ä»ç¬¬ i ä¸ªå­—ç¬¦åˆ°ç¬¬ j ä¸ªå­—ç¬¦ä¹‹é—´çš„ä¸²ã€‚</p>
<p>Luaä¸­ï¼Œ<em>å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ç´¢å¼•ä» 1 å¼€å§‹ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è´Ÿç´¢å¼•ï¼Œè´Ÿç´¢å¼•ä»å­—ç¬¦ä¸²çš„ç»“å°¾å‘å‰è®¡æ•°ï¼š-1 æŒ‡å‘æœ€åä¸€ä¸ªå­—ç¬¦ï¼Œ-2 æŒ‡å‘å€’æ•°ç¬¬äºŒä¸ªï¼Œä»¥æ­¤ç±»æ¨ã€‚</em><br>
note:<em>Lua ä¸­çš„å­—ç¬¦ä¸²æ˜¯æ’å®šä¸å˜çš„ã€‚String.sub å‡½æ•°ä»¥åŠ Lua ä¸­å…¶ä»–çš„å­—ç¬¦ä¸²æ“ä½œå‡½æ•°éƒ½ä¸ä¼šæ”¹å˜å­—ç¬¦ä¸²çš„å€¼ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ã€‚</em><br>
å¦‚æœä½ æƒ³ä¿®æ”¹ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡çš„å€¼ï¼Œä½ å¿…é¡»å°†å˜é‡èµ‹ç»™ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="built_in">string</span>.<span class="built_in">sub</span>(s, <span class="number">2</span>, <span class="number">-2</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">char</span>(<span class="number">97</span>)) <span class="comment">--&gt; a</span></span><br><span class="line">i = <span class="number">99</span>; <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">char</span>(i, i+<span class="number">1</span>, i+<span class="number">2</span>)) <span class="comment">--&gt; cde</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">byte</span>(<span class="string">"abc"</span>)) <span class="comment">--&gt; 97</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">byte</span>(<span class="string">"abc"</span>, <span class="number">2</span>)) <span class="comment">--&gt; 98</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">byte</span>(<span class="string">"abc"</span>, <span class="number">-1</span>)) <span class="comment">--&gt; 99</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"pi = %.4f"</span>, PI)) <span class="comment">--&gt; pi = 3.1416</span></span><br><span class="line">d = <span class="number">5</span>; m = <span class="number">11</span>; y = <span class="number">1990</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"%02d/%02d/%04d"</span>, d, m, y)) <span class="comment">--&gt; 05/11/1990</span></span><br><span class="line">tag, title = <span class="string">"h1"</span>, <span class="string">"a title"</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"&lt;%s&gt;%s&lt;/%s&gt;"</span>, tag, title, tag)) <span class="comment">--&gt; &lt;h1&gt;a title&lt;/h1&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="20-1-pattern-matching-æ¨¡å¼åŒ¹é…"><a class="header-anchor" href="#20-1-pattern-matching-æ¨¡å¼åŒ¹é…">Â¶</a>20.1 pattern matching æ¨¡å¼åŒ¹é…</h3>
<p>Luaå¹¶ä¸ä½¿ç”¨POSIXè§„èŒƒçš„æ­£åˆ™è¡¨è¾¾å¼ï¼ˆä¹Ÿå†™ä½œ<strong>regexp</strong>ï¼‰æ¥è¿›è¡Œæ¨¡å¼åŒ¹é…ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">"hello world"</span></span><br><span class="line">i, j = <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">"hello"</span>)</span><br><span class="line"><span class="built_in">print</span>(i, j) <span class="comment">--&gt; 1 5</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">sub</span>(s, i, j)) <span class="comment">--&gt; hello</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">"world"</span>)) <span class="comment">--&gt; 7 11</span></span><br><span class="line">i, j = <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">"l"</span>)</span><br><span class="line"><span class="built_in">print</span>(i, j) <span class="comment">--&gt; 3 3</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">"lll"</span>)) <span class="comment">--&gt; nil</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> t = &#123;&#125; <span class="comment">-- table to store the indices</span></span><br><span class="line"><span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    i = <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">"\n"</span>, i+<span class="number">1</span>) <span class="comment">-- find 'next' newline</span></span><br><span class="line">    <span class="keyword">if</span> i == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(t, i)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">"Lua is cute"</span>, <span class="string">"cute"</span>, <span class="string">"great"</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; Lua is great</span></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">"all lii"</span>, <span class="string">"l"</span>, <span class="string">"x"</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; axx xii</span></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">"Lua is great"</span>, <span class="string">"perl"</span>, <span class="string">"tcl"</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; Lua is great</span></span><br><span class="line"></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">"all lii"</span>, <span class="string">"l"</span>, <span class="string">"x"</span>, <span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; axl lii</span></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">"all lii"</span>, <span class="string">"l"</span>, <span class="string">"x"</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; axx lii</span></span><br><span class="line">_, count = <span class="built_in">string</span>.<span class="built_in">gsub</span>(str, <span class="string">" "</span>, <span class="string">" "</span>)</span><br></pre></td></tr></table></figure>
<p>note:<em>_ åªæ˜¯ä¸€ä¸ªå“‘å…ƒå˜é‡</em></p>
<h3 id="20-2-pattern-æ¨¡å¼"><a class="header-anchor" href="#20-2-pattern-æ¨¡å¼">Â¶</a>20.2 pattern æ¨¡å¼</h3>
<pre><code>+ åŒ¹é…å‰ä¸€å­—ç¬¦ 1 æ¬¡æˆ–å¤šæ¬¡
* åŒ¹é…å‰ä¸€å­—ç¬¦ 0 æ¬¡æˆ–å¤šæ¬¡
- åŒ¹é…å‰ä¸€å­—ç¬¦ 0 æ¬¡æˆ–å¤šæ¬¡
? åŒ¹é…å‰ä¸€å­—ç¬¦ 0 æ¬¡æˆ– 1 æ¬¡
'[_%a][_%w]*' åŒ¹é… Lua ç¨‹åºä¸­çš„æ ‡ç¤ºç¬¦ï¼šå­—æ¯æˆ–è€…ä¸‹åˆ’çº¿å¼€å¤´çš„å­—æ¯ä¸‹åˆ’çº¿æ•°å­—åºåˆ—ã€‚
åŒ¹é…ä¸€å¯¹åœ†æ‹¬å·()æˆ–è€…æ‹¬å·ä¹‹é—´çš„ç©ºç™½ï¼Œå¯ä»¥ä½¿ç”¨ '%(%s*%)'
</code></pre>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">"Deadline is 30/05/1999, firm"</span></span><br><span class="line"><span class="built_in">date</span> = <span class="string">"%d%d/%d%d/%d%d%d%d"</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">sub</span>(s, <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="built_in">date</span>))) <span class="comment">--&gt; 30/05/1999</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">"hello, up-down!"</span>, <span class="string">"%A"</span>, <span class="string">"."</span>)) <span class="comment">--&gt; hello..up.down. 4</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">"one, and two; and three"</span>, <span class="string">"%a+"</span>, <span class="string">"word"</span>)) <span class="comment">--&gt; word, word word; word word</span></span><br><span class="line"></span><br><span class="line">i, j = <span class="built_in">string</span>.<span class="built_in">find</span>(<span class="string">"the number 1298 is even"</span>, <span class="string">"%d+"</span>)</span><br><span class="line"><span class="built_in">print</span>(i,j) <span class="comment">--&gt; 12 15</span></span><br></pre></td></tr></table></figure>
<h3 id="20-3-matchings-æ•è·"><a class="header-anchor" href="#20-3-matchings-æ•è·">Â¶</a>20.3 matchings æ•è·</h3>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pair = <span class="string">"name = Anna"</span></span><br><span class="line">_, _, key, value = <span class="built_in">string</span>.<span class="built_in">find</span>(pair, <span class="string">"(%a+)%s*=%s*(%a+)"</span>)</span><br><span class="line"><span class="built_in">print</span>(key, value) <span class="comment">--&gt; name Anna</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">date</span> = <span class="string">"17/7/1990"</span></span><br><span class="line">_, _, d, m, y = <span class="built_in">string</span>.<span class="built_in">find</span>(<span class="built_in">date</span>, <span class="string">"(%d+)/(%d+)/(%d+)"</span>)</span><br><span class="line"><span class="built_in">print</span>(d, m, y) <span class="comment">--&gt; 17 7 1990</span></span><br><span class="line"></span><br><span class="line">s = <span class="string">[[then he said: "it's all right"!]]</span></span><br><span class="line">a, b, c, quotedPart = <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">"([\"'])(.-)%1"</span>)</span><br><span class="line"><span class="built_in">print</span>(quotedPart) <span class="comment">--&gt; it's all right</span></span><br><span class="line"><span class="built_in">print</span>(c) <span class="comment">--&gt; "</span></span><br></pre></td></tr></table></figure>
<h2 id="21-IO-lib"><a class="header-anchor" href="#21-IO-lib">Â¶</a>21. IO lib</h2>
<h3 id="21-1-simple-I-O-mode"><a class="header-anchor" href="#21-1-simple-I-O-mode">Â¶</a>21.1 simple I/O mode</h3>
<p>io.input å’Œ io.output å‡½æ•°æ¥æ”¹å˜å½“å‰æ–‡ä»¶ã€‚<br>
ä¾‹å¦‚io.input(filename)å°±æ˜¯æ‰“å¼€ç»™å®šæ–‡ä»¶ï¼ˆä»¥è¯»æ¨¡å¼ï¼‰ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºå½“å‰è¾“å…¥æ–‡ä»¶ã€‚<br>
æ¥ä¸‹æ¥æ‰€æœ‰çš„è¾“å…¥éƒ½æ¥è‡ªäºè¯¥æ–‡ï¼Œç›´åˆ°å†æ¬¡ä½¿ç”¨ io.inputã€‚io.output å‡½æ•°ã€‚<br>
ä¸€æ—¦äº§ç”Ÿé”™è¯¯ä¸¤ä¸ªå‡½æ•°éƒ½ä¼šäº§ç”Ÿé”™è¯¯ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">"sin (3) = "</span>, <span class="built_in">math</span>.<span class="built_in">sin</span>(<span class="number">3</span>), <span class="string">"\n"</span>)</span><br><span class="line"><span class="comment">--&gt; sin (3) = 0.1411200080598672</span></span><br><span class="line">&gt; <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"sin (3) = %.4f\n"</span>, <span class="built_in">math</span>.<span class="built_in">sin</span>(<span class="number">3</span>)))</span><br><span class="line"><span class="comment">--&gt; sin (3) = 0.1411</span></span><br></pre></td></tr></table></figure>
<p>åœ¨ç¼–å†™ä»£ç æ—¶åº”å½“é¿å…åƒ io.write(aâ€¦bâ€¦c)ï¼›è¿™æ ·çš„ä¹¦å†™ï¼Œè¿™åŒ io.write(a,b,c)çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯åè€…å› ä¸ºé¿å…äº†ä¸²è”æ“ä½œï¼Œè€Œæ¶ˆè€—è¾ƒå°‘çš„èµ„æºã€‚</p>
<p>Write å‡½æ•°ä¸ print å‡½æ•°ä¸åŒåœ¨äºï¼Œwrite ä¸é™„åŠ ä»»ä½•é¢å¤–çš„å­—ç¬¦åˆ°è¾“å‡ºä¸­å»ï¼Œä¾‹å¦‚åˆ¶è¡¨ç¬¦ï¼Œæ¢è¡Œç¬¦ç­‰ç­‰ã€‚<br>
write å‡½æ•°æ˜¯ä½¿ç”¨å½“å‰è¾“å‡ºæ–‡ä»¶ï¼Œè€Œ print å§‹ç»ˆä½¿ç”¨æ ‡å‡†è¾“å‡ºã€‚<br>
printå‡½æ•°ä¼šè‡ªåŠ¨è°ƒç”¨å‚æ•°çš„ tostringæ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥æ˜¾ç¤ºå‡ºè¡¨ï¼ˆtablesï¼‰å‡½æ•°ï¼ˆfunctionsï¼‰å’Œ nilã€‚</p>
<p>â€œ*allâ€ è¯»å–æ•´ä¸ªæ–‡ä»¶<br>
â€œ*lineâ€ è¯»å–ä¸‹ä¸€è¡Œ<br>
â€œ*numberâ€ ä»ä¸²ä¸­è½¬æ¢å‡ºä¸€ä¸ªæ•°å€¼<br>
num è¯»å– num ä¸ªå­—ç¬¦åˆ°ä¸²</p>
<p>io.read(â€œ*allâ€)å‡½æ•°ä»å½“å‰ä½ç½®è¯»å–æ•´ä¸ªè¾“å…¥æ–‡ä»¶ã€‚å¦‚æœå½“å‰ä½ç½®åœ¨æ–‡ä»¶æœ«å°¾ï¼Œæˆ–è€…æ–‡ä»¶ä¸ºç©ºï¼Œå‡½æ•°å°†è¿”å›ç©ºä¸²ã€‚<br>
io.read(â€œ*lineâ€)å‡½æ•°è¿”å›å½“å‰è¾“å…¥æ–‡ä»¶çš„ä¸‹ä¸€è¡Œï¼ˆä¸åŒ…å«æœ€åçš„æ¢è¡Œç¬¦ï¼‰ã€‚å½“åˆ°è¾¾æ–‡ä»¶æœ«å°¾ï¼Œè¿”å›å€¼ä¸º nilï¼ˆè¡¨ç¤ºæ²¡æœ‰ä¸‹ä¸€è¡Œå¯è¿”å›ï¼‰<br>
<em>è¯¥è¯»å–æ–¹å¼æ˜¯ read å‡½æ•°çš„é»˜è®¤æ–¹å¼ï¼Œæ‰€ä»¥å¯ä»¥ç®€å†™ä¸º io.read()ã€‚</em><br>
io.read(â€œ*numberâ€)å‡½æ•°ä»å½“å‰è¾“å…¥æ–‡ä»¶ä¸­è¯»å–å‡ºä¸€ä¸ªæ•°å€¼ã€‚åªæœ‰åœ¨è¯¥å‚æ•°ä¸‹ read å‡½æ•°æ‰è¿”å›æ•°å€¼ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²ã€‚<br>
å¦‚æœåœ¨å½“å‰ä½ç½®æ‰¾ä¸åˆ°ä¸€ä¸ªæ•°å­—ï¼ˆç”±äºæ ¼å¼ä¸å¯¹ï¼Œæˆ–è€…æ˜¯åˆ°äº†æ–‡ä»¶çš„ç»“å°¾ï¼‰ï¼Œåˆ™è¿”å› nil å¯ä»¥å¯¹æ¯ä¸ªå‚æ•°è®¾ç½®é€‰é¡¹ï¼Œå‡½æ•°å°†è¿”å›å„è‡ªçš„ç»“æœã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">6.0 -3.23 15e12</span></span><br><span class="line"><span class="comment">4.3 234 1000001</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">]]</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line"><span class="keyword">local</span> n1, n2, n3 = <span class="built_in">io</span>.<span class="built_in">read</span>(<span class="string">"*number"</span>, <span class="string">"*number"</span>, <span class="string">"*number"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> n1 <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">math</span>.<span class="built_in">max</span>(n1, n2, n3))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> size = <span class="number">2</span>^<span class="number">13</span> <span class="comment">-- good buffer size (8K)</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line"><span class="keyword">local</span> block = <span class="built_in">io</span>.<span class="built_in">read</span>(size)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> block <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">write</span>(block)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="21-2-complete-I-O-mode"><a class="header-anchor" href="#21-2-complete-I-O-mode">Â¶</a>21.2 complete I/O mode</h3>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> f = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename, <span class="string">"r"</span>))</span><br><span class="line"><span class="keyword">local</span> t = f:<span class="built_in">read</span>(<span class="string">"*all"</span>)</span><br><span class="line">f:<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> temp = <span class="built_in">io</span>.<span class="built_in">input</span>() <span class="comment">-- save current file</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">input</span>(<span class="string">"newinput"</span>) <span class="comment">-- open a new current file</span></span><br><span class="line">... <span class="comment">-- do something with new input</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">input</span>():<span class="built_in">close</span>() <span class="comment">-- close current file</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">input</span>(temp) <span class="comment">-- restore previous current file</span></span><br></pre></td></tr></table></figure>
<p>I/O ä¼˜åŒ–çš„ä¸€ä¸ªå°æŠ€å·§:<br>
é€šå¸¸ Lua ä¸­è¯»å–æ•´ä¸ªæ–‡ä»¶è¦æ¯”ä¸€è¡Œä¸€è¡Œçš„è¯»å–ä¸€ä¸ªæ–‡ä»¶å¿«çš„å¤šã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">lines</span>, rest = f:<span class="built_in">read</span>(BUFSIZE, <span class="string">"*line"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> BUFSIZE = <span class="number">2</span>^<span class="number">13</span> <span class="comment">-- 8K</span></span><br><span class="line"><span class="keyword">local</span> f = <span class="built_in">io</span>.<span class="built_in">input</span>(<span class="built_in">arg</span>[<span class="number">1</span>]) <span class="comment">-- open input file</span></span><br><span class="line"><span class="keyword">local</span> cc, lc, wc = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> <span class="comment">-- char, line, and word counts</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">lines</span>, rest = f:<span class="built_in">read</span>(BUFSIZE, <span class="string">"*line"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">lines</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> rest <span class="keyword">then</span> <span class="built_in">lines</span> = <span class="built_in">lines</span> .. rest .. <span class="string">'\n'</span> <span class="keyword">end</span></span><br><span class="line">    cc = cc + <span class="built_in">string</span>.<span class="built_in">len</span>(<span class="built_in">lines</span>)</span><br><span class="line">    <span class="comment">-- count words in the chunk</span></span><br><span class="line">    <span class="keyword">local</span> _,t = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="built_in">lines</span>, <span class="string">"%S+"</span>, <span class="string">""</span>)</span><br><span class="line">    wc = wc + t</span><br><span class="line">    <span class="comment">-- count newlines in the chunk</span></span><br><span class="line">    _,t = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="built_in">lines</span>, <span class="string">"\n"</span>, <span class="string">"\n"</span>)</span><br><span class="line">    lc = lc + t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(lc, wc, cc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> inp = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(<span class="built_in">arg</span>[<span class="number">1</span>], <span class="string">"rb"</span>))</span><br><span class="line"><span class="keyword">local</span> out = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(<span class="built_in">arg</span>[<span class="number">2</span>], <span class="string">"wb"</span>))</span><br><span class="line"><span class="keyword">local</span> data = inp:<span class="built_in">read</span>(<span class="string">"*all"</span>)</span><br><span class="line">data = <span class="built_in">string</span>.<span class="built_in">gsub</span>(data, <span class="string">"\r\n"</span>, <span class="string">"\n"</span>)</span><br><span class="line">out:<span class="built_in">write</span>(data)</span><br><span class="line"><span class="built_in">assert</span>(out:<span class="built_in">close</span>())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fsize</span> <span class="params">(file)</span></span></span><br><span class="line"><span class="keyword">local</span> current = file:seek() <span class="comment">-- get current position</span></span><br><span class="line"><span class="keyword">local</span> size = file:seek(<span class="string">"end"</span>) <span class="comment">-- get file size</span></span><br><span class="line">file:seek(<span class="string">"set"</span>, current) <span class="comment">-- restore position</span></span><br><span class="line"><span class="keyword">return</span> size</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="22-system-lib-æ“ä½œç³»ç»Ÿåº“"><a class="header-anchor" href="#22-system-lib-æ“ä½œç³»ç»Ÿåº“">Â¶</a>22 system lib æ“ä½œç³»ç»Ÿåº“</h2>
<p>Lua æ˜¯ä»¥ ANSI C å†™æˆçš„</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- obs: 10800 = 3*60*60 (3 hours)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">time</span>&#123;year=<span class="number">1970</span>, month=<span class="number">1</span>, day=<span class="number">1</span>, hour=<span class="number">0</span>&#125;)</span><br><span class="line"><span class="comment">--&gt; 10800</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">time</span>&#123;year=<span class="number">1970</span>, month=<span class="number">1</span>, day=<span class="number">1</span>, hour=<span class="number">0</span>, sec=<span class="number">1</span>&#125;)</span><br><span class="line"><span class="comment">--&gt; 10801</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">time</span>&#123;year=<span class="number">1970</span>, month=<span class="number">1</span>, day=<span class="number">1</span>&#125;)</span><br><span class="line"><span class="comment">--&gt; 54000 (obs: 54000 = 10800 + 12*60*60)</span></span><br><span class="line"></span><br><span class="line">temp = <span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">"*t"</span>, <span class="number">906000490</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">&#123;year = 1998, month = 9, day = 16, yday = 259, wday = 4,</span></span><br><span class="line"><span class="comment">hour = 23, min = 48, sec = 10, isdst = false&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">%a abbreviated weekday name (e.g., Wed)</span></span><br><span class="line"><span class="comment">%A full weekday name (e.g., Wednesday)</span></span><br><span class="line"><span class="comment">%b abbreviated month name (e.g., Sep)</span></span><br><span class="line"><span class="comment">%B full month name (e.g., September)</span></span><br><span class="line"><span class="comment">%c date and time (e.g., 09/16/98 23:48:10)</span></span><br><span class="line"><span class="comment">%d day of the month (16) [01-31]</span></span><br><span class="line"><span class="comment">%H hour, using a 24-hour clock (23) [00-23]</span></span><br><span class="line"><span class="comment">%I hour, using a 12-hour clock (11) [01-12]</span></span><br><span class="line"><span class="comment">%M minute (48) [00-59]</span></span><br><span class="line"><span class="comment">%m month (09) [01-12]</span></span><br><span class="line"><span class="comment">%p either "am" or "pm" (pm)</span></span><br><span class="line"><span class="comment">%S second (10) [00-61]</span></span><br><span class="line"><span class="comment">%w weekday (3) [0-6 = Sunday-Saturday]</span></span><br><span class="line"><span class="comment">%x date (e.g., 09/16/98)</span></span><br><span class="line"><span class="comment">%X time (e.g., 23:48:10)</span></span><br><span class="line"><span class="comment">%Y full year (1998)</span></span><br><span class="line"><span class="comment">%y two-digit year (98) [00-99]</span></span><br><span class="line"><span class="comment">%% the character '%'</span></span><br><span class="line"><span class="comment">]]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- äº‹å®ä¸Šå¦‚æœä¸ä½¿ç”¨ä»»ä½•å‚æ•°å°±è°ƒç”¨ dateï¼Œå°±æ˜¯ä»¥%c çš„å½¢å¼è¾“å‡ºã€‚</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">"today is %A, in %B"</span>))</span><br><span class="line"><span class="comment">--&gt; today is Tuesday, in May</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">"%x"</span>, <span class="number">906000490</span>))</span><br><span class="line"><span class="comment">--&gt; 09/16/1998</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">getenv</span>(<span class="string">"HOME"</span>)) <span class="comment">--&gt; /home/lua</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createDir</span> <span class="params">(dirname)</span></span></span><br><span class="line">    <span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">"mkdir "</span> .. dirname)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="23-debug-lib"><a class="header-anchor" href="#23-debug-lib">Â¶</a>23. debug lib</h2>
<p>debug åº“ç”±ä¸¤ç§å‡½æ•°ç»„æˆï¼šè‡ªçœ(<code>introspective</code>)å‡½æ•°å’Œ <code>hooks</code>ã€‚</p>
<p>è‡ªçœå‡½æ•° <em>ä½¿å¾—æˆ‘ä»¬å¯ä»¥æ£€æŸ¥è¿è¡Œç¨‹åºçš„æŸäº›æ–¹é¢ï¼Œæ¯”å¦‚æ´»åŠ¨å‡½æ•°æ ˆã€å½“å‰æ‰§è¡Œä»£ç çš„è¡Œå·ã€æœ¬åœ°å˜é‡çš„åå’Œå€¼ã€‚</em><br>
Hooks <em>å¯ä»¥è·Ÿè¸ªç¨‹åºçš„æ‰§è¡Œæƒ…å†µã€‚</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">debug</span>.<span class="built_in">getinfo</span>(foo)</span><br></pre></td></tr></table></figure>
<p>ä»¥æ•°å­— n è°ƒç”¨ <code>debug.getinfo(n)</code>æ—¶ï¼Œè¿”å›åœ¨ <strong>n çº§æ ˆ</strong>çš„æ´»åŠ¨å‡½æ•°çš„ä¿¡æ¯æ•°æ®ã€‚<br>
æ¯”å¦‚ï¼Œå¦‚æœ n=1ï¼Œè¿”å›çš„æ˜¯æ­£åœ¨è¿›è¡Œè°ƒç”¨çš„é‚£ä¸ªå‡½æ•°çš„ä¿¡æ¯ã€‚ï¼ˆn=0 è¡¨ç¤º C å‡½æ•° getinfo æœ¬èº«ï¼‰<br>
å¦‚æœ n æ¯”æ ˆä¸­æ´»åŠ¨å‡½æ•°çš„ä¸ªæ•°å¤§çš„è¯ï¼Œdebug.getinfo è¿”å› nilã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">traceback</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> level = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> info = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(level, <span class="string">"Sl"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> info <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> info.what == <span class="string">"C"</span> <span class="keyword">then</span> <span class="comment">-- is a C function?</span></span><br><span class="line">            <span class="built_in">print</span>(level, <span class="string">"C function"</span>)</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">-- a Lua function</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"[%s]:%d"</span>,</span><br><span class="line">            info.short_src, info.currentline))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        level = level + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">a 10</span></span><br><span class="line"><span class="comment">b 20</span></span><br><span class="line"><span class="comment">x nil</span></span><br><span class="line"><span class="comment">a 4</span></span><br><span class="line"><span class="comment">]]</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">(a,b)</span></span></span><br><span class="line">    <span class="keyword">local</span> x</span><br><span class="line">    <span class="keyword">do</span> <span class="keyword">local</span> c = a - b <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> name, value = <span class="built_in">debug</span>.<span class="built_in">getlocal</span>(<span class="number">1</span>, a)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> name <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">print</span>(name, value)</span><br><span class="line">        a = a + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">foo(<span class="number">10</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getvarvalue</span> <span class="params">(name)</span></span></span><br><span class="line">    <span class="keyword">local</span> value, found</span><br><span class="line">    <span class="comment">-- try local variables</span></span><br><span class="line">    <span class="keyword">local</span> i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> n, v = <span class="built_in">debug</span>.<span class="built_in">getlocal</span>(<span class="number">2</span>, i)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> n == name <span class="keyword">then</span></span><br><span class="line">        value = v</span><br><span class="line">        found = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> found <span class="keyword">then</span> <span class="keyword">return</span> value <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- try upvalues</span></span><br><span class="line">    <span class="keyword">local</span> func = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">2</span>).func</span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> n, v = <span class="built_in">debug</span>.<span class="built_in">getupvalue</span>(func, i)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> n == name <span class="keyword">then</span> <span class="keyword">return</span> v <span class="keyword">end</span></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- not found; get global</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">getfenv</span>(func)[name]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="23-2-hooks"><a class="header-anchor" href="#23-2-hooks">Â¶</a>23.2 hooks</h3>
<p>Lua ä½¿ç”¨å•ä¸ªå‚æ•°è°ƒç”¨ hooksï¼Œå‚æ•°ä¸ºä¸€ä¸ªæè¿°äº§ç”Ÿè°ƒç”¨çš„äº‹ä»¶ï¼šâ€œcallâ€ã€â€œreturnâ€ã€â€œlineâ€ æˆ– â€œcountâ€ã€‚</p>
<p>æœ‰å››ç§å¯ä»¥è§¦å‘ä¸€ä¸ª hook çš„äº‹ä»¶ï¼š</p>
<ul>
<li>å½“ Lua è°ƒç”¨ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ call äº‹ä»¶å‘ç”Ÿï¼›</li>
<li>æ¯æ¬¡å‡½æ•°è¿”å›çš„æ—¶å€™ï¼Œreturn äº‹ä»¶å‘ç”Ÿï¼›</li>
<li>Lua å¼€å§‹æ‰§è¡Œä»£ç çš„æ–°è¡Œæ—¶å€™ï¼Œline äº‹ä»¶å‘ç”Ÿï¼›</li>
<li>è¿è¡ŒæŒ‡å®šæ•°ç›®çš„æŒ‡ä»¤ä¹‹åï¼Œcount äº‹ä»¶å‘ç”Ÿã€‚</li>
</ul>
<blockquote>
<p>C API</p>
</blockquote>
<h2 id="24-C-API-Overview"><a class="header-anchor" href="#24-C-API-Overview">Â¶</a>24. C API Overview</h2>
<p>Lua è§£é‡Šå™¨æ˜¯ä¸€ä¸ªä½¿ç”¨ Lua æ ‡å‡†åº“å®ç°çš„ç‹¬ç«‹çš„è§£é‡Šå™¨ï¼Œå¥¹æ˜¯ä¸€ä¸ªå¾ˆå°çš„åº”ç”¨ï¼ˆæ€»å…±ä¸è¶…è¿‡ 500 è¡Œçš„ä»£ç ï¼‰ã€‚</p>
<p>è§£é‡Šå™¨è´Ÿè´£ç¨‹åºå’Œä½¿ç”¨è€…çš„æ¥å£ï¼š<em>ä»ä½¿ç”¨è€…é‚£é‡Œè·å–æ–‡ä»¶æˆ–è€…å­—ç¬¦ä¸²ï¼Œå¹¶ä¼ ç»™ Lua æ ‡å‡†åº“ï¼ŒLua æ ‡å‡†åº“è´Ÿè´£æœ€ç»ˆçš„ä»£ç è¿è¡Œã€‚</em></p>
<p>ç¬¬ä¸€ç§ï¼ŒC ä½œä¸ºåº”ç”¨ç¨‹åºè¯­è¨€ï¼ŒLua ä½œä¸ºä¸€ä¸ª<strong>åº“</strong>ä½¿ç”¨ï¼›<br>
ç¬¬äºŒç§ï¼Œåè¿‡æ¥ï¼ŒLua ä½œä¸ºç¨‹åºè¯­è¨€ï¼ŒC ä½œä¸ºåº“ä½¿ç”¨ã€‚</p>
<p>C API:<br>
- è¯»å†™ Lua å…¨å±€å˜é‡çš„å‡½æ•°ï¼Œ<br>
- è°ƒç”¨ Lua å‡½æ•°çš„å‡½æ•°ï¼Œ<br>
- è¿è¡Œ Lua ä»£ç ç‰‡æ–­çš„å‡½æ•°ï¼Œ<br>
- æ³¨å†Œ C å‡½æ•°ç„¶åå¯ä»¥åœ¨Lua ä¸­è¢«è°ƒç”¨çš„å‡½æ•°ï¼Œç­‰ç­‰ã€‚</p>
<p>å‹æ ˆå‡½æ•°:</p>
<pre><code>- ç©ºå€¼ï¼ˆnilï¼‰ç”¨ lua_pushnilï¼Œ
- æ•°å€¼å‹ï¼ˆdoubleï¼‰ç”¨ lua_pushnumberï¼Œ
- å¸ƒå°”å‹ï¼ˆåœ¨ C ä¸­ç”¨æ•´æ•°è¡¨ç¤ºï¼‰ç”¨lua_pushbooleanï¼Œ
- ä»»æ„çš„å­—ç¬¦ä¸²ï¼ˆchar*ç±»å‹ï¼Œ**å…è®¸åŒ…å«'\0'å­—ç¬¦**ï¼‰ç”¨ lua_pushlstringï¼ŒCè¯­è¨€é£æ ¼ï¼ˆä»¥'\0'ç»“æŸï¼‰çš„å­—ç¬¦ä¸²ï¼ˆconst char*ï¼‰ç”¨ lua_pushstringï¼š
</code></pre>
<p>Lua ä¸­çš„å­—ç¬¦ä¸²ä¸æ˜¯ä»¥é›¶ä¸ºç»“æŸç¬¦çš„ï¼›å®ƒä»¬ä¾èµ–äºä¸€ä¸ªæ˜ç¡®çš„é•¿åº¦ï¼Œå› æ­¤å¯ä»¥åŒ…å«ä»»æ„çš„äºŒè¿›åˆ¶æ•°æ®ã€‚<br>
Lua ä»æ¥ä¸ä¿æŒä¸€ä¸ªæŒ‡å‘<strong>å¤–éƒ¨å­—ç¬¦ä¸²</strong>ï¼ˆæˆ–ä»»ä½•å…¶å®ƒå¯¹è±¡ï¼Œé™¤äº† C å‡½æ•°â€”â€”å®ƒæ€»æ˜¯é™æ€æŒ‡é’ˆï¼‰çš„æŒ‡é’ˆã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int lua_checkstack (lua_State *L, int sz);</span><br></pre></td></tr></table></figure>
<p>lua_isnumber å’Œ lua_isstring å‡½æ•°ä¸æ£€æŸ¥è¿™ä¸ªå€¼æ˜¯å¦æ˜¯æŒ‡å®šçš„ç±»å‹ï¼Œè€Œæ˜¯çœ‹å®ƒ<strong>æ˜¯å¦èƒ½è¢«è½¬æ¢æˆæŒ‡å®šçš„é‚£ç§ç±»å‹</strong>ã€‚ä¾‹å¦‚ï¼Œä»»ä½•æ•°å­—ç±»å‹éƒ½æ»¡è¶³ lua_isstring</p>
<p>lua_type å‡½æ•°ï¼Œå®ƒè¿”å›æ ˆä¸­å…ƒç´ çš„ç±»å‹ã€‚</p>
<p>ç»™å®šçš„å…ƒç´ çš„ç±»å‹ä¸æ­£ç¡®,lua_tobooleanã€lua_tonumber å’Œ lua_strlen è¿”å› 0ï¼Œå…¶ä»–å‡½æ•°è¿”å› NULL</p>
<p>å½“ä¸€ä¸ª C å‡½æ•°è¿”å›åï¼ŒLua ä¼šæ¸…ç†ä»–çš„æ ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *s = lua_tostring(L, <span class="number">-1</span>); <span class="comment">/* any Lua string */</span></span><br><span class="line"><span class="keyword">size_t</span> l = lua_strlen(L, <span class="number">-1</span>); <span class="comment">/* its length */</span></span><br><span class="line">assert(s[l] == <span class="string">'\0'</span>);</span><br><span class="line">assert(<span class="built_in">strlen</span>(s) &lt;= l);</span><br></pre></td></tr></table></figure>
<p>å‡½æ•° lua_gettop è¿”å›å †æ ˆä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œå®ƒä¹Ÿæ˜¯æ ˆé¡¶å…ƒç´ çš„ç´¢å¼•</p>
<p>ä¸€ä¸ªè´Ÿæ•°ç´¢å¼•-x å¯¹åº”äºæ­£æ•°ç´¢å¼• gettop-x+1ã€‚</p>
<p>lua_settop è®¾ç½®æ ˆé¡¶ï¼ˆä¹Ÿå°±æ˜¯å †æ ˆä¸­çš„å…ƒç´ ä¸ªæ•°ï¼‰ä¸ºä¸€ä¸ªæŒ‡å®šçš„å€¼ã€‚<br>
- å¦‚æœå¼€å§‹çš„æ ˆé¡¶é«˜äºæ–°çš„æ ˆé¡¶ï¼Œé¡¶éƒ¨çš„å€¼è¢«ä¸¢å¼ƒã€‚<br>
- å¦åˆ™ï¼Œä¸ºäº†å¾—åˆ°æŒ‡å®šçš„å¤§å°è¿™ä¸ªå‡½æ•°å‹å…¥ç›¸åº”ä¸ªæ•°çš„ç©ºå€¼ï¼ˆnilï¼‰åˆ°æ ˆä¸Šã€‚</p>
<p>lua_settop(L,0)æ¸…ç©ºå †æ ˆã€‚</p>
<p>å‡½æ•° lua_pushvalue å‹å…¥å †æ ˆä¸ŠæŒ‡å®šç´¢å¼•çš„ä¸€ä¸ªæŠŸè´åˆ°æ ˆé¡¶ï¼›<br>
lua_remove ç§»é™¤æŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´ ï¼Œå¹¶å°†å…¶ä¸Šé¢æ‰€æœ‰çš„å…ƒç´ ä¸‹ç§»æ¥å¡«è¡¥è¿™ä¸ªä½ç½®çš„ç©ºç™½ï¼›<br>
lua_insert ç§»åŠ¨æ ˆé¡¶å…ƒç´ åˆ°æŒ‡å®šç´¢å¼•çš„ä½ç½®ï¼Œå¹¶å°†è¿™ä¸ªç´¢å¼•ä½ç½®ä¸Šé¢çš„å…ƒç´ å…¨éƒ¨ä¸Šç§»è‡³æ ˆé¡¶è¢«ç§»åŠ¨ç•™ä¸‹çš„ç©ºéš”ï¼›<br>
æœ€åï¼Œlua_replace ä»æ ˆé¡¶å¼¹å‡ºå…ƒç´ å€¼å¹¶å°†å…¶è®¾ç½®åˆ°æŒ‡å®šç´¢å¼•ä½ç½®ï¼Œæ²¡æœ‰ä»»ä½•ç§»åŠ¨æ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">stackDump</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> top = lua_gettop(L);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;=top;i++)&#123; <span class="comment">/*repeatforeachlevel*/</span></span><br><span class="line">        <span class="keyword">int</span> t = lua_type(L, i);</span><br><span class="line">        <span class="keyword">switch</span> (t) &#123;</span><br><span class="line">        <span class="keyword">case</span> LUA_TSTRING: <span class="comment">/* strings */</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"`%s'"</span>, lua_tostring(L, i));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LUA_TBOOLEAN: <span class="comment">/* booleans */</span></span><br><span class="line">            <span class="built_in">printf</span>(lua_toboolean(L, i) ? <span class="string">"true"</span> : <span class="string">"false"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LUA_TNUMBER: <span class="comment">/* numbers */</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%g"</span>, lua_tonumber(L, i));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* other values */</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>, lua_typename(L, t)); </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" "</span>); <span class="comment">/* put a separator */</span> &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>); <span class="comment">/* end the listing */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    lua_State *L = lua_open();</span><br><span class="line">    lua_pushboolean(L, <span class="number">1</span>); lua_pushnumber(L, <span class="number">10</span>);</span><br><span class="line">    lua_pushnil(L); lua_pushstring(L, <span class="string">"hello"</span>);</span><br><span class="line">    stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 nil `hello' */</span></span><br><span class="line">    lua_pushvalue(L, <span class="number">-4</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 nil `hello' true */</span></span><br><span class="line">    lua_replace(L, <span class="number">3</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 true `hello' */</span></span><br><span class="line">    lua_settop(L, <span class="number">6</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 true `hello' nil nil */</span></span><br><span class="line">    lua_remove(L, <span class="number">-3</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 true nil nil */</span></span><br><span class="line">    lua_settop(L, <span class="number">-5</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true */</span></span><br><span class="line">    lua_close(L);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="24-3-C-API-exception-handler"><a class="header-anchor" href="#24-3-C-API-exception-handler">Â¶</a>24.3 C API exception handler</h3>
<p>å½“æˆ‘ä»¬å†™ä¸€ä¸ªåº“ä»£ç æ—¶ï¼ˆä¹Ÿå°±æ˜¯è¢« Lua è°ƒç”¨çš„ C å‡½æ•°ï¼‰é•¿è·³è½¬ï¼ˆlong jumpï¼‰çš„ç”¨å¤„å‡ ä¹å’Œä¸€ä¸ªçœŸæ­£çš„å¼‚å¸¸å¤„ç†ä¸€æ ·çš„æ–¹ä¾¿ï¼Œå› ä¸º Lua æŠ“å–äº†ä»»åŠ¡å¶ç„¶çš„é”™è¯¯ã€‚</p>
<p>panic å‡½æ•°<br>
lua_pcall<br>
lua_cpcall<br>
luaL_error</p>
<h2 id="25-invoking-lua-function"><a class="header-anchor" href="#25-invoking-lua-function">Â¶</a>25. invoking lua function</h2>
<h2 id="26-invoking-C-function"><a class="header-anchor" href="#26-invoking-C-function">Â¶</a>26. invoking C function</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">lua_pushcfunction(l, l_sin);</span><br><span class="line">lua_setglobal(l, <span class="string">"mysin"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">l_sin</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> d = luaL_checknumber(L, <span class="number">1</span>);</span><br><span class="line">    lua_pushnumber(L, <span class="built_in">sin</span>(d));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">/* number of results */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cå‡½æ•°åº“</span></span><br><span class="line">LUAMOD_API <span class="keyword">int</span></span><br><span class="line">luaopen_rmq_core(lua_State *L) &#123;</span><br><span class="line">    luaL_Reg l[] = &#123;</span><br><span class="line">        &#123; <span class="string">"lwrite"</span>, lrmq_write &#125;,</span><br><span class="line">        &#123; <span class="string">"pack"</span>, lrmq_pack &#125;,</span><br><span class="line">        &#123; <span class="string">"unpack"</span>, lrmq_unpack &#125;,</span><br><span class="line">        &#123; <span class="string">"bind"</span>, lrmq_bind &#125;,</span><br><span class="line">        &#123; <span class="literal">NULL</span>, <span class="literal">NULL</span> &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    luaL_checkversion(L);</span><br><span class="line">    luaL_newlib(L,l);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="28-user-defined-types-in-C"><a class="header-anchor" href="#28-user-defined-types-in-C">Â¶</a>28. user-defined types in C</h2>
<p>æ¥å£è®¿é—®å½¢å¼:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a = array.new(<span class="number">1000</span>)</span><br><span class="line"><span class="built_in">print</span>(a) <span class="comment">--&gt; userdata: 0x8064d48</span></span><br><span class="line"><span class="built_in">print</span>(array.size(a)) <span class="comment">--&gt; 1000</span></span><br><span class="line"><span class="keyword">for</span> i=<span class="number">1</span>,<span class="number">1000</span> <span class="keyword">do</span></span><br><span class="line">array.set(a, i, <span class="number">1</span>/i)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">newarray</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = luaL_checkint(L, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">size_t</span> nbytes = <span class="keyword">sizeof</span>(NumArray) + (n - <span class="number">1</span>)*<span class="keyword">sizeof</span>(<span class="keyword">double</span>);</span><br><span class="line">    NumArray *a = (NumArray *)lua_newuserdata(L, nbytes);</span><br><span class="line">    luaL_getmetatable(L, <span class="string">"LuaBook.array"</span>);</span><br><span class="line">    lua_setmetatable(L, <span class="number">-2</span>);</span><br><span class="line">    a-&gt;<span class="built_in">size</span> = n;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">/* new userdatum is already on the stack */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> NumArray *<span class="title">checkarray</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *ud = luaL_checkudata(L, <span class="number">1</span>, <span class="string">"LuaBook.array"</span>);</span><br><span class="line">    luaL_argcheck(L, ud != <span class="literal">NULL</span>, <span class="number">1</span>, <span class="string">"`array' expected"</span>);</span><br><span class="line">    <span class="keyword">return</span> (NumArray *)ud;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getsize</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">    NumArray *a = checkarray(L);</span><br><span class="line">    lua_pushnumber(L, a-&gt;<span class="built_in">size</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">double</span> *<span class="title">getelem</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">    NumArray *a = checkarray(L);</span><br><span class="line">    <span class="keyword">int</span> index = luaL_checkint(L, <span class="number">2</span>);</span><br><span class="line">    luaL_argcheck(L, <span class="number">1</span> &lt;= index &amp;&amp; index &lt;= a-&gt;<span class="built_in">size</span>, <span class="number">2</span>,</span><br><span class="line">    <span class="string">"index out of range"</span>);</span><br><span class="line">    <span class="comment">/* return element address */</span></span><br><span class="line">    <span class="keyword">return</span> &amp;a-&gt;values[index - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">setarray</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> newvalue = luaL_checknumber(L, <span class="number">3</span>);</span><br><span class="line">    *getelem(L) = newvalue;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getarray</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">    lua_pushnumber(L, *getelem(L));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">luaL_reg</span> <span class="title">arraylib_f</span> [] = &#123;</span></span><br><span class="line">    &#123;<span class="string">"new"</span>, newarray&#125;,</span><br><span class="line">    &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">luaL_reg</span> <span class="title">arraylib_m</span> [] = &#123;</span></span><br><span class="line">    &#123;<span class="string">"__tostring"</span>, array2string&#125;,</span><br><span class="line">    &#123;<span class="string">"set"</span>, setarray&#125;,</span><br><span class="line">    &#123;<span class="string">"get"</span>, getarray&#125;,</span><br><span class="line">    &#123;<span class="string">"size"</span>, getsize&#125;,</span><br><span class="line">    &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">array2string</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">    NumArray *a = checkarray(L);</span><br><span class="line">    lua_pushfstring(L, <span class="string">"array(%d)"</span>, a-&gt;<span class="built_in">size</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">luaopen_array</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">    luaL_newmetatable(L, <span class="string">"LuaBook.array"</span>);</span><br><span class="line">    lua_pushstring(L, <span class="string">"__index"</span>);</span><br><span class="line">    lua_pushvalue(L, <span class="number">-2</span>); <span class="comment">/* pushes the metatable */</span></span><br><span class="line">    lua_settable(L, <span class="number">-3</span>); <span class="comment">/* metatable.__index = metatable */</span></span><br><span class="line">    </span><br><span class="line">    luaL_openlib(L, <span class="literal">NULL</span>, arraylib_m, <span class="number">0</span>);</span><br><span class="line">    luaL_openlib(L, <span class="string">"array"</span>, arraylib_f, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>note:<em>luaL_openlib çš„å¦ä¸€ä¸ªç‰¹å¾ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œå½“æˆ‘ä»¬ä¼ é€’ä¸€ä¸ª NULLä½œä¸ºåº“åæ—¶ï¼ŒluaL_openlib å¹¶æ²¡æœ‰åˆ›å»ºä»»ä½•åŒ…å«å‡½æ•°çš„è¡¨ï¼›ç›¸åï¼Œä»–è®¤ä¸ºå°è£…å‡½æ•°çš„è¡¨åœ¨æ ˆå†…ï¼Œä½äºä¸´æ—¶çš„ upvalues çš„ä¸‹é¢ã€‚</em></p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå°è£…å‡½æ•°çš„è¡¨æ˜¯ metatable æœ¬èº«ï¼Œä¹Ÿå°±æ˜¯ luaL_openlib æ”¾ç½®æ–¹æ³•çš„åœ°æ–¹ã€‚*</p>
<p>é¢å‘å¯¹è±¡è®¿é—®å½¢å¼:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = array.new(<span class="number">1000</span>)</span><br><span class="line"><span class="built_in">print</span>(a:size()) <span class="comment">--&gt; 1000</span></span><br><span class="line">a:set(<span class="number">10</span>, <span class="number">3.4</span>)</span><br><span class="line"><span class="built_in">print</span>(a:get(<span class="number">10</span>)) <span class="comment">--&gt; 3.4</span></span><br></pre></td></tr></table></figure>
<h2 id="29-resource-managerment-èµ„æºç®¡ç†"><a class="header-anchor" href="#29-resource-managerment-èµ„æºç®¡ç†">Â¶</a>29. resource managerment èµ„æºç®¡ç†</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="comment">/* forward declaration for the iterator function */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dir_iter</span> <span class="params">(lua_State *L)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">l_dir</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path = luaL_checkstring(L, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">/* create a userdatum to store a DIR address */</span></span><br><span class="line">    DIR **d = (DIR **)lua_newuserdata(L, <span class="keyword">sizeof</span>(DIR *));</span><br><span class="line">    <span class="comment">/* set its metatable */</span></span><br><span class="line">    luaL_getmetatable(L, <span class="string">"LuaBook.dir"</span>);</span><br><span class="line">    lua_setmetatable(L, <span class="number">-2</span>);</span><br><span class="line">    <span class="comment">/* try to open the given directory */</span></span><br><span class="line">    *d = opendir(path);</span><br><span class="line">    <span class="keyword">if</span> (*d == <span class="literal">NULL</span>) <span class="comment">/* error opening the directory? */</span></span><br><span class="line">    luaL_error(L, <span class="string">"cannot open %s: %s"</span>, path,</span><br><span class="line">    strerror(errno));</span><br><span class="line">    <span class="comment">/* creates and returns the iterator function</span></span><br><span class="line"><span class="comment">        (its sole upvalue, the directory userdatum,</span></span><br><span class="line"><span class="comment">        is already on the stack top */</span></span><br><span class="line">    lua_pushcclosure(L, dir_iter, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dir_iter</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">    DIR *d = *(DIR **)lua_touserdata(L, lua_upvalueindex(<span class="number">1</span>));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">entry</span>;</span></span><br><span class="line">    <span class="keyword">if</span> ((entry = readdir(d)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    lua_pushstring(L, entry-&gt;d_name);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* no more values to return */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dir_gc</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">    DIR *d = *(DIR **)lua_touserdata(L, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (d) closedir(d);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">luaopen_dir</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">    luaL_newmetatable(L, <span class="string">"LuaBook.dir"</span>);</span><br><span class="line">    <span class="comment">/* set its __gc field */</span></span><br><span class="line">    lua_pushstring(L, <span class="string">"__gc"</span>);</span><br><span class="line">    lua_pushcfunction(L, dir_gc);</span><br><span class="line">    lua_settable(L, <span class="number">-3</span>);</span><br><span class="line">    <span class="comment">/* register the `dir' function */</span></span><br><span class="line">    lua_pushcfunction(L, l_dir);</span><br><span class="line">    lua_setglobal(L, <span class="string">"dir"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Lua-5-4-ç‰ˆæœ¬æ›´æ–°"><a class="header-anchor" href="#Lua-5-4-ç‰ˆæœ¬æ›´æ–°">Â¶</a>Lua 5.4 ç‰ˆæœ¬æ›´æ–°</h2>
<p>Lua5.4å·²ç»è¿›å…¥rc(Release Candidate)çŠ¶æ€ï¼Œç›¸ä¿¡å¾ˆå¿«å°±ä¼šå‘å¸ƒæ­£å¼ç‰ˆã€‚è¿™ä¸ªç‰ˆæœ¬åœ¨è¯­è¨€å±‚é¢ä¸Šä¿®æ”¹çš„ä¸œè¥¿å¹¶ä¸å¤šï¼Œä½†æ˜¯é»˜è®¤çš„GCè¢«æ¢æˆäº†â€œåˆ†ä»£å¼GCâ€ï¼Œè¿™å¯¹äºé‚£äº›ç»å¸¸äº§ç”ŸçŸ­æœŸå¯¹è±¡çš„ç¨‹åºåº”è¯¥ä¼šæœ‰å¾ˆæ˜æ˜¾çš„æ€§èƒ½æå‡ã€‚GCå¸¦æ¥çš„è´Ÿæ‹…æ°¸è¿œæ˜¯è‡ªåŠ¨å†…å­˜ç®¡ç†è¯­è¨€çš„ä¸€å¤§ç—›ç‚¹ï¼Œå¦‚æœèƒ½åœ¨è¿™ä¸€ç‚¹ä¸Šå–å¾—çªç ´ï¼Œé‚£è‚¯å®šæ¯”æä¾›æ›´å¤šè¯­æ³•ç³–æ¥å¾—æœ‰ä»·å€¼ã€‚</p>
<p>æ­¤å¤–5.4å¯ä»¥æŒ‡å®šå±€éƒ¨å˜é‡çš„å±æ€§ï¼Œç”¨è¿™æ ·çš„è¯­æ³•ï¼š</p>
<p>local a <NAME> = 3<br>
NAMEå¯ä»¥æ˜¯constæˆ–closeï¼Œä¸ºconstæ—¶è¡¨ç¤ºconstå˜é‡(const variables)ï¼Œconstå˜é‡å¯ä»¥å¸®åŠ©ç¼–è¯‘å™¨ä½œä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼š</p>
<p>local a <const> = 4<br>
local b = a + 7<br>
print(b)<br>
ç¼–è¯‘å™¨ä¼šæŠŠaæ¶ˆé™¤æ‰ï¼Œç›´æ¥ç»™bèµ‹11ã€‚è¿™ç§ä¼˜åŒ–æ˜¯æœ‰é™çš„ï¼Œå¯¹äºåŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²ï¼Œèƒ½å¤Ÿæœ‰æ•ˆå‡å°‘å¯„å­˜å™¨çš„è®¿é—®ï¼Œä½†å¯¹äºtableè²Œä¼¼ç›Šå¤„ä¸å¤§ã€‚ä»£ç æ–‡ä»¶å¦‚æœéœ€è¦ä¸€äº›æ•°å€¼å¸¸é‡ï¼Œå¯ä»¥å†™æˆconstå˜é‡ï¼Œæ¯”å¦‚ï¼š</p>
<p>local MAX_LEN <const> = 20<br>
function check_name(name)<br>
return #name &lt;= MAX_LEN<br>
end<br>
åœ¨check_nameä¸­å°±æ²¡æœ‰upvalueçš„è®¿é—®ï¼Œè€Œæ˜¯ç›´æ¥è½¬æ¢æˆå’Œ20çš„æ¯”è¾ƒã€‚</p>
<p>closeå˜é‡(To-be-closed Variables)éœ€è¦å’Œcloseå…ƒæ–¹æ³•ç»“åˆä½¿ç”¨ï¼Œåœ¨å˜é‡è¶…å‡ºä½œç”¨åŸŸæ—¶ï¼Œä¼šè°ƒç”¨å˜é‡çš„closeå…ƒæ–¹æ³•ï¼Œè¿™å¬èµ·æ¥æ˜¯ä¸æ˜¯æœ‰ç‚¹åƒC++çš„RAIIç”¨æ³•ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>
<p>local function newlock()<br>
local lock = {<br>
acquire = function()<br>
print(â€œacquire lockâ€)<br>
end,<br>
release = function()<br>
print(â€œrelease lockâ€)<br>
end,<br>
}<br>
return lock<br>
end</p>
<p>local function lockguard(lock)<br>
local wrap = {<br>
lock = lock<br>
}<br>
lock.acquire()<br>
return setmetatable(wrap, {__close = function(t, err)<br>
t.lock.release()<br>
end})<br>
end</p>
<p>local lock = newlock()<br>
do<br>
for i = 1, 3 do<br>
local l <close> = lockguard(lock)<br>
print(i)<br>
error(â€œerrâ€)<br>
end<br>
end<br>
å®šä¹‰local l <close>åï¼Œæ— è®ºæ˜¯å¦æœ‰é”™è¯¯ï¼Œreleaseéƒ½èƒ½å¾—åˆ°è°ƒç”¨ï¼›ä»è¿™ä¸ªä¾‹å­ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œcloseå˜é‡ä¸€èˆ¬ç”¨äºéœ€è¦åŠæ—¶é‡Šæ”¾èµ„æºçš„æƒ…å†µï¼›å¦åˆ™Luaçš„GCå¯ä»¥åº”ä»˜å¤§å¤šæ•°æƒ…å†µã€‚</p>
<p>é™¤äº†ä¸Šé¢æåˆ°çš„ç‰¹æ€§ï¼Œè¿˜æœ‰ä¸€äº›æ–°çš„ä¿®æ”¹ç½—åˆ—å¦‚ä¸‹ï¼š</p>
<p>userdataç°åœ¨å¯ä»¥å…³è”å¤šä¸ªuserå€¼ï¼ŒCçš„APIä¹Ÿæœ‰ç›¸åº”çš„ä¿®æ”¹ï¼Œå¦‚æœæˆ‘ä»¬æ–°å»ºçš„userdataæ²¡æœ‰å…³è”å€¼ï¼Œåˆ™å°½é‡ä½¿ç”¨lua_newuserdatauvï¼Œè¿™æ ·æ›´é«˜æ•ˆï¼Œlua_newuserdataä»…ä»…ä¸ºäº†å…¼å®¹ï¼Œä¸”é»˜è®¤ä¼šå…³è”1ä¸ªå€¼ã€‚<br>
math.randomä½¿ç”¨äº†æ–°çš„ç®—æ³•ã€‚<br>
åç¨‹åº“æä¾›äº†æ–°çš„APIcoroutine.closeå’Œlua_resetthreadï¼Œcoroutine.closeåªèƒ½åœ¨æŒ‚èµ·æˆ–æ­»äº¡çŠ¶æ€ä¸‹è°ƒç”¨ï¼ŒæŒ‚èµ·çŠ¶æ€ä¸‹ä¼šä½¿ç”¨åç¨‹è¿›å…¥æ­»äº¡çŠ¶æ€ï¼Œå¹¶ä¸”å…³é—­æ‰€æœ‰çš„closeå˜é‡ã€‚</p>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2021/01/06/å¥èº«ç¬”è®°/" data-toggle="tooltip" data-placement="top" title="å¥èº«ç¬”è®°">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2019/03/04/Golang-æºç -CentOS-ç¼–è¯‘å®‰è£…-note/" data-toggle="tooltip" data-placement="top" title="Golang æºç ç¼–è¯‘å®‰è£… CentOS 7 note">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <br>

                <!-- require APlayer -->
                

                <!-- duoshuo Share start -->
                
                <!-- å¤šè¯´ Share end-->

                <!-- å¤šè¯´è¯„è®ºæ¡† start -->
                
                <!-- å¤šè¯´è¯„è®ºæ¡† end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->

                

            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-Begin"><span class="toc-nav-text">1. Begin</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#1-1-chunk"><span class="toc-nav-text">1.1 chunk</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#1-4-lua-command-line"><span class="toc-nav-text">1.4 lua command line</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#2-lua-basic-type"><span class="toc-nav-text">2. lua basic type</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-4-string"><span class="toc-nav-text">2.4 string</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-5-Function"><span class="toc-nav-text">2.5 Function</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-6-Userdata-and-Threads"><span class="toc-nav-text">2.6 Userdata and Threads</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#3-expression-è¡¨è¾¾å¼"><span class="toc-nav-text">3. expression è¡¨è¾¾å¼</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#3-2-Relational-operators"><span class="toc-nav-text">3.2 Relational operators</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#3-3-logical-operator-é€»è¾‘è¿ç®—ç¬¦"><span class="toc-nav-text">3.3 logical operator é€»è¾‘è¿ç®—ç¬¦</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#3-5-operator-priority-ä¼˜å…ˆçº§"><span class="toc-nav-text">3.5 operator priority ä¼˜å…ˆçº§</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#3-6-table-constructor-è¡¨çš„æ„é€ "><span class="toc-nav-text">3.6 table constructor è¡¨çš„æ„é€ </span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#4-basic-syntax-åŸºæœ¬è¯­æ³•"><span class="toc-nav-text">4. basic syntax åŸºæœ¬è¯­æ³•</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#4-2-local-variable-code-block-å±€éƒ¨å˜é‡-ä»£ç å—"><span class="toc-nav-text">4.2  local variable &amp; code block å±€éƒ¨å˜é‡ ä»£ç å—</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#4-3-break-return"><span class="toc-nav-text">4.3 break return</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#5-function"><span class="toc-nav-text">5. function</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#5-1-multi-result-return"><span class="toc-nav-text">5.1 multi result return</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#5-2-variable-parameter-å¯å˜å‚æ•°"><span class="toc-nav-text">5.2 variable parameter å¯å˜å‚æ•°</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#5-3-named-parameter-å‘½åå‚æ•°"><span class="toc-nav-text">5.3 named parameter å‘½åå‚æ•°</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#6-function-plus-å†è®ºå‡½æ•°"><span class="toc-nav-text">6. function plus å†è®ºå‡½æ•°</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#6-3-proper-tail-calls-å°¾è°ƒç”¨"><span class="toc-nav-text">6.3 proper tail calls å°¾è°ƒç”¨</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#7-iterator-genericity-for-è¿­ä»£å™¨-æ³›å‹for"><span class="toc-nav-text">7. iterator &amp; genericity for è¿­ä»£å™¨ æ³›å‹for</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#7-2-genericity-for-æ³›å‹-for-çš„è¯­ä¹‰"><span class="toc-nav-text">7.2 genericity for æ³›å‹ for çš„è¯­ä¹‰</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#7-3-iterator-without-status-æ— çŠ¶æ€çš„è¿­ä»£å™¨"><span class="toc-nav-text">7.3 iterator without status æ— çŠ¶æ€çš„è¿­ä»£å™¨</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#7-3-multi-status-iterator-å¤šçŠ¶æ€çš„è¿­ä»£å™¨"><span class="toc-nav-text">7.3 multi status iterator å¤šçŠ¶æ€çš„è¿­ä»£å™¨</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#8-compile-run-debug-ç¼–è¯‘-è¿è¡Œ-è°ƒè¯•"><span class="toc-nav-text">8. compile run debug ç¼–è¯‘ è¿è¡Œ è°ƒè¯•</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#8-1-require"><span class="toc-nav-text">8.1 require</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#8-2-C-Packages"><span class="toc-nav-text">8.2 C Packages</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#8-3-error-é”™è¯¯"><span class="toc-nav-text">8.3 error é”™è¯¯</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#8-4-exception-pcall"><span class="toc-nav-text">8.4 exception &amp; pcall</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#8-5-exception-msg-xpcall"><span class="toc-nav-text">8.5 exception msg &amp; xpcall</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#9-0-coroutine"><span class="toc-nav-text">9.0 coroutine</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#9-2-filter-è¿‡æ»¤å™¨"><span class="toc-nav-text">9.2 filter è¿‡æ»¤å™¨</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#9-3-iterator-è¿­ä»£å™¨"><span class="toc-nav-text">9.3 iterator è¿­ä»£å™¨</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#9-4-pre-emptive-multi-thread-éæŠ¢å å¼å¤šçº¿ç¨‹"><span class="toc-nav-text">9.4 pre-emptive multi thread éæŠ¢å å¼å¤šçº¿ç¨‹</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#11-datastruct"><span class="toc-nav-text">11. datastruct</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#11-1-array-æ•°ç»„"><span class="toc-nav-text">11.1 array æ•°ç»„</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#11-2-matrix-multidimensional-array-é˜µ-å¤šç»´æ•°ç»„"><span class="toc-nav-text">11.2 matrix &amp; multidimensional array é˜µ å¤šç»´æ•°ç»„</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#11-3-linked-list-sé“¾è¡¨"><span class="toc-nav-text">11.3 linked list sé“¾è¡¨</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#11-4-queen-dique-sé˜Ÿåˆ—-åŒç«¯é˜Ÿåˆ—"><span class="toc-nav-text">11.4 queen &amp; dique sé˜Ÿåˆ— åŒç«¯é˜Ÿåˆ—</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#11-5-set-package-é›†åˆ-åŒ…"><span class="toc-nav-text">11.5 set &amp; package é›†åˆ åŒ…</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#11-6-string-buffer-å­—ç¬¦ä¸²ç¼“å†²"><span class="toc-nav-text">11.6 string buffer å­—ç¬¦ä¸²ç¼“å†²</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#12-data-file-storage-Persistence-æ•°æ®æ–‡ä»¶ä¸æŒä¹…åŒ–"><span class="toc-nav-text">12. data file storage &amp; Persistence æ•°æ®æ–‡ä»¶ä¸æŒä¹…åŒ–</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#13-metatables-metamethods"><span class="toc-nav-text">13. metatables metamethods</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#13-1-arithmetic-operation-metamethods-ç®—æœ¯è¿ç®—çš„-matamethods"><span class="toc-nav-text">13.1  arithmetic operation metamethods ç®—æœ¯è¿ç®—çš„ matamethods</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#13-2-relational-operation-metamethods-å…³ç³»è¿ç®—çš„-metamethods"><span class="toc-nav-text">13.2 relational operation metamethods å…³ç³»è¿ç®—çš„ metamethods</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#13-3-others-metamethods"><span class="toc-nav-text">13.3 others metamethods</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#13-4-table-relative-metamethods-è¡¨ç›¸å…³-metamethods"><span class="toc-nav-text">13.4 table relative metamethods è¡¨ç›¸å…³ metamethods</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#13-4-1-The-index-Metamethod"><span class="toc-nav-text">13.4.1 The __index Metamethod</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#13-4-2-The-newindex-Metamethod"><span class="toc-nav-text">13.4.2 The __newindex Metamethod</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#13-4-3-table-default-value-æœ‰é»˜è®¤å€¼çš„è¡¨"><span class="toc-nav-text">13.4.3 table default value æœ‰é»˜è®¤å€¼çš„è¡¨</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#13-4-4-table-monitor-ç›‘æ§è¡¨"><span class="toc-nav-text">13.4.4 table monitor ç›‘æ§è¡¨</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#13-4-5-readonly-table-åªè¯»è¡¨"><span class="toc-nav-text">13.4.5 readonly table åªè¯»è¡¨</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#14-environment-ç¯å¢ƒ"><span class="toc-nav-text">14. environment ç¯å¢ƒ</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#14-1-dynamic-access-global-value-ä½¿ç”¨åŠ¨æ€åå­—è®¿é—®å…¨å±€å˜é‡"><span class="toc-nav-text">14.1 dynamic access global value ä½¿ç”¨åŠ¨æ€åå­—è®¿é—®å…¨å±€å˜é‡</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#14-2-delcare-global-value-å£°æ˜å…¨å±€å˜é‡"><span class="toc-nav-text">14.2 delcare global value å£°æ˜å…¨å±€å˜é‡</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#14-3-un-global-environment-éå…¨å±€çš„ç¯å¢ƒ"><span class="toc-nav-text">14.3 un-global environment éå…¨å±€çš„ç¯å¢ƒ</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#15-package"><span class="toc-nav-text">15 package</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#15-3-package-file"><span class="toc-nav-text">15.3 package &amp; file</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#16-object-oriented-programming-é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡"><span class="toc-nav-text">16 object-oriented programming é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#16-3-multiple-inheritance-å¤šé‡ç»§æ‰¿"><span class="toc-nav-text">16.3 multiple inheritance å¤šé‡ç»§æ‰¿</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#16-4-private-ç§æœ‰æ€§"><span class="toc-nav-text">16.4 private ç§æœ‰æ€§</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#16-5-Single-Method-çš„å¯¹è±¡å®ç°æ–¹æ³•"><span class="toc-nav-text">16.5 Single-Method çš„å¯¹è±¡å®ç°æ–¹æ³•</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#17-weak-table"><span class="toc-nav-text">17 weak table</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#17-1-è®°å¿†å‡½æ•°"><span class="toc-nav-text">17.1 è®°å¿†å‡½æ•°</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#18-æ•°å­¦åº“"><span class="toc-nav-text">18. æ•°å­¦åº“</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#19-table-lib"><span class="toc-nav-text">19. table lib</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#20-string-lib"><span class="toc-nav-text">20 string lib</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#20-1-pattern-matching-æ¨¡å¼åŒ¹é…"><span class="toc-nav-text">20.1 pattern matching æ¨¡å¼åŒ¹é…</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#20-2-pattern-æ¨¡å¼"><span class="toc-nav-text">20.2 pattern æ¨¡å¼</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#20-3-matchings-æ•è·"><span class="toc-nav-text">20.3 matchings æ•è·</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#21-IO-lib"><span class="toc-nav-text">21. IO lib</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#21-1-simple-I-O-mode"><span class="toc-nav-text">21.1 simple I&#x2F;O mode</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#21-2-complete-I-O-mode"><span class="toc-nav-text">21.2 complete I&#x2F;O mode</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#22-system-lib-æ“ä½œç³»ç»Ÿåº“"><span class="toc-nav-text">22 system lib æ“ä½œç³»ç»Ÿåº“</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#23-debug-lib"><span class="toc-nav-text">23. debug lib</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#23-2-hooks"><span class="toc-nav-text">23.2 hooks</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#24-C-API-Overview"><span class="toc-nav-text">24. C API Overview</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#24-3-C-API-exception-handler"><span class="toc-nav-text">24.3 C API exception handler</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#25-invoking-lua-function"><span class="toc-nav-text">25. invoking lua function</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#26-invoking-C-function"><span class="toc-nav-text">26. invoking C function</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#28-user-defined-types-in-C"><span class="toc-nav-text">28. user-defined types in C</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#29-resource-managerment-èµ„æºç®¡ç†"><span class="toc-nav-text">29. resource managerment èµ„æºç®¡ç†</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Lua-5-4-ç‰ˆæœ¬æ›´æ–°"><span class="toc-nav-text">Lua 5.4 ç‰ˆæœ¬æ›´æ–°</span></a></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#lua 5.0" title="lua 5.0">lua 5.0</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://www.roading.org" target="_blank">Adoo&#39;s blog</a></li>
                    
                        <li><a href="https://blog.csdn.net/chosen0ne/" target="_blank">å¨„æŒ¯æ—ä¸“æ </a></li>
                    
                        <li><a href="https://www.cnblogs.com/miloyip/" target="_blank">Miloçš„æ¸¸æˆå¼€å‘</a></li>
                    
                        <li><a href="https://www.cnblogs.com/zhaoyl/" target="_blank">Just Love U</a></li>
                    
                        <li><a href="https://www.cnblogs.com/sniperHW/" target="_blank">sniperHW</a></li>
                    
                        <li><a href="http://www.cppblog.com/converse/" target="_blank">é‚£è°çš„æŠ€æœ¯åšå®¢</a></li>
                    
                        <li><a href="http://www.cppblog.com/Solstice/" target="_blank">é™ˆç¡•çš„Blog</a></li>
                    
                        <li><a href="https://www.cnblogs.com/learnhow/p/9420404.html#4035973" target="_blank">30åˆ†é’Ÿå¸¦ä½ äº†è§£Docker</a></li>
                    
                        <li><a href="https://leftnoteasy.cnblogs.com/" target="_blank">LeftNotEasy - Wangda Tan</a></li>
                    
                        <li><a href="https://blog.codingnow.com/" target="_blank">äº‘é£çš„ BLOG</a></li>
                    
                        <li><a href="https://iyuan.iteye.com/blog/search?page=4&amp;query=ZeroMQ%E5%88%9D%E4%BD%93%E9%AA%8C" target="_blank">zero MQ</a></li>
                    
                        <li><a href="https://levblanc.github.io/" target="_blank">levblanc blog</a></li>
                    
                        <li><a href="https://blog.zhangruipeng.me/hexo-theme-icarus/" target="_blank">zhangruipeng blog</a></li>
                    
                        <li><a href="https://v-vincen.life/" target="_blank">v-vincen blog</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>








<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'âˆ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>


<script>
    /**/
    function setClipboardText(event){
        event.preventDefault();//é˜»æ­¢å…ƒç´ å‘ç”Ÿé»˜è®¤çš„è¡Œä¸ºï¼ˆä¾‹å¦‚ï¼Œå½“ç‚¹å‡»æäº¤æŒ‰é’®æ—¶é˜»æ­¢å¯¹è¡¨å•çš„æäº¤ï¼‰ã€‚
        var node = document.createElement('div');
        //å¯¹documentfragmentä¸ç†Ÿï¼Œä¸çŸ¥é“æ€ä¹ˆè·å–é‡Œé¢çš„å†…å®¹ï¼Œç”¨äº†ä¸€ä¸ªæ¯”è¾ƒç¬¨çš„æ–¹å¼
        node.appendChild(window.getSelection().getRangeAt(0).cloneContents());
        //getRangeAt(0)è¿”å›å¯¹åŸºäºé›¶çš„æ•°å­—ç´¢å¼•ä¸ä¼ é€’å‚æ•°åŒ¹é…çš„é€‰æ‹©å¯¹è±¡ä¸­çš„èŒƒå›´çš„å¼•ç”¨ã€‚å¯¹äºè¿ç»­é€‰æ‹©ï¼Œå‚æ•°åº”ä¸ºé›¶ã€‚
        var htmlData = '<div>'
            + node.innerHTML
            + '<br /><br />è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚<br />'
            + 'å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚<br />'
            + 'ä½œè€…ï¼šZirpon Cheung <br />é“¾æ¥ï¼š'
            + location.href
            + '<br />æ¥æºï¼šdianfanbao.ltd<br /><br />'
            + '</div>';
        var textData = window.getSelection().getRangeAt(0)
            + '\n\nè‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚\n'
            + 'å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚\n'
            + 'ä½œè€…ï¼šZirpon Cheung\n'
            + 'é“¾æ¥ï¼š'
            + location.href
            + 'æ¥æºï¼šdianfanbao.ltd\n\n';
        if(event.clipboardData){
            event.clipboardData.setData("text/html", htmlData);
            //setData(å‰ªè´´æ¿æ ¼å¼, æ•°æ®) ç»™å‰ªè´´æ¿èµ‹äºˆæŒ‡å®šæ ¼å¼çš„æ•°æ®ã€‚è¿”å› true è¡¨ç¤ºæ“ä½œæˆåŠŸã€‚
            event.clipboardData.setData("text/plain",textData);
        }
        else if(window.clipboardData){ //window.clipboardDataçš„ä½œç”¨æ˜¯åœ¨é¡µé¢ä¸Šå°†éœ€è¦çš„ä¸œè¥¿å¤åˆ¶åˆ°å‰ªè´´æ¿ä¸Šï¼Œæä¾›äº†å¯¹äºé¢„å®šä¹‰çš„å‰ªè´´æ¿æ ¼å¼çš„è®¿é—®ï¼Œä»¥ä¾¿åœ¨ç¼–è¾‘æ“ä½œä¸­ä½¿ç”¨ã€‚
            return window.clipboardData.setData("text", textData);
        }
    };
 
    document.addEventListener('copy',function(e){
        setClipboardText(e);
    });
</script>



<!-- chrome Firefox ä¸­æ–‡é”šç‚¹å®šä½å¤±æ•ˆ-->
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
<!-- smooth scroll behavior polyfill  -->
<script type="text/javascript" src="https://zirpon.github.io/js/smoothscroll.js"></script>
<script>
        $('#toc').on('click','a',function(a){
            // var isChrome = window.navigator.userAgent.indexOf("Chrome") !== -1;
            // console.log(window.navigator.userAgent,isChrome)
                // if(isChrome) {
                    // console.log(a.currentTarget.outerHTML);
                    // console.log($(a.currentTarget).attr("href"));
                    //è·³è½¬åˆ°æŒ‡å®šé”šç‚¹
                    // document.getElementById(a.target.innerText.toLowerCase()).scrollIntoView(true);
                    document.getElementById($(a.currentTarget).attr("href").replace("#","")).scrollIntoView({behavior: 'smooth' });
                // }
        })  
</script>



<!--
<!DOCTYPE html>
<html lang="en">
<body class="">
<div>
<img src="https://champon.gitee.io/blog/img/header_img/RomanTheatre_ZH-CN9417897135_1920x1080.jpg" 
    width='64px' height='48px'>
</div>
</body>
</html>
-->

	<!-- Footer (contains ThemeColorã€viewer) -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/monkeyzhang">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/Zirpon">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Zirpon Cheung 2024 
                    <br>
                    Theme by <a href="http://beantech.org/" target="_blank" rel="noopener">BeanTech</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="https://champon.gitee.io/blog" target="_blank" rel="noopener">Zirpon</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=Zirpon&repo=hexo-theme-zirpon&type=star&count=true" >
                    </iframe>

                    <br>
                </p>
                <br>
                <!-- cnzz Tongji -->
                
            </div>
        </div>
    </div>
</footer>

<!-- cnzz Tongji -->


<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/hux-blog.min.js"></script>


<!-- totop(rocket) -->
<script type="text/javascript" async="true" src="https://zirpon.github.io/js/totop.js?v=1.0.0"></script>

<!-- Busuanzi JavaScript -->
<script type="text/javascript" async="true" src="/js/busuanzi.pure.mini.js"></script>


    <!-- ThemeColor start -->
    <script type="text/javascript" src="https://zirpon.github.io/js/themecolor.js"></script>
    <!-- ThemeColor end -->



    <!-- viewer start -->
    <!-- viewer start (Picture preview) -->
    <script type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
    <!-- viewer end -->


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }

    // fastClick.js
    async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav)
        FastClick.attach($nav);
        }
    )
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->





    <!-- Search -->
	
        <div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="Search..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  <script src="/js/ziploader.js"></script>
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;

            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('-1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


    

    <a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="https://zirpon.github.io/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="https://zirpon.github.io/js/toc.js?v=1.0.0" async=""></script>
    <!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
